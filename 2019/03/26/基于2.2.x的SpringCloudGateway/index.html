<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="基于2.2.x的SpringCloudGateway"><meta name="keywords" content="routing,gateway"><meta name="author" content="YoungDream,undefined"><meta name="copyright" content="YoungDream"><title>基于2.2.x的SpringCloudGateway【YD Blog】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!--link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!--link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!--script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"0BGAOITLJQ","apiKey":"2c864a8b4720c83c2ddfc7e53d4c1711","indexName":"article_NAME","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
}</script></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Cloud-Gateway"><span class="toc-number">1.</span> <span class="toc-text">Spring Cloud Gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#如何包含Spring-Cloud-Gateway"><span class="toc-number">1.1.</span> <span class="toc-text">如何包含Spring Cloud Gateway</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#词汇表"><span class="toc-number">1.2.</span> <span class="toc-text">词汇表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行原理"><span class="toc-number">1.3.</span> <span class="toc-text">运行原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Route-Predicate-Factories"><span class="toc-number">1.4.</span> <span class="toc-text">Route Predicate Factories</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#After"><span class="toc-number">1.4.1.</span> <span class="toc-text">After</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Before"><span class="toc-number">1.4.2.</span> <span class="toc-text">Before</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Between"><span class="toc-number">1.4.3.</span> <span class="toc-text">Between</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie"><span class="toc-number">1.4.4.</span> <span class="toc-text">Cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Header"><span class="toc-number">1.4.5.</span> <span class="toc-text">Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Host"><span class="toc-number">1.4.6.</span> <span class="toc-text">Host</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method"><span class="toc-number">1.4.7.</span> <span class="toc-text">Method</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Path"><span class="toc-number">1.4.8.</span> <span class="toc-text">Path</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Query"><span class="toc-number">1.4.9.</span> <span class="toc-text">Query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RemoteAddr"><span class="toc-number">1.4.10.</span> <span class="toc-text">RemoteAddr</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#修改远程地址的解析方式"><span class="toc-number">1.4.10.1.</span> <span class="toc-text">修改远程地址的解析方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gateway-Filter-Factory"><span class="toc-number">1.5.</span> <span class="toc-text">Gateway Filter Factory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AddRequestHeader"><span class="toc-number">1.5.1.</span> <span class="toc-text">AddRequestHeader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AddRequestParameter"><span class="toc-number">1.5.2.</span> <span class="toc-text">AddRequestParameter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AddResponseHeader"><span class="toc-number">1.5.3.</span> <span class="toc-text">AddResponseHeader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DedupeResponseHeader"><span class="toc-number">1.5.4.</span> <span class="toc-text">DedupeResponseHeader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hystrix"><span class="toc-number">1.5.5.</span> <span class="toc-text">Hystrix</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FallbackHeaders"><span class="toc-number">1.5.6.</span> <span class="toc-text">FallbackHeaders</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PrefixPath"><span class="toc-number">1.5.7.</span> <span class="toc-text">PrefixPath</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PreserveHostHeader"><span class="toc-number">1.5.8.</span> <span class="toc-text">PreserveHostHeader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RequestRateLimiter"><span class="toc-number">1.5.9.</span> <span class="toc-text">RequestRateLimiter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-RateLimiter"><span class="toc-number">1.5.10.</span> <span class="toc-text">Redis RateLimiter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RedirectTo"><span class="toc-number">1.5.11.</span> <span class="toc-text">RedirectTo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RemoveHopByHopHeadersFilter"><span class="toc-number">1.5.12.</span> <span class="toc-text">RemoveHopByHopHeadersFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RemoveRequestHeader"><span class="toc-number">1.5.13.</span> <span class="toc-text">RemoveRequestHeader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RemoveResponseHeader"><span class="toc-number">1.5.14.</span> <span class="toc-text">RemoveResponseHeader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RewritePath"><span class="toc-number">1.5.15.</span> <span class="toc-text">RewritePath</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RewriteResponseHeader"><span class="toc-number">1.5.16.</span> <span class="toc-text">RewriteResponseHeader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SaveSession"><span class="toc-number">1.5.17.</span> <span class="toc-text">SaveSession</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SecureHeaders"><span class="toc-number">1.5.18.</span> <span class="toc-text">SecureHeaders</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SetPath"><span class="toc-number">1.5.19.</span> <span class="toc-text">SetPath</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SetResponseHeader"><span class="toc-number">1.5.20.</span> <span class="toc-text">SetResponseHeader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SetStatus"><span class="toc-number">1.5.21.</span> <span class="toc-text">SetStatus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StripPrefix"><span class="toc-number">1.5.22.</span> <span class="toc-text">StripPrefix</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Retry"><span class="toc-number">1.5.23.</span> <span class="toc-text">Retry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RequestSize"><span class="toc-number">1.5.24.</span> <span class="toc-text">RequestSize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Modify-Request-Body"><span class="toc-number">1.5.25.</span> <span class="toc-text">Modify Request Body</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Modify-Response-Body"><span class="toc-number">1.5.26.</span> <span class="toc-text">Modify Response Body</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Default-Filters"><span class="toc-number">1.5.27.</span> <span class="toc-text">Default Filters</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Global-Filters"><span class="toc-number">1.6.</span> <span class="toc-text">Global Filters</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#组合全局过滤器和GatewayFilter排序"><span class="toc-number">1.6.1.</span> <span class="toc-text">组合全局过滤器和GatewayFilter排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Forward-Routing-Filter"><span class="toc-number">1.6.2.</span> <span class="toc-text">Forward Routing Filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LoadBalancerClient过滤器"><span class="toc-number">1.6.3.</span> <span class="toc-text">LoadBalancerClient过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Netty-Routing-Filter"><span class="toc-number">1.6.4.</span> <span class="toc-text">Netty Routing Filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Netty-Write-Response-Filter"><span class="toc-number">1.6.5.</span> <span class="toc-text">Netty Write Response Filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RouteToRequestUrl过滤器"><span class="toc-number">1.6.6.</span> <span class="toc-text">RouteToRequestUrl过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Websocket路由过滤器"><span class="toc-number">1.6.7.</span> <span class="toc-text">Websocket路由过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gateway-Metrics-Filter"><span class="toc-number">1.6.8.</span> <span class="toc-text">Gateway Metrics Filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Marking-An-Exchange-As-Routed"><span class="toc-number">1.6.9.</span> <span class="toc-text">Marking An Exchange As Routed</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TLS-SSL"><span class="toc-number">1.7.</span> <span class="toc-text">TLS / SSL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TLS-Handshake"><span class="toc-number">1.7.1.</span> <span class="toc-text">TLS Handshake</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configuration"><span class="toc-number">1.8.</span> <span class="toc-text">Configuration</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#流畅的Java-Routes-API"><span class="toc-number">1.8.1.</span> <span class="toc-text">流畅的Java Routes API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DiscoveryClient路由定义定位器"><span class="toc-number">1.8.2.</span> <span class="toc-text">DiscoveryClient路由定义定位器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置DiscoveryClient路由的谓词和过滤器"><span class="toc-number">1.8.3.</span> <span class="toc-text">配置DiscoveryClient路由的谓词和过滤器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reactor-Netty访问日志"><span class="toc-number">1.9.</span> <span class="toc-text">Reactor Netty访问日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CORS配置"><span class="toc-number">1.10.</span> <span class="toc-text">CORS配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Actuator-API"><span class="toc-number">1.11.</span> <span class="toc-text">Actuator API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#检索路由过滤器"><span class="toc-number">1.11.1.</span> <span class="toc-text">检索路由过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#全球过滤器"><span class="toc-number">1.11.1.1.</span> <span class="toc-text">全球过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Route过滤器"><span class="toc-number">1.11.1.2.</span> <span class="toc-text">Route过滤器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#刷新路由缓存"><span class="toc-number">1.11.2.</span> <span class="toc-text">刷新路由缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检索网关中定义的路由"><span class="toc-number">1.11.3.</span> <span class="toc-text">检索网关中定义的路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检索有关特定路线的信息"><span class="toc-number">1.11.4.</span> <span class="toc-text">检索有关特定路线的信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建和删除特定路线"><span class="toc-number">1.11.5.</span> <span class="toc-text">创建和删除特定路线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#回顾：所有端点的列表"><span class="toc-number">1.11.6.</span> <span class="toc-text">回顾：所有端点的列表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开发者指南"><span class="toc-number">1.12.</span> <span class="toc-text">开发者指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#编写自定义路由断言工厂"><span class="toc-number">1.12.1.</span> <span class="toc-text">编写自定义路由断言工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写自定义GatewayFilter工厂"><span class="toc-number">1.12.2.</span> <span class="toc-text">编写自定义GatewayFilter工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写定制全局过滤器"><span class="toc-number">1.12.3.</span> <span class="toc-text">编写定制全局过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写自定义路由定位器和写入器"><span class="toc-number">1.12.4.</span> <span class="toc-text">编写自定义路由定位器和写入器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Spring-MVC或Webflux构建简单网关"><span class="toc-number">1.13.</span> <span class="toc-text">使用Spring MVC或Webflux构建简单网关</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">YoungDream</div><div class="author-info-description">正忙着优秀~~~</div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/qq994300880" target="_blank">GitHub<i class="icon-dot bg-color5"></i></a><a class="links-button button-hover" href="http://wpa.qq.com/msgrd?v=3&amp;uin=994300880&amp;site=qq&amp;menu=yes" target="_blank">QQ<i class="icon-dot bg-color6"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">92</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">70</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">15</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">YD Blog</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">基于2.2.x的SpringCloudGateway</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2019-03-26 | 更新于 2019-03-30</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/springcloud/">springcloud</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/routing/">routing</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/gateway/">gateway</a></div></div></div><div class="main-content"><h1 id="Spring-Cloud-Gateway"><a href="#Spring-Cloud-Gateway" class="headerlink" title="Spring Cloud Gateway"></a>Spring Cloud Gateway</h1><p><strong>2.2.0.BUILD-快照</strong></p>
<p>该项目提供了一个建立在Spring Ecosystem之上的API网关，包括：Spring 5，Spring Boot 2和Project Reactor。Spring Cloud Gateway旨在提供一种简单而有效的方式来路由到API，并为他们提供横切关注点，例如：安全性，监控/指标和弹性。</p>
<a id="more"></a>
<h2 id="如何包含Spring-Cloud-Gateway"><a href="#如何包含Spring-Cloud-Gateway" class="headerlink" title="如何包含Spring Cloud Gateway"></a>如何包含Spring Cloud Gateway</h2><p>要在项目中包含Spring Cloud Gateway，请使用具有组<code>org.springframework.cloud</code> 和工件ID 的启动器<code>spring-cloud-starter-gateway</code>。有关 使用当前Spring Cloud Release Train设置构建系统的详细信息，请参阅<a href="https://projects.spring.io/spring-cloud/" target="_blank" rel="noopener">Spring Cloud Project页面</a>。</p>
<p>如果包含启动器，但由于某种原因，您不希望启用网关，请进行设置<code>spring.cloud.gateway.enabled=false</code>。</p>
<blockquote>
<p>Spring Cloud Gateway基于<a href="https://spring.io/projects/spring-boot#learn" target="_blank" rel="noopener">Spring Boot 2.0</a>， <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" target="_blank" rel="noopener">Spring WebFlux</a>和<a href="https://projectreactor.io/docs" target="_blank" rel="noopener">Project Reactor </a><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" target="_blank" rel="noopener">构建</a>。因此，许多熟悉的同步库（例如Spring Data和Spring Security）和模式在使用Spring Cloud Gateway时可能不适用。如果您不熟悉这些项目，我们建议您在使用Spring Cloud Gateway之前先阅读他们的文档以熟悉一些新概念。</p>
</blockquote>
<blockquote>
<p>Spring Cloud Gateway需要Spring Boot和Spring Webflux提供的Netty运行时。它不能在传统的Servlet容器中工作或构建为WAR。</p>
</blockquote>
<h2 id="词汇表"><a href="#词汇表" class="headerlink" title="词汇表"></a>词汇表</h2><ul>
<li><strong>Route</strong>: 路由网关的基本构建块。它由ID，目标URI，谓词集合和过滤器集合定义。如果聚合谓词为真，则匹配路由。</li>
<li><strong>Predicate</strong>: 这是一个<a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html" target="_blank" rel="noopener">Java 8函数谓词</a>。输入类型是<a href="https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/server/ServerWebExchange.html" target="_blank" rel="noopener">Spring Framework<code>ServerWebExchange</code></a>。这允许开发人员匹配来自HTTP请求的任何内容，例如标头或参数。</li>
<li><strong>Filter</strong>: 这是使用特定工厂构建的<a href="https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/server/GatewayFilter.html" target="_blank" rel="noopener">Spring Framework<code>GatewayFilter</code></a>实例。这里，可以在发送下游请求之前或之后修改请求和响应。</li>
</ul>
<h2 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h2><p><img src="/images/基于2.2.x的SpringCloudGateway-图1.png" alt="运行原理"></p>
<p>客户端向Spring Cloud Gateway发出请求。如果网关处理程序映射确定请求与路由匹配，则将其发送到网关Web处理程序。此处理程序运行通过特定于请求的过滤器链发送请求。滤波器被虚线划分的原因是滤波器可以在发送代理请求之前或之后执行逻辑。执行所有“预”过滤器逻辑，然后进行代理请求。在发出代理请求之后，执行“post”过滤器逻辑。</p>
<blockquote>
<p>在没有端口的路由中定义的URI将分别为HTTP和HTTPS URI获取默认端口设置为80和443。</p>
</blockquote>
<h2 id="Route-Predicate-Factories"><a href="#Route-Predicate-Factories" class="headerlink" title="Route Predicate Factories"></a>Route Predicate Factories</h2><p>Spring Cloud Gateway将路由作为Spring WebFlux <code>HandlerMapping</code>基础结构的一部分进行匹配。Spring Cloud Gateway包含许多内置的Route Predicate工厂。所有这些谓词都匹配HTTP请求的不同属性。多路线谓词工厂可以组合并通过逻辑组合<code>and</code>。</p>
<h3 id="After"><a href="#After" class="headerlink" title="After"></a>After</h3><p>After Route谓词工厂采用一个参数，一个日期时间。此谓词匹配在当前日期时间之后发生的请求。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">after_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">After=2017-01-20T17:42:47.789-07:00[America/Denver]</span></span><br></pre></td></tr></table></figure>
<p>此路由在2017年1月20日17:42 Mountain Time（Denver）之后的所有请求相匹配。</p>
<h3 id="Before"><a href="#Before" class="headerlink" title="Before"></a>Before</h3><p>Before Route Predicate Factory采用一个参数，一个日期时间。此谓词匹配在当前日期时间之前发生的请求。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">before_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Before=2017-01-20T17:42:47.789-07:00[America/Denver]</span></span><br></pre></td></tr></table></figure>
<p>此路由在2017年1月20日17:42 Mountain Time（Denver）之前的任何请求相匹配。</p>
<h3 id="Between"><a href="#Between" class="headerlink" title="Between"></a>Between</h3><p>Between Route Predicate Factory有两个参数，datetime1和datetime2。此谓词匹配datetime1之后和datetime2之前发生的请求。datetime2参数必须在datetime1之后。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">between_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Between=2017-01-20T17:42:47.789-07:00[America/Denver],</span> <span class="number">2017</span><span class="bullet">-01</span><span class="bullet">-21</span><span class="attr">T17:42:47.789-07:00[America/Denver]</span></span><br></pre></td></tr></table></figure>
<p>此路路由在2017年1月20日17:42山地时间（丹佛）之后和2017年1月21日17:42山区时间（丹佛）之前的任何请求相匹配。这对维护窗口很有用。</p>
<h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><p>Cookie Route Predicate Factory有两个参数，cookie名称和正则表达式。此谓词匹配具有给定名称且值与正则表达式匹配的cookie。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">cookie_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Cookie=chocolate,</span> <span class="string">ch.p</span></span><br></pre></td></tr></table></figure>
<p>此路由匹配请求具有名为<code>chocolate</code>who的值与<code>ch.p</code>正则表达式匹配的cookie 。</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Header Route谓词工厂采用两个参数，标题名称和正则表达式。此谓词与具有给定名称且值与正则表达式匹配的标头匹配。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">header_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></span><br></pre></td></tr></table></figure>
<p>如果请求具有名称，<code>X-Request-Id</code>其值与<code>\d+</code>正则表达式匹配（具有一个或多个数字的值），则此路由匹配。</p>
<h3 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h3><p>Host Route Predicate Factory采用一个参数：主机名模式列表。该模式是一个Ant样式模式，<code>.</code>作为分隔符。此谓词匹配<code>Host</code>与模式匹配的标头。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">host_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Host=**.somehost.org,**.anotherhost.org</span></span><br></pre></td></tr></table></figure>
<p>如果请求的<code>Host</code>标头具有值<code>www.somehost.org</code>或<code>beta.somehost.org</code>或<code>www.anotherhost.org</code>，则此路由将匹配。</p>
<p>此谓词将URI模板变量（<code>sub</code>如上例中定义的）提取为名称和值的映射，并将其放在<code>ServerWebExchange.getAttributes()</code>带有定义的键的位置<code>ServerWebExchangeUtils.URI_TEMPLATE_VARIABLES_ATTRIBUTE</code>。然后，这些值可供<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#gateway-route-filters" target="_blank" rel="noopener">GatewayFilter Factories使用</a></p>
<h3 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h3><p>Method Route Predicate Factory采用一个参数：要匹配的HTTP方法。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">method_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Method=GET</span></span><br></pre></td></tr></table></figure>
<p>如果请求方法是<code>GET</code>，则此路由将匹配。</p>
<h3 id="Path"><a href="#Path" class="headerlink" title="Path"></a>Path</h3><p>Path Route Predicate Factory有两个参数：Spring <code>PathMatcher</code>模式列表和一个可选标志<code>matchOptionalTrailingSeparator</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">host_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/foo/&#123;segment&#125;,/bar/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果请求路径是例如：<code>/foo/1</code>或<code>/foo/bar</code>或<code>/bar/baz</code>，则此路由将匹配。</p>
<p>此Predicate将URI模板变量（<code>segment</code>如上例中定义的）提取为名称和值的映射，并将其放在<code>ServerWebExchange.getAttributes()</code>带有定义的键的位置<code>ServerWebExchangeUtils.URI_TEMPLATE_VARIABLES_ATTRIBUTE</code>。然后，这些值可供<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#gateway-route-filters" target="_blank" rel="noopener">GatewayFilter Factories使用</a></p>
<p>可以使用实用程序方法来更轻松地访问这些变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; uriVariables = ServerWebExchangeUtils.getPathPredicateVariables(exchange);</span><br><span class="line"></span><br><span class="line">String segment = uriVariables.get(<span class="string">"segment"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h3><p>Query Route Predicate Factory有两个参数：必需<code>param</code>和可选<code>regexp</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">query_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Query=baz</span></span><br></pre></td></tr></table></figure>
<p>如果请求包含<code>baz</code>查询参数，则此路由将匹配。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">query_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Query=foo,</span> <span class="string">ba.</span></span><br></pre></td></tr></table></figure>
<p>如果请求包含<code>foo</code>其值为<code>ba.</code>regexp 匹配的查询参数，则此路由将匹配，因此<code>bar</code>并且<code>baz</code>将匹配。</p>
<h3 id="RemoteAddr"><a href="#RemoteAddr" class="headerlink" title="RemoteAddr"></a>RemoteAddr</h3><p>RemoteAddr Route Predicate Factory采用CIDR符号（IPv4或IPv6）字符串的列表（最小值为1），例如<code>192.168.0.1/16</code>（其中<code>192.168.0.1</code>是IP地址并且<code>16</code>是子网掩码）。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">remoteaddr_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RemoteAddr=192.168.1.1/24</span></span><br></pre></td></tr></table></figure>
<p>例如，如果请求的远程地址是<code>192.168.1.10</code>，则此路由将匹配。</p>
<h4 id="修改远程地址的解析方式"><a href="#修改远程地址的解析方式" class="headerlink" title="修改远程地址的解析方式"></a>修改远程地址的解析方式</h4><p>默认情况下，RemoteAddr Route Predicate Factory使用传入请求中的远程地址。如果Spring Cloud Gateway位于代理层后面，则可能与实际客户端IP地址不匹配。</p>
<p>您可以通过设置自定义来自定义解析远程地址的方式<code>RemoteAddressResolver</code>。春季云网关来与基于关闭的一个非默认的远程地址解析器<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For" target="_blank" rel="noopener">X -转发，对于头</a>，<code>XForwardedRemoteAddressResolver</code>。</p>
<p><code>XForwardedRemoteAddressResolver</code> 有两个静态构造函数方法，采用不同的安全方法：</p>
<p><code>XForwardedRemoteAddressResolver::trustAll</code>返回一个<code>RemoteAddressResolver</code>始终采用<code>X-Forwarded-For</code>标头中找到的第一个IP地址的a 。这种方法容易受到欺骗，因为恶意客户端可以设置<code>X-Forwarded-For</code>解析器可以接受的初始值。</p>
<p><code>XForwardedRemoteAddressResolver::maxTrustedIndex</code>获取与Spring Cloud Gateway前运行的可信基础架构数量相关的索引。例如，如果只能通过HAProxy访问Spring Cloud Gateway，则应使用值1。如果在可访问Spring Cloud Gateway之前需要两跳可信基础架构，则应使用值2。</p>
<p>给出以下标头值：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: 0.0.0.1, 0.0.0.2, 0.0.0.3</span><br></pre></td></tr></table></figure>
<p>以下<code>maxTrustedIndex</code>值将产生以下远程地址。</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>maxTrustedIndex</code></th>
<th style="text-align:center">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">[ <code>Integer.MIN_VALUE</code>，0]</td>
<td style="text-align:center">（<code>IllegalArgumentException</code>初始化期间无效）</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">0.0.0.3</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">0.0.0.2</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">0.0.0.1</td>
</tr>
<tr>
<td style="text-align:center">[4，<code>Integer.MAX_VALUE</code>]</td>
<td style="text-align:center">0.0.0.1</td>
</tr>
</tbody>
</table>
<p>使用Java配置：</p>
<p>GatewayConfig.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RemoteAddressResolver resolver = XForwardedRemoteAddressResolver</span><br><span class="line">    .maxTrustedIndex(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">.route(<span class="string">"direct-route"</span>,</span><br><span class="line">    r -&gt; r.remoteAddr(<span class="string">"10.1.1.1"</span>, <span class="string">"10.10.1.1/24"</span>)</span><br><span class="line">        .uri(<span class="string">"https://downstream1"</span>)</span><br><span class="line">.route(<span class="string">"proxied-route"</span>,</span><br><span class="line">    r -&gt; r.remoteAddr(resolver,  <span class="string">"10.10.1.1"</span>, <span class="string">"10.10.1.1/24"</span>)</span><br><span class="line">        .uri(<span class="string">"https://downstream2"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="Gateway-Filter-Factory"><a href="#Gateway-Filter-Factory" class="headerlink" title="Gateway Filter Factory"></a>Gateway Filter Factory</h2><p>路由过滤器允许以某种方式修改传入的HTTP请求或传出的HTTP响应。路径过滤器的范围限定为特定路径。Spring Cloud Gateway包含许多内置的GatewayFilter工厂。</p>
<p>注意有关如何使用以下任何过滤器的更详细示例，请查看<a href="https://github.com/spring-cloud/spring-cloud-gateway/tree/master/spring-cloud-gateway-core/src/test/java/org/springframework/cloud/gateway/filter/factory" target="_blank" rel="noopener">单元测试</a>。</p>
<h3 id="AddRequestHeader"><a href="#AddRequestHeader" class="headerlink" title="AddRequestHeader"></a>AddRequestHeader</h3><p>AddRequestHeader GatewayFilter Factory采用名称和值参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">add_request_header_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">AddRequestHeader=X-Request-Foo,</span> <span class="string">Bar</span></span><br></pre></td></tr></table></figure>
<p>这将为所有匹配请求的下游请求标头添加<code>X-Request-Foo:Bar</code>标头。</p>
<h3 id="AddRequestParameter"><a href="#AddRequestParameter" class="headerlink" title="AddRequestParameter"></a>AddRequestParameter</h3><p>AddRequestParameter GatewayFilter Factory采用名称和值参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">add_request_parameter_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">AddRequestParameter=foo,</span> <span class="string">bar</span></span><br></pre></td></tr></table></figure>
<p>这将为所有匹配请求添加下游请求的查询字符串<code>foo=bar</code>。</p>
<h3 id="AddResponseHeader"><a href="#AddResponseHeader" class="headerlink" title="AddResponseHeader"></a>AddResponseHeader</h3><p>AddResponseHeader GatewayFilter Factory采用名称和值参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">add_response_header_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">AddResponseHeader=X-Response-Foo,</span> <span class="string">Bar</span></span><br></pre></td></tr></table></figure>
<h3 id="DedupeResponseHeader"><a href="#DedupeResponseHeader" class="headerlink" title="DedupeResponseHeader"></a>DedupeResponseHeader</h3><p>DedupeResponseHeader GatewayFilter Factory接受<code>name</code>参数和可选<code>strategy</code>参数。<code>name</code>可以包含标题名称列表，空格分隔。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">dedupe_response_header_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">DedupeResponseHeader=Access-Control-Allow-Credentials</span> <span class="string">Access-Control-Allow-Origin</span></span><br></pre></td></tr></table></figure>
<p>在网关CORS逻辑和下游添加它们的情况下，这将删除重复的值<code>Access-Control-Allow-Credentials</code>和<code>Access-Control-Allow-Origin</code>响应头。</p>
<p>DedupeResponseHeader过滤器还接受可选<code>strategy</code>参数。接受的值是<code>RETAIN_FIRST</code>（默认）、<code>RETAIN_LAST</code>和<code>RETAIN_UNIQUE</code>。</p>
<h3 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h3><p><a href="https://github.com/Netflix/Hystrix" target="_blank" rel="noopener">Hystrix</a>是Netflix的一个库，它实现了<a href="https://martinfowler.com/bliki/CircuitBreaker.html" target="_blank" rel="noopener">断路器模式</a>。Hystrix GatewayFilter允许您将断路器引入网关路由，保护您的服务免受级联故障的影响，并允许您在下游故障时提供回退响应。</p>
<p>要在项目中启用Hystrix GatewayFilters，请<code>spring-cloud-starter-netflix-hystrix</code>从<a href="https://cloud.spring.io/spring-cloud-netflix/" target="_blank" rel="noopener">Spring Cloud Netflix</a>添加依赖项。</p>
<p>Hystrix GatewayFilter Factory需要一个<code>name</code>参数，即该参数的名称<code>HystrixCommand</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">hystrix_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Hystrix=myCommandName</span></span><br></pre></td></tr></table></figure>
<p>这将<code>HystrixCommand</code>使用命令名称包装剩余的过滤器<code>myCommandName</code>。</p>
<p>Hystrix过滤器也可以接受可选<code>fallbackUri</code>参数。目前，仅<code>forward:</code>支持计划的URI。如果调用了回退，则请求将被转发到与URI匹配的控制器。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">hystrix_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">lb://backing-service:8088</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/consumingserviceendpoint</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">Hystrix</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">fallbackcmd</span></span><br><span class="line"><span class="attr">            fallbackUri:</span> <span class="attr">forward:/incaseoffailureusethis</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RewritePath=/consumingserviceendpoint,</span> <span class="string">/backingserviceendpoint</span></span><br></pre></td></tr></table></figure>
<p>这将<code>/incaseoffailureusethis</code>在调用Hystrix回退时转发到URI。请注意，此示例还通过<code>lb</code>目标URI 上的前缀演示（可选）Spring Cloud Netflix Ribbon负载平衡。</p>
<p>主要方案是使用<code>fallbackUri</code>网关应用程序中的内部控制器或处理程序。但是，也可以将请求重新路由到外部应用程序中的控制器或处理程序，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">ingredients</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">lb://ingredients</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=//ingredients/**</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">Hystrix</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">fetchIngredients</span></span><br><span class="line"><span class="attr">            fallbackUri:</span> <span class="attr">forward:/fallback</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">ingredients-fallback</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:9994</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/fallback</span></span><br></pre></td></tr></table></figure>
<p>在此示例中，<code>fallback</code>网关应用程序中没有端点或处理程序，但是，在另一个应用程序中有一个，在其下注册<code>http://localhost:9994</code>。</p>
<p>如果请求被转发到回退，Hystrix网关过滤器也会提供<code>Throwable</code>导致它的原因。它被添加到<code>ServerWebExchange</code>作为<code>ServerWebExchangeUtils.HYSTRIX_EXECUTION_EXCEPTION_ATTR</code>在网关应用程序中处理回退时可以使用的 属性。</p>
<p>对于外部控制器/处理程序方案，可以添加包含异常详细信息的标头。您可以在<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#fallback-headers" target="_blank" rel="noopener">FallbackHeaders GatewayFilter Factory部分中</a>找到有关它的更多信息。</p>
<p>Hystrix设置（例如超时）可以使用全局默认值配置，也可以使用应用程序属性逐个路径配置，如<a href="https://github.com/Netflix/Hystrix/wiki/Configuration" target="_blank" rel="noopener">Hystrix wiki中所述</a>。</p>
<p>要为上面的示例路由设置5秒超时，将使用以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">hystrix.command.fallbackcmd.execution.isolation.thread.timeoutInMilliseconds:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>
<h3 id="FallbackHeaders"><a href="#FallbackHeaders" class="headerlink" title="FallbackHeaders"></a>FallbackHeaders</h3><p>该<code>FallbackHeaders</code>工厂可以让你在转发到请求的头部添加猬执行异常的详细信息<code>fallbackUri</code>在以下情况下在外部应用程序，如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">ingredients</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">lb://ingredients</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=//ingredients/**</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">Hystrix</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">fetchIngredients</span></span><br><span class="line"><span class="attr">            fallbackUri:</span> <span class="attr">forward:/fallback</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">ingredients-fallback</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:9994</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/fallback</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">FallbackHeaders</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            executionExceptionTypeHeaderName:</span> <span class="string">Test-Header</span></span><br></pre></td></tr></table></figure>
<p>在此示例中，在运行执行异常后<code>HystrixCommand</code>，请求将被转发到<code>fallback</code>运行的应用程序中的端点或处理程序<code>localhost:9994</code>。具有异常类型，消息和-if available-root的标头将导致异常类型和消息被<code>FallbackHeaders</code>过滤器添加到该请求中。</p>
<p>通过设置下面列出的参数的值及其默认值，可以在配置中覆盖标头的名称：</p>
<ul>
<li><code>executionExceptionTypeHeaderName</code>（<code>&quot;Execution-Exception-Type&quot;</code>）</li>
<li><code>executionExceptionMessageHeaderName</code>（<code>&quot;Execution-Exception-Message&quot;</code>）</li>
<li><code>rootCauseExceptionTypeHeaderName</code>（<code>&quot;Root-Cause-Exception-Type&quot;</code>）</li>
<li><code>rootCauseExceptionMessageHeaderName</code>（<code>&quot;Root-Cause-Exception-Message&quot;</code>）</li>
</ul>
<p>您可以在<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#hystrix" target="_blank" rel="noopener">Hystrix GatewayFilter Factory部分中</a>找到有关Hystrix如何与Gateway配合使用的更多信息。</p>
<h3 id="PrefixPath"><a href="#PrefixPath" class="headerlink" title="PrefixPath"></a>PrefixPath</h3><p>PrefixPath GatewayFilter Factory采用单个<code>prefix</code>参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">prefixpath_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">PrefixPath=/mypath</span></span><br></pre></td></tr></table></figure>
<p>这将为<code>/mypath</code>所有匹配请求的路径添加前缀。所以请求<code>/hello</code>，将发送给<code>/mypath/hello</code>。</p>
<h3 id="PreserveHostHeader"><a href="#PreserveHostHeader" class="headerlink" title="PreserveHostHeader"></a>PreserveHostHeader</h3><p>PreserveHostHeader GatewayFilter Factory没有参数。此过滤器设置路由过滤器将检查的请求属性，以确定是否应发送原始主机头，而不是http客户端确定的主机头。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">preserve_host_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">PreserveHostHeader</span></span><br></pre></td></tr></table></figure>
<h3 id="RequestRateLimiter"><a href="#RequestRateLimiter" class="headerlink" title="RequestRateLimiter"></a>RequestRateLimiter</h3><p>RequestRateLimiter GatewayFilter Factory使用<code>RateLimiter</code>实现来确定是否允许当前请求继续。如果不是，<code>HTTP 429 - Too Many Requests</code>则返回（默认情况下）状态。</p>
<p>此过滤器采用<code>keyResolver</code>特定于速率限制器的可选参数和参数（参见下文）。</p>
<p><code>keyResolver</code>是一个实现<code>KeyResolver</code>接口的bean 。在配置中，使用SpEL按名称引用bean。<code>#{@myKeyResolver}</code>是一个引用具有名称的bean的SpEL表达式<code>myKeyResolver</code>。</p>
<p><strong>KeyResolver.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KeyResolver</span> </span>&#123;</span><br><span class="line">	<span class="function">Mono&lt;String&gt; <span class="title">resolve</span><span class="params">(ServerWebExchange exchange)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该<code>KeyResolver</code>接口允许可插拔策略导出用于限制请求的密钥。在未来的里程碑中，将会有一些<code>KeyResolver</code>实现。</p>
<p>默认实现<code>KeyResolver</code>是从和调用中<code>PrincipalNameKeyResolver</code>检索。<code>Principal`</code>ServerWebExchange<code></code>Principal.getName()`</p>
<p>默认情况下，如果<code>KeyResolver</code>找不到密钥，将拒绝请求。可以使用<code>spring.cloud.gateway.filter.request-rate-limiter.deny-empty-key</code>（true或false）和<code>spring.cloud.gateway.filter.request-rate-limiter.empty-key-status-code</code>属性调整此行为。</p>
<blockquote>
<p>RequestRateLimiter不能通过“快捷方式”表示法进行配置。以下示例<em>无效</em></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#INVALID SHORTCUT CONFIGURATION spring.cloud.gateway.routes [0] .filters [0] = RequestRateLimiter = 2,2，＃&#123;@ userkeyresolver&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-RateLimiter"><a href="#Redis-RateLimiter" class="headerlink" title="Redis RateLimiter"></a>Redis RateLimiter</h3><p>redis实现基于<a href="https://stripe.com/blog/rate-limiters" target="_blank" rel="noopener">Stripe</a>完成的工作。它需要使用<code>spring-boot-starter-data-redis-reactive</code>Spring Boot启动器。</p>
<p>使用的算法是<a href="https://en.wikipedia.org/wiki/Token_bucket" target="_blank" rel="noopener">令牌桶算法</a>。</p>
<p>这<code>redis-rate-limiter.replenishRate</code>是您希望允许用户每秒执行多少请求，而不会丢弃任何请求。这是令牌桶填充的速率。</p>
<p>这<code>redis-rate-limiter.burstCapacity</code>是用户在一秒钟内允许执行的最大请求数。这是令牌桶可以容纳的令牌数。将此值设置为零将阻止所有请求。</p>
<p>通过在<code>replenishRate</code>和中设置相同的值来实现稳定的速率<code>burstCapacity</code>。设置<code>burstCapacity</code>高于时，可以允许临时突发<code>replenishRate</code>。在这种情况下，需要在突发之间允许速率限制器一段时间（根据<code>replenishRate</code>），因为2次连续突发将导致请求被丢弃（<code>HTTP 429 - Too Many Requests</code>）。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">requestratelimiter_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">RequestRateLimiter</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line">            <span class="string">redis-rate-limiter.replenishRate:</span> <span class="number">10</span></span><br><span class="line">            <span class="string">redis-rate-limiter.burstCapacity:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p><strong>Config.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">KeyResolver <span class="title">userKeyResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> exchange -&gt; Mono.just(exchange.getRequest().getQueryParams().getFirst(<span class="string">"user"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这定义了每个用户10的请求率限制。允许突发20，但下一秒只有10个请求可用。这<code>KeyResolver</code>是一个获取<code>user</code>请求参数的简单方法（注意：这不建议用于生产）。</p>
<p>速率限制器也可以定义为实现<code>RateLimiter</code>接口的bean 。在配置中，使用SpEL按名称引用bean。<code>#{@myRateLimiter}</code>是一个引用具有名称的bean的SpEL表达式<code>myRateLimiter</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">requestratelimiter_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">RequestRateLimiter</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            rate-limiter:</span> <span class="string">"#&#123;@myRateLimiter&#125;"</span></span><br><span class="line"><span class="attr">            key-resolver:</span> <span class="string">"#&#123;@userKeyResolver&#125;"</span></span><br></pre></td></tr></table></figure>
<h3 id="RedirectTo"><a href="#RedirectTo" class="headerlink" title="RedirectTo"></a>RedirectTo</h3><p>RedirectTo GatewayFilter Factory采用a <code>status</code>和<code>url</code>参数。状态应该是300系列重定向http代码，例如301. url应该是有效的URL。这将是<code>Location</code>标题的值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">prefixpath_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RedirectTo=302,</span> <span class="attr">http://acme.org</span></span><br></pre></td></tr></table></figure>
<p>这将发送带有<code>Location:http://acme.org</code>标题的状态302 以执行重定向。</p>
<h3 id="RemoveHopByHopHeadersFilter"><a href="#RemoveHopByHopHeadersFilter" class="headerlink" title="RemoveHopByHopHeadersFilter"></a>RemoveHopByHopHeadersFilter</h3><p>RemoveHopByHopHeadersFilter GatewayFilter Factory从转发的请求中删除标头。删除的标头列表来自<a href="https://tools.ietf.org/html/draft-ietf-httpbis-p1-messaging-14#section-7.1.3" target="_blank" rel="noopener">IETF</a>。</p>
<p>默认删除的标头是：</p>
<ul>
<li>Connection</li>
<li>Keep-Alive</li>
<li>Proxy-Authenticate</li>
<li>Proxy-Authorization</li>
<li>TE</li>
<li>Trailer</li>
<li>Transfer-Encoding</li>
<li>Upgrade</li>
</ul>
<p>要更改此设置，请将该<code>spring.cloud.gateway.filter.remove-non-proxy-headers.headers</code>属性设置为要删除的标题名称列表。</p>
<h3 id="RemoveRequestHeader"><a href="#RemoveRequestHeader" class="headerlink" title="RemoveRequestHeader"></a>RemoveRequestHeader</h3><p>RemoveRequestHeader GatewayFilter Factory接受一个<code>name</code>参数。它是要删除的标头的名称。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">removerequestheader_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RemoveRequestHeader=X-Request-Foo</span></span><br></pre></td></tr></table></figure>
<p>这将在向下游发送之前删除标头<code>X-Request-Foo</code>。</p>
<h3 id="RemoveResponseHeader"><a href="#RemoveResponseHeader" class="headerlink" title="RemoveResponseHeader"></a>RemoveResponseHeader</h3><p>RemoveResponseHeader GatewayFilter Factory接受一个<code>name</code>参数。它是要删除的标头的名称。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">removeresponseheader_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RemoveResponseHeader=X-Response-Foo</span></span><br></pre></td></tr></table></figure>
<p>这将<code>X-Response-Foo</code>在响应返回到网关客户端之前从响应中删除标头。</p>
<p>要删除任何类型的敏感标头，您应该为您可能要执行此操作的任何路由配置此过滤器。此外，您可以使用一次配置此过滤器<code>spring.cloud.gateway.default-filters</code> 并将其应用于所有路径。</p>
<h3 id="RewritePath"><a href="#RewritePath" class="headerlink" title="RewritePath"></a>RewritePath</h3><p>RewritePath GatewayFilter Factory采用路径<code>regexp</code>参数和<code>replacement</code>参数。这使用Java正则表达式来灵活地重写请求路径。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">rewritepath_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/foo/**</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RewritePath=/foo/(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>
<p>对于请求路径<code>/foo/bar</code>，这将设置<code>/bar</code>进行下游请求之前的路径。注意由于YAML规范而将<code>$\</code>替换<code>$</code>。</p>
<h3 id="RewriteResponseHeader"><a href="#RewriteResponseHeader" class="headerlink" title="RewriteResponseHeader"></a>RewriteResponseHeader</h3><p>RewriteResponseHeader GatewayFilter工厂需要<code>name</code>，<code>regexp</code>和<code>replacement</code>参数。它使用Java正则表达式以灵活的方式重写响应头值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">rewriteresponseheader_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RewriteResponseHeader=X-Response-Foo,</span> <span class="string">,</span> <span class="string">password=[^&amp;]+,</span> <span class="string">password=***</span></span><br></pre></td></tr></table></figure>
<p>对于标头值<code>/42?user=ford&amp;password=omg!what&amp;flag=true</code>，它将在发出下游请求后设置为<code>/42?user=ford&amp;password=***&amp;flag=true</code>。由于YAML规范，请用<code>$\</code>替换<code>$</code>。</p>
<h3 id="SaveSession"><a href="#SaveSession" class="headerlink" title="SaveSession"></a>SaveSession</h3><p>SaveSession GatewayFilter Factory <em>在</em>转发下游呼叫<em>之前</em>强制执行<code>WebSession::save</code>操作。当使用<a href="https://projects.spring.io/spring-session/" target="_blank" rel="noopener">Spring Session</a>与惰性数据存储之类的东西时，这是特别有用的，并且需要确保在转发调用之前已保存会话状态。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">save_session</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/foo/**</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SaveSession</span></span><br></pre></td></tr></table></figure>
<p>如果要将<a href="https://projects.spring.io/spring-security/" target="_blank" rel="noopener">Spring Security</a>与Spring Session 集成，并且希望确保将安全性详细信息转发到远程进程，则这很关键。</p>
<h3 id="SecureHeaders"><a href="#SecureHeaders" class="headerlink" title="SecureHeaders"></a>SecureHeaders</h3><p>SecureHeaders GatewayFilter Factory在<a href="https://blog.appcanary.com/2017/http-security-headers.html" target="_blank" rel="noopener">此博客文章</a>的推荐中为响应添加了许多标题。</p>
<p>添加以下标头（以及默认值）：</p>
<ul>
<li><code>X-Xss-Protection:1; mode=block</code></li>
<li><code>Strict-Transport-Security:max-age=631138519</code></li>
<li><code>X-Frame-Options:DENY</code></li>
<li><code>X-Content-Type-Options:nosniff</code></li>
<li><code>Referrer-Policy:no-referrer</code></li>
<li><code>Content-Security-Policy:default-src &#39;self&#39; https:; font-src &#39;self&#39; https: data:; img-src &#39;self&#39; https: data:; object-src &#39;none&#39;; script-src https:; style-src &#39;self&#39; https: &#39;unsafe-inline&#39;</code></li>
<li><code>X-Download-Options:noopen</code></li>
<li><code>X-Permitted-Cross-Domain-Policies:none</code></li>
</ul>
<p>要更改默认值，请在<code>spring.cloud.gateway.filter.secure-headers</code>命名空间中设置相应的属性：</p>
<p>要改变的属性：</p>
<ul>
<li><code>xss-protection-header</code></li>
<li><code>strict-transport-security</code></li>
<li><code>frame-options</code></li>
<li><code>content-type-options</code></li>
<li><code>referrer-policy</code></li>
<li><code>content-security-policy</code></li>
<li><code>download-options</code></li>
<li><code>permitted-cross-domain-policies</code></li>
</ul>
<h3 id="SetPath"><a href="#SetPath" class="headerlink" title="SetPath"></a>SetPath</h3><p>SetPath GatewayFilter Factory采用路径<code>template</code>参数。它提供了一种通过允许模板化路径段来操作请求路径的简单方法。这使用了Spring Framework中的uri模板。允许多个匹配的段。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setpath_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/foo/&#123;segment&#125;</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SetPath=/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>
<p>对于请求路径<code>/foo/bar</code>，这将设置<code>/bar</code>进行下游请求之前的路径。</p>
<h3 id="SetResponseHeader"><a href="#SetResponseHeader" class="headerlink" title="SetResponseHeader"></a>SetResponseHeader</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setresponseheader_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SetResponseHeader=X-Response-Foo,</span> <span class="string">Bar</span></span><br></pre></td></tr></table></figure>
<p>GatewayFilter用给定名称替换所有标头，而不是添加。因此，如果下游服务器以响应<code>X-Response-Foo:1234</code>，则将替换为<code>X-Response-Foo:Bar</code>，这是网关客户端将接收的内容。</p>
<h3 id="SetStatus"><a href="#SetStatus" class="headerlink" title="SetStatus"></a>SetStatus</h3><p>SetStatus GatewayFilter Factory采用单个<code>status</code>参数。它必须是有效的Spring <code>HttpStatus</code>。它可以是整数值<code>404</code>或枚举的字符串表示形式<code>NOT_FOUND</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setstatusstring_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SetStatus=BAD_REQUEST</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setstatusint_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SetStatus=401</span></span><br></pre></td></tr></table></figure>
<p>在任何一种情况下，响应的HTTP状态都将设置为401。</p>
<h3 id="StripPrefix"><a href="#StripPrefix" class="headerlink" title="StripPrefix"></a>StripPrefix</h3><p>StripPrefix GatewayFilter Factory采用一个参数<code>parts</code>。该<code>parts</code>参数指示在向下游发送之前从请求中剥离的路径中的部分数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">nameRoot</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://nameservice</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/name/**</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">StripPrefix=2</span></span><br></pre></td></tr></table></figure>
<p>当通过网关<code>/name/bar/foo</code>发出请求时，<code>nameservice</code>会发出请求<code>http://nameservice/foo</code>。</p>
<h3 id="Retry"><a href="#Retry" class="headerlink" title="Retry"></a>Retry</h3><p>Retry GatewayFilter 工厂采用<code>retries</code>，<code>statuses</code>，<code>methods</code>，和<code>series</code>作为参数。</p>
<ul>
<li><code>retries</code>：应尝试的重试次数</li>
<li><code>statuses</code>：应使用重试的HTTP状态代码 <code>org.springframework.http.HttpStatus</code></li>
<li><code>methods</code>：应该重试的HTTP方法，使用表示 <code>org.springframework.http.HttpMethod</code></li>
<li><code>series</code>：要重试的一系列状态代码，使用表示 <code>org.springframework.http.HttpStatus.Series</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">retry_test</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:8080/flakey</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Host=*.retry.com</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">Retry</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            retries:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">            statuses:</span> <span class="string">BAD_GATEWAY</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>重试过滤器当前不支持使用正文重试（例如，对于带有正文的POST或PUT请求）。</p>
</blockquote>
<blockquote>
<p>当使用带有<code>forward:</code>前缀URL 的重试过滤器时，应仔细编写目标端点，以便在出现错误时不会执行任何可能导致响应发送到客户端并提交的操作。例如，如果目标端点是带注释的控制器，则目标控制器方法不应返回<code>ResponseEntity</code>错误状态代码。相反，它应该抛出一个<code>Exception</code>或发出错误信号，例如通过<code>Mono.error(ex)</code>返回值，重试过滤器可以配置为通过重试来处理。</p>
</blockquote>
<h3 id="RequestSize"><a href="#RequestSize" class="headerlink" title="RequestSize"></a>RequestSize</h3><p>当请求大小大于允许的限制时，RequestSize GatewayFilter Factory可以限制请求到达下游服务。过滤器<code>RequestSize</code>作为参数，该参数是以字节为单位定义的请求的允许大小限制。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">request_size_route</span></span><br><span class="line"><span class="attr">      uri:</span> <span class="attr">http://localhost:8080/upload</span></span><br><span class="line"><span class="attr">      predicates:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Path=/upload</span></span><br><span class="line"><span class="attr">      filters:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">RequestSize</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="attr">          maxSize:</span> <span class="number">5000000</span></span><br></pre></td></tr></table></figure>
<p>当Request因大小而被拒绝时，RequestSize GatewayFilter Factory将响应状态设置为<code>413 Payload Too Large</code>附加标头<code>errorMessage</code>。以下是这样的一个例子<code>errorMessage</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errorMessage ： Request size is larger than permissible limit. Request size is 6.0 MB where permissible limit is 5.0 MB</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果未在路由定义中将过滤参数提供，则默认请求大小将设置为5 MB。</p>
</blockquote>
<h3 id="Modify-Request-Body"><a href="#Modify-Request-Body" class="headerlink" title="Modify Request Body"></a>Modify Request Body</h3><p><strong>此过滤器被视为BETA，API可能在将来发生变化</strong></p>
<p>此过滤器可用于在网关向下游发送请求主体之前对其进行修改。</p>
<blockquote>
<p>此过滤器只能使用Java DSL进行配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">routes</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.routes()</span><br><span class="line">        .route(<span class="string">"rewrite_request_obj"</span>, r -&gt; r.host(<span class="string">"*.rewriterequestobj.org"</span>)</span><br><span class="line">            .filters(f -&gt; f.prefixPath(<span class="string">"/httpbin"</span>)</span><br><span class="line">                .modifyRequestBody(String.class, Hello.class, MediaType.APPLICATION_JSON_VALUE,</span><br><span class="line">                    (exchange, s) -&gt; <span class="keyword">return</span> Mono.just(<span class="keyword">new</span> Hello(s.toUpperCase())))).uri(uri))</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Hello</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Hello</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Modify-Response-Body"><a href="#Modify-Response-Body" class="headerlink" title="Modify Response Body"></a>Modify Response Body</h3><p><strong>此过滤器被视为BETA，API可能在将来发生变化</strong></p>
<p>此过滤器可用于在将响应主体发送回客户端之前对其进行修改。</p>
<blockquote>
<p>此过滤器只能使用Java DSL进行配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">routes</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.routes()</span><br><span class="line">        .route(<span class="string">"rewrite_response_upper"</span>, r -&gt; r.host(<span class="string">"*.rewriteresponseupper.org"</span>)</span><br><span class="line">            .filters(f -&gt; f.prefixPath(<span class="string">"/httpbin"</span>)</span><br><span class="line">        		.modifyResponseBody(String.class, String.class,</span><br><span class="line">        		    (exchange, s) -&gt; Mono.just(s.toUpperCase()))).uri(uri)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Default-Filters"><a href="#Default-Filters" class="headerlink" title="Default Filters"></a>Default Filters</h3><p>如果您想添加过滤器并将其应用于您可以使用的所有路线<code>spring.cloud.gateway.default-filters</code>。此属性采用过滤器列表</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      default-filters:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">AddResponseHeader=X-Response-Default-Foo,</span> <span class="string">Default-Bar</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">PrefixPath=/httpbin</span></span><br></pre></td></tr></table></figure>
<h2 id="Global-Filters"><a href="#Global-Filters" class="headerlink" title="Global Filters"></a>Global Filters</h2><p>该<code>GlobalFilter</code>接口具有相同的签名<code>GatewayFilter</code>。这些是有条件地应用于所有路线的特殊过滤器。（此界面和用法可能会在未来的里程碑中发生变化）。</p>
<h3 id="组合全局过滤器和GatewayFilter排序"><a href="#组合全局过滤器和GatewayFilter排序" class="headerlink" title="组合全局过滤器和GatewayFilter排序"></a>组合全局过滤器和GatewayFilter排序</h3><p>当请求进入（并匹配路由）时，Filtering Web Handler会将所有实例<code>GlobalFilter</code>和所有路由特定实例添加<code>GatewayFilter</code>到过滤器链中。这个组合的过滤器链按<code>org.springframework.core.Ordered</code>接口排序，可以通过实现<code>getOrder()</code>方法或使用<code>@Order</code>注释来设置。</p>
<p>由于Spring Cloud Gateway区分了过滤器逻辑执行的“前”和“后”阶段（请参阅：工作原理），具有最高优先级的过滤器将是“pre”阶段中的第一个和“post”中的最后一个“-相。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Order</span>(-<span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">        log.info(<span class="string">"first pre filter"</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"third post filter"</span>);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Order</span>(<span class="number">0</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">        log.info(<span class="string">"second pre filter"</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"second post filter"</span>);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Order</span>(<span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">c</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">        log.info(<span class="string">"third pre filter"</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"first post filter"</span>);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Forward-Routing-Filter"><a href="#Forward-Routing-Filter" class="headerlink" title="Forward Routing Filter"></a>Forward Routing Filter</h3><p>将<code>ForwardRoutingFilter</code>在交换属性查找一个URI <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code>。如果url有一个<code>forward</code>方案（即<code>forward:///localendpoint</code>），它将使用Spring <code>DispatcherHandler</code>来处理请求。请求URL的路径部分将被转发URL中的路径覆盖。未修改的原始URL将附加到<code>ServerWebExchangeUtils.GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code>属性中的列表中。</p>
<h3 id="LoadBalancerClient过滤器"><a href="#LoadBalancerClient过滤器" class="headerlink" title="LoadBalancerClient过滤器"></a>LoadBalancerClient过滤器</h3><p>将<code>LoadBalancerClientFilter</code>在交换属性查找一个URI <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code>。如果url有一个<code>lb</code>方案（即<code>lb://myservice</code>），它将使用Spring Cloud <code>LoadBalancerClient</code>将名称（<code>myservice</code>在前面的示例中）解析为实际的主机和端口，并替换相同属性中的URI。未修改的原始URL将附加到<code>ServerWebExchangeUtils.GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code>属性中的列表中。过滤器还将查看<code>ServerWebExchangeUtils.GATEWAY_SCHEME_PREFIX_ATTR</code>属性以查看它是否等于<code>lb</code>，然后应用相同的规则。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">myRoute</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">lb://service</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/service/**</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>默认情况下，当某个服务实例不能在找到<code>LoadBalancer</code>一个<code>503</code>将被退回。您可以将网关配置为<code>404</code>按设置返回<code>spring.cloud.gateway.loadbalancer.use404=true</code>。</p>
</blockquote>
<blockquote>
<p>从中返回 的<code>isSecure</code>值将覆盖在对网关发出的请求中指定的方案。例如，如果请求进入网关， 但表示它不安全，则下游请求将被终止 。相反的情况也适用。但是，如果为网关配置中的路由指定，则将剥离前缀，并且路由URL中的结果方案将覆盖配置。 <code>ServiceInstance</code> <code>LoadBalancer</code> <code>HTTPS</code> <code>ServiceInstance</code> <code>HTTP</code> <code>GATEWAY_SCHEME_PREFIX_ATTR</code> <code>ServiceInstance</code></p>
</blockquote>
<h3 id="Netty-Routing-Filter"><a href="#Netty-Routing-Filter" class="headerlink" title="Netty Routing Filter"></a>Netty Routing Filter</h3><p>如果位于<code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code>exchange属性中的url 具有<code>http</code>或<code>https</code>scheme ，则运行Netty Routing Filter 。它使用Netty <code>HttpClient</code>发出下游代理请求。响应将放在<code>ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR</code>exchange属性中，以便在以后的过滤器中使用。（有一个实验<code>WebClientHttpRoutingFilter</code>执行相同的功能，但不需要netty）</p>
<h3 id="Netty-Write-Response-Filter"><a href="#Netty-Write-Response-Filter" class="headerlink" title="Netty Write Response Filter"></a>Netty Write Response Filter</h3><p>在<code>NettyWriteResponseFilter</code>运行，如果有一个的Netty <code>HttpClientResponse</code>在<code>ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR</code>交换属性。它在所有其他过滤器完成后运行，并将代理响应写回网关客户端响应。（有一个实验<code>WebClientWriteResponseFilter</code>执行相同的功能，但不需要netty）</p>
<h3 id="RouteToRequestUrl过滤器"><a href="#RouteToRequestUrl过滤器" class="headerlink" title="RouteToRequestUrl过滤器"></a>RouteToRequestUrl过滤器</h3><p>在<code>RouteToRequestUrlFilter</code>运行，如果有一个<code>Route</code>在对象<code>ServerWebExchangeUtils.GATEWAY_ROUTE_ATTR</code>交换属性。它根据请求URI创建一个新URI，但使用该<code>Route</code>对象的URI属性进行更新。新URI放在<code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code>exchange属性`中。</p>
<p>如果URI具有方案前缀，例如<code>lb:ws://serviceid</code>，该<code>lb</code>方案将从URI中剥离并放置在<code>ServerWebExchangeUtils.GATEWAY_SCHEME_PREFIX_ATTR</code>稍后用于过滤器链中。</p>
<h3 id="Websocket路由过滤器"><a href="#Websocket路由过滤器" class="headerlink" title="Websocket路由过滤器"></a>Websocket路由过滤器</h3><p>如果位于<code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code>exchange属性中的url 具有<code>ws</code>或<code>wss</code>scheme ，则运行Websocket路由过滤器。它使用Spring Web Socket基础结构将Websocket请求转发到下游。</p>
<p>可以通过为URI添加前缀来对Websockets进行负载平衡<code>lb</code>，例如<code>lb:ws://serviceid</code>。</p>
<blockquote>
<p>如果您使用<a href="https://github.com/sockjs" target="_blank" rel="noopener">SockJS</a>作为普通http的后备，则应配置正常的HTTP路由以及Websocket路由。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line">      <span class="comment"># SockJS route</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">websocket_sockjs_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:3001</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/websocket/info/**</span></span><br><span class="line">      <span class="comment"># Normwal Websocket route</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">websocket_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">ws://localhost:3001</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/websocket/**</span></span><br></pre></td></tr></table></figure>
<h3 id="Gateway-Metrics-Filter"><a href="#Gateway-Metrics-Filter" class="headerlink" title="Gateway Metrics Filter"></a>Gateway Metrics Filter</h3><p>要启用Gateway Metrics，请将spring-boot-starter-actuator添加为项目依赖项。然后，默认情况下，只要<code>spring.cloud.gateway.metrics.enabled</code>未将属性设置为，网关指标筛选器就会运行<code>false</code>。此过滤器添加名为“gateway.requests”的计时器度量标准，其中包含以下标记：</p>
<ul>
<li><code>routeId</code>：路由ID</li>
<li><code>routeUri</code>：API将路由到的URI</li>
<li><code>outcome</code>：由<a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/http/HttpStatus.Series.html" target="_blank" rel="noopener">HttpStatus.Series</a>分类的结果</li>
<li><code>status</code>：请求的Http状态返回给客户端</li>
</ul>
<p>然后可以从这些指标中<a href="https://cloud.spring.io/spring-cloud-gateway/images/gateway-grafana-dashboard.jpeg" target="_blank" rel="noopener">删除</a>这些指标，<code>/actuator/metrics/gateway.requests</code>并且可以轻松地与Prometheus <a href="https://cloud.spring.io/spring-cloud-gateway/images/gateway-grafana-dashboard.jpeg" target="_blank" rel="noopener">集成</a> 以创建<a href="https://cloud.spring.io/spring-cloud-gateway/images/gateway-grafana-dashboard.jpeg" target="_blank" rel="noopener">Grafana </a><a href="https://cloud.spring.io/spring-cloud-gateway/gateway-grafana-dashboard.json" target="_blank" rel="noopener">仪表板</a>。</p>
<blockquote>
<p>要启用pometheus端点，请将micrometer-registry-prometheus添加为项目依赖项。</p>
</blockquote>
<h3 id="Marking-An-Exchange-As-Routed"><a href="#Marking-An-Exchange-As-Routed" class="headerlink" title="Marking An Exchange As Routed"></a>Marking An Exchange As Routed</h3><p>在网关路由后<code>ServerWebExchange</code>，它将通过添加<code>gatewayAlreadyRouted</code> 到交换属性将该交换标记为“路由” 。一旦请求被标记为路由，其他路由过滤器将不会再次路由请求，实质上是跳过过滤器。您可以使用便捷方法将交换标记为路由，或检查交换是否已路由。</p>
<ul>
<li><code>ServerWebExchangeUtils.isAlreadyRouted</code>获取一个<code>ServerWebExchange</code>对象并检查它是否已被“路由”</li>
<li><code>ServerWebExchangeUtils.setAlreadyRouted</code>获取一个<code>ServerWebExchange</code>对象并将其标记为“路由”</li>
</ul>
<h2 id="TLS-SSL"><a href="#TLS-SSL" class="headerlink" title="TLS / SSL"></a>TLS / SSL</h2><p>网关可以通过遵循通常的Spring服务器配置来监听https上的请求。例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  ssl:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    key-alias:</span> <span class="string">scg</span></span><br><span class="line"><span class="attr">    key-store-password:</span> <span class="string">scg1234</span></span><br><span class="line"><span class="attr">    key-store:</span> <span class="attr">classpath:scg-keystore.p12</span></span><br><span class="line"><span class="attr">    key-store-type:</span> <span class="string">PKCS12</span></span><br></pre></td></tr></table></figure>
<p>网关路由可以路由到http和https后端。如果路由到https后端，则可以将网关配置为信任具有以下配置的所有下游证书：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      httpclient:</span></span><br><span class="line"><span class="attr">        ssl:</span></span><br><span class="line"><span class="attr">          useInsecureTrustManager:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>使用不安全的信任管理器不适合生产。对于生产部署，可以使用以下配置为Gateway配置一组可信任的已知证书：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      httpclient:</span></span><br><span class="line"><span class="attr">        ssl:</span></span><br><span class="line"><span class="attr">          trustedX509Certificates:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">cert1.pem</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">cert2.pem</span></span><br></pre></td></tr></table></figure>
<p>如果Spring Cloud Gateway未配置受信任证书，则使用默认信任库（可以使用系统属性javax.net.ssl.trustStore覆盖）。</p>
<h3 id="TLS-Handshake"><a href="#TLS-Handshake" class="headerlink" title="TLS Handshake"></a>TLS Handshake</h3><p>网关维护一个客户端池，用于路由到后端。通过https进行通信时，客户端会启动TLS握手。此握手与许多超时有关。可以配置这些超时（显示默认值）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      httpclient:</span></span><br><span class="line"><span class="attr">        ssl:</span></span><br><span class="line"><span class="attr">          handshake-timeout-millis:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">          close-notify-flush-timeout-millis:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">          close-notify-read-timeout-millis:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p>Spring Cloud Gateway的配置由<code>RouteDefinitionLocator</code>s的集合驱动。</p>
<p><strong>RouteDefinitionLocator.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RouteDefinitionLocator</span> </span>&#123;</span><br><span class="line">	<span class="function">Flux&lt;RouteDefinition&gt; <span class="title">getRouteDefinitions</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下，<code>PropertiesRouteDefinitionLocator</code>使用Spring Boot的<code>@ConfigurationProperties</code>机制加载属性。</p>
<p>上面的配置示例都使用了一个使用位置参数而不是命名参数的快捷符号。以下两个例子是等效的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setstatus_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">SetStatus</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            status:</span> <span class="number">401</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setstatusshortcut_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SetStatus=401</span></span><br></pre></td></tr></table></figure>
<p>对于网关的一些用法，属性是足够的，但是一些生产用例将受益于从外部源（例如数据库）加载配置。未来的里程碑版本将<code>RouteDefinitionLocator</code>基于Spring Data Repositories实现，例如：Redis，MongoDB和Cassandra。</p>
<h3 id="流畅的Java-Routes-API"><a href="#流畅的Java-Routes-API" class="headerlink" title="流畅的Java Routes API"></a>流畅的Java Routes API</h3><p>为了允许在Java中进行简单配置，在<code>RouteLocatorBuilder</code>bean中定义了一个流畅的API 。</p>
<p><strong>GatewaySampleApplication.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static imports from GatewayFilters and RoutePredicates</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder, ThrottleGatewayFilterFactory throttle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.routes()</span><br><span class="line">            .route(r -&gt; r.host(<span class="string">"**.abc.org"</span>).and().path(<span class="string">"/image/png"</span>)</span><br><span class="line">                .filters(f -&gt;</span><br><span class="line">                        f.addResponseHeader(<span class="string">"X-TestHeader"</span>, <span class="string">"foobar"</span>))</span><br><span class="line">                .uri(<span class="string">"http://httpbin.org:80"</span>)</span><br><span class="line">            )</span><br><span class="line">            .route(r -&gt; r.path(<span class="string">"/image/webp"</span>)</span><br><span class="line">                .filters(f -&gt;</span><br><span class="line">                        f.addResponseHeader(<span class="string">"X-AnotherHeader"</span>, <span class="string">"baz"</span>))</span><br><span class="line">                .uri(<span class="string">"http://httpbin.org:80"</span>)</span><br><span class="line">            )</span><br><span class="line">            .route(r -&gt; r.order(-<span class="number">1</span>)</span><br><span class="line">                .host(<span class="string">"**.throttle.org"</span>).and().path(<span class="string">"/get"</span>)</span><br><span class="line">                .filters(f -&gt; f.filter(throttle.apply(<span class="number">1</span>,</span><br><span class="line">                        <span class="number">1</span>,</span><br><span class="line">                        <span class="number">10</span>,</span><br><span class="line">                        TimeUnit.SECONDS)))</span><br><span class="line">                .uri(<span class="string">"http://httpbin.org:80"</span>)</span><br><span class="line">            )</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此样式还允许更多自定义谓词断言。<code>RouteDefinitionLocator</code>bean 定义的谓词使用逻辑组合<code>and</code>。通过使用流利的Java API，你可以使用<code>and()</code>，<code>or()</code>并且<code>negate()</code>对运营<code>Predicate</code>类。</p>
<h3 id="DiscoveryClient路由定义定位器"><a href="#DiscoveryClient路由定义定位器" class="headerlink" title="DiscoveryClient路由定义定位器"></a>DiscoveryClient路由定义定位器</h3><p>可以将网关配置为基于使用<code>DiscoveryClient</code>兼容服务注册表注册的服务来创建路由。</p>
<p>要启用此功能，请设置<code>spring.cloud.gateway.discovery.locator.enabled=true</code>并确保<code>DiscoveryClient</code>实现位于类路径上并启用（例如Netflix Eureka，Consul或Zookeeper）。</p>
<h3 id="配置DiscoveryClient路由的谓词和过滤器"><a href="#配置DiscoveryClient路由的谓词和过滤器" class="headerlink" title="配置DiscoveryClient路由的谓词和过滤器"></a>配置DiscoveryClient路由的谓词和过滤器</h3><p>默认情况下，网关为通过a创建的路由定义单个谓词和过滤器<code>DiscoveryClient</code>。</p>
<p>默认谓词是使用模式定义的路径谓词<code>/serviceId/**</code>，其中<code>serviceId</code>是来自的服务的id <code>DiscoveryClient</code>。</p>
<p>默认过滤器是带有正则表达式<code>/serviceId/(?&lt;remaining&gt;.*)</code>和替换的 重写路径过滤器<code>/${remaining}</code>。这只是在向下游发送请求之前从路径中剥离服务ID。</p>
<p>如果您想自定义<code>DiscoveryClient</code>路由使用的谓词和/或过滤器，可以通过设置<code>spring.cloud.gateway.discovery.locator.predicates[x]</code>和来自定义<code>spring.cloud.gateway.discovery.locator.filters[y]</code>。执行此操作时，如果要保留该功能，则需要确保包含上面的默认谓词和过滤器。下面是一个这样的例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.gateway.discovery.locator.predicates[0].name: Path</span><br><span class="line">spring.cloud.gateway.discovery.locator.predicates[0].args[pattern]: &quot;&apos;/&apos;+serviceId+&apos;/**&apos;&quot;</span><br><span class="line">spring.cloud.gateway.discovery.locator.predicates[1].name: Host</span><br><span class="line">spring.cloud.gateway.discovery.locator.predicates[1].args[pattern]: &quot;&apos;**.foo.com&apos;&quot;</span><br><span class="line">spring.cloud.gateway.discovery.locator.filters[0].name: Hystrix</span><br><span class="line">spring.cloud.gateway.discovery.locator.filters[0].args[name]: serviceId</span><br><span class="line">spring.cloud.gateway.discovery.locator.filters[1].name: RewritePath</span><br><span class="line">spring.cloud.gateway.discovery.locator.filters[1].args[regexp]: &quot;&apos;/&apos; + serviceId + &apos;/(?&lt;remaining&gt;.*)&apos;&quot;</span><br><span class="line">spring.cloud.gateway.discovery.locator.filters[1].args[replacement]: &quot;&apos;/$&#123;remaining&#125;&apos;&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Reactor-Netty访问日志"><a href="#Reactor-Netty访问日志" class="headerlink" title="Reactor Netty访问日志"></a>Reactor Netty访问日志</h2><p>要启用Reactor Netty访问日志，请进行设置<code>-Dreactor.netty.http.server.accessLogEnabled=true</code>。（它必须是Java System属性，而不是Spring Boot属性）。</p>
<p>可以将日志记录系统配置为具有单独的访问日志文件。以下是一个示例logback配置：</p>
<p><strong>logback.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"accessLog"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.FileAppender"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span>access_log.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"async"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.AsyncAppender"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"accessLog"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"reactor.netty.http.server.AccessLog"</span> <span class="attr">level</span>=<span class="string">"INFO"</span> <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"async"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="CORS配置"><a href="#CORS配置" class="headerlink" title="CORS配置"></a>CORS配置</h2><p>网关可以配置为控制CORS行为。“全局”CORS配置是<a href="https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/cors/CorsConfiguration.html" target="_blank" rel="noopener">Spring Framework<code>CorsConfiguration</code></a>的URL模式映射。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      globalcors:</span></span><br><span class="line"><span class="attr">        corsConfigurations:</span></span><br><span class="line">          <span class="string">'[/**]'</span><span class="string">:</span></span><br><span class="line"><span class="attr">            allowedOrigins:</span> <span class="string">"http://docs.spring.io"</span></span><br><span class="line"><span class="attr">            allowedMethods:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">GET</span></span><br></pre></td></tr></table></figure>
<p>在上面的示例中，对于所有GET请求的路径，将允许来自docs.spring.io的请求的CORS请求。</p>
<h2 id="Actuator-API"><a href="#Actuator-API" class="headerlink" title="Actuator API"></a>Actuator API</h2><p>该<code>/gateway</code>驱动器的端点允许监视和使用Spring的云网关应用程序进行交互。要进行远程访问，必须在应用程序属性中<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html#production-ready-endpoints-exposing-endpoints" target="_blank" rel="noopener">通过HTTP或JMX </a><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html#production-ready-endpoints-enabling-endpoints" target="_blank" rel="noopener">启用</a>和<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html#production-ready-endpoints-exposing-endpoints" target="_blank" rel="noopener">公开</a>端点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">management.endpoint.gateway.enabled=true # default value</span><br><span class="line">management.endpoints.web.exposure.include=gateway</span><br></pre></td></tr></table></figure>
<h3 id="检索路由过滤器"><a href="#检索路由过滤器" class="headerlink" title="检索路由过滤器"></a>检索路由过滤器</h3><h4 id="全球过滤器"><a href="#全球过滤器" class="headerlink" title="全球过滤器"></a>全球过滤器</h4><p>要检索应用于所有路由的全局过滤器，请发出GET请求/actuator/gateway/globalfilters。结果响应类似于以下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@77856cc5"</span>: <span class="number">10100</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@4f6fd101"</span>: <span class="number">10000</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@32d22650"</span>: <span class="number">-1</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.ForwardRoutingFilter@106459d9"</span>: <span class="number">2147483647</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.NettyRoutingFilter@1fbd5e0"</span>: <span class="number">2147483647</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.ForwardPathFilter@33a71d23"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@135064ea"</span>: <span class="number">2147483637</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@23c05889"</span>: <span class="number">2147483646</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>响应包含有关全局过滤器的详细信息。对于每个全局过滤器，提供过滤器对象的字符串表示（例如<code>org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@77856cc5</code>）和过滤器链中的对应<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#_combined_global_filter_and_gatewayfilter_ordering" target="_blank" rel="noopener">顺序</a>。</p>
<h4 id="Route过滤器"><a href="#Route过滤器" class="headerlink" title="Route过滤器"></a>Route过滤器</h4><p>要检索应用于路由的<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#gatewayfilter-factories" target="_blank" rel="noopener">GatewayFilter工厂</a>，请发出<code>GET</code>请求<code>/actuator/gateway/routefilters</code>。结果响应类似于以下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"[AddRequestHeaderGatewayFilterFactory@570ed9c configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"[SecureHeadersGatewayFilterFactory@fceab5d configClass = Object]"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"[SaveSessionGatewayFilterFactory@4449b273 configClass = Object]"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>响应包含应用于任何特定路由的GatewayFilter工厂的详细信息。为每个工厂提供相应对象的字符串表示（例如<code>[SecureHeadersGatewayFilterFactory@fceab5d configClass = Object]</code>）。请注意，该<code>null</code>值是由于端点控制器的实现不完整，因为它尝试设置过滤器链中对象的顺序，这不适用于GatewayFilter工厂对象。</p>
<h3 id="刷新路由缓存"><a href="#刷新路由缓存" class="headerlink" title="刷新路由缓存"></a>刷新路由缓存</h3><p>要清除路由缓存，请发出<code>POST</code>请求<code>/actuator/gateway/refresh</code>。请求返回200没有响应正文</p>
<h3 id="检索网关中定义的路由"><a href="#检索网关中定义的路由" class="headerlink" title="检索网关中定义的路由"></a>检索网关中定义的路由</h3><p>要检索网关中定义的路由，请发出<code>GET</code>请求<code>/actuator/gateway/routes</code>。结果响应类似于以下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">  <span class="attr">"route_id"</span>: <span class="string">"first_route"</span>,</span><br><span class="line">  <span class="attr">"route_object"</span>: &#123;</span><br><span class="line">    <span class="attr">"predicate"</span>: <span class="string">"org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$432/1736826640@1e9d7e7d"</span>,</span><br><span class="line">    <span class="attr">"filters"</span>: [</span><br><span class="line">      <span class="string">"OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.PreserveHostHeaderGatewayFilterFactory$$Lambda$436/674480275@6631ef72, order=0&#125;"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"route_id"</span>: <span class="string">"second_route"</span>,</span><br><span class="line">  <span class="attr">"route_object"</span>: &#123;</span><br><span class="line">    <span class="attr">"predicate"</span>: <span class="string">"org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$432/1736826640@cd8d298"</span>,</span><br><span class="line">    <span class="attr">"filters"</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>响应包含网关中定义的所有路由的详细信息。下表描述了响应的每个元素（即路由）的结构。</p>
<table>
<thead>
<tr>
<th style="text-align:center">路径</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">route_id</td>
<td style="text-align:center">String</td>
<td style="text-align:center">路由ID</td>
</tr>
<tr>
<td style="text-align:center">route_object.predicate</td>
<td style="text-align:center">Object</td>
<td style="text-align:center">路由断言</td>
</tr>
<tr>
<td style="text-align:center">route_object.filters</td>
<td style="text-align:center">Array</td>
<td style="text-align:center">该<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#gatewayfilter-factories" target="_blank" rel="noopener">GatewayFilter工厂</a>工厂使用的路由</td>
</tr>
<tr>
<td style="text-align:center">order</td>
<td style="text-align:center">Number</td>
<td style="text-align:center">路由顺序</td>
</tr>
</tbody>
</table>
<h3 id="检索有关特定路线的信息"><a href="#检索有关特定路线的信息" class="headerlink" title="检索有关特定路线的信息"></a>检索有关特定路线的信息</h3><p>要检索有关单个路径的信息，<code>GET</code>请向<code>/actuator/gateway/routes/{id}</code>（例如<code>/actuator/gateway/routes/first_route</code>）发出请求。结果响应类似于以下内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="string">"first_route"</span>,</span><br><span class="line">  <span class="attr">"predicates"</span>: [&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"Path"</span>,</span><br><span class="line">    <span class="attr">"args"</span>: &#123;<span class="attr">"_genkey_0"</span>:<span class="string">"/first"</span>&#125;</span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">"filters"</span>: [],</span><br><span class="line">  <span class="attr">"uri"</span>: <span class="string">"http://www.uri-destination.org"</span>,</span><br><span class="line">  <span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>下表描述了响应的结构：</p>
<table>
<thead>
<tr>
<th style="text-align:center">路径</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>id</code></td>
<td style="text-align:center">String</td>
<td style="text-align:center">路由ID</td>
</tr>
<tr>
<td style="text-align:center"><code>predicates</code></td>
<td style="text-align:center">Array</td>
<td style="text-align:center">路由断言的集合。每个项目定义给定断言的名称和参数</td>
</tr>
<tr>
<td style="text-align:center"><code>filters</code></td>
<td style="text-align:center">Array</td>
<td style="text-align:center">应用于路径的过滤器集合</td>
</tr>
<tr>
<td style="text-align:center"><code>uri</code></td>
<td style="text-align:center">String</td>
<td style="text-align:center">路由的目标URI</td>
</tr>
<tr>
<td style="text-align:center"><code>order</code></td>
<td style="text-align:center">Number</td>
<td style="text-align:center">路由顺序</td>
</tr>
</tbody>
</table>
<h3 id="创建和删除特定路线"><a href="#创建和删除特定路线" class="headerlink" title="创建和删除特定路线"></a>创建和删除特定路线</h3><p>要创建路由，<code>POST</code>请<code>/gateway/routes/{id_route_to_create}</code>使用指定路径字段的JSON主体发出请求（请参阅上一小节）。</p>
<p>要删除路线，请发出<code>DELETE</code>请求<code>/gateway/routes/{id_route_to_delete}</code>。</p>
<h3 id="回顾：所有端点的列表"><a href="#回顾：所有端点的列表" class="headerlink" title="回顾：所有端点的列表"></a>回顾：所有端点的列表</h3><p>下表总结了Spring Cloud Gateway执行器端点。请注意，每个端点都具有<code>/actuator/gateway</code>基本路径。</p>
<table>
<thead>
<tr>
<th style="text-align:center">ID</th>
<th style="text-align:center">HTTP方法</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>globalfilters</code></td>
<td style="text-align:center">GET</td>
<td style="text-align:center">显示应用于路径的全局过滤器列表</td>
</tr>
<tr>
<td style="text-align:center"><code>routefilters</code></td>
<td style="text-align:center">GET</td>
<td style="text-align:center">显示应用于特定路由的GatewayFilter工厂列表</td>
</tr>
<tr>
<td style="text-align:center"><code>refresh</code></td>
<td style="text-align:center">POST</td>
<td style="text-align:center">清除路由缓存</td>
</tr>
<tr>
<td style="text-align:center"><code>routes</code></td>
<td style="text-align:center">GET</td>
<td style="text-align:center">显示网关中定义的路由列表</td>
</tr>
<tr>
<td style="text-align:center"><code>routes/{id}</code></td>
<td style="text-align:center">GET</td>
<td style="text-align:center">显示有关特定路径的信息</td>
</tr>
<tr>
<td style="text-align:center"><code>routes/{id}</code></td>
<td style="text-align:center">POST</td>
<td style="text-align:center">添加到网关的新路由</td>
</tr>
<tr>
<td style="text-align:center"><code>routes/{id}</code></td>
<td style="text-align:center">DELETE</td>
<td style="text-align:center">从网关中删除现有路由</td>
</tr>
</tbody>
</table>
<h2 id="开发者指南"><a href="#开发者指南" class="headerlink" title="开发者指南"></a>开发者指南</h2><p>TODO：编写自定义集成的概述</p>
<h3 id="编写自定义路由断言工厂"><a href="#编写自定义路由断言工厂" class="headerlink" title="编写自定义路由断言工厂"></a>编写自定义路由断言工厂</h3><p>TODO：撰写Custom Route Predicate Factories的文档</p>
<h3 id="编写自定义GatewayFilter工厂"><a href="#编写自定义GatewayFilter工厂" class="headerlink" title="编写自定义GatewayFilter工厂"></a>编写自定义GatewayFilter工厂</h3><p>要编写GatewayFilter，您需要实现<code>GatewayFilterFactory</code>。有一个<code>AbstractGatewayFilterFactory</code>可以扩展的抽象类：</p>
<p><strong>PreGatewayFilterFactory.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">PreGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PreGatewayFilterFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(Config.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// grab configuration from Config object</span></span><br><span class="line">		<span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">            <span class="comment">//If you want to build a "pre" filter you need to manipulate the</span></span><br><span class="line">            <span class="comment">//request before calling chain.filter</span></span><br><span class="line">            ServerHttpRequest.Builder builder = exchange.getRequest().mutate();</span><br><span class="line">            <span class="comment">//use builder to manipulate the request</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Put the configuration properties for your filter here</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>PostGatewayFilterFactory.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PostGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">PostGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PostGatewayFilterFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(Config.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// grab configuration from Config object</span></span><br><span class="line">		<span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">			<span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">				ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">				<span class="comment">//Manipulate the response in some way</span></span><br><span class="line">			&#125;));</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Put the configuration properties for your filter here</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编写定制全局过滤器"><a href="#编写定制全局过滤器" class="headerlink" title="编写定制全局过滤器"></a>编写定制全局过滤器</h3><p>要编写自定义全局过滤器，您需要实现<code>GlobalFilter</code>接口。这将过滤器应用于所有请求。</p>
<p>分别如何设置全局前置和后置过滤器的示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">customGlobalFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; exchange.getPrincipal()</span><br><span class="line">        .map(Principal::getName)</span><br><span class="line">        .defaultIfEmpty(<span class="string">"Default User"</span>)</span><br><span class="line">        .map(userName -&gt; &#123;</span><br><span class="line">          <span class="comment">//adds header to proxied request</span></span><br><span class="line">          exchange.getRequest().mutate().header(<span class="string">"CUSTOM-REQUEST-HEADER"</span>, userName).build();</span><br><span class="line">          <span class="keyword">return</span> exchange;</span><br><span class="line">        &#125;)</span><br><span class="line">        .flatMap(chain::filter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">customGlobalPostFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; chain.filter(exchange)</span><br><span class="line">        .then(Mono.just(exchange))</span><br><span class="line">        .map(serverWebExchange -&gt; &#123;</span><br><span class="line">          <span class="comment">//adds header to response</span></span><br><span class="line">          serverWebExchange.getResponse().getHeaders().set(<span class="string">"CUSTOM-RESPONSE-HEADER"</span>,</span><br><span class="line">              HttpStatus.OK.equals(serverWebExchange.getResponse().getStatusCode()) ? <span class="string">"It worked"</span>: <span class="string">"It did not work"</span>);</span><br><span class="line">          <span class="keyword">return</span> serverWebExchange;</span><br><span class="line">        &#125;)</span><br><span class="line">        .then();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编写自定义路由定位器和写入器"><a href="#编写自定义路由定位器和写入器" class="headerlink" title="编写自定义路由定位器和写入器"></a>编写自定义路由定位器和写入器</h3><p>TODO：编写自定义路由定位器和写入器的文档</p>
<h2 id="使用Spring-MVC或Webflux构建简单网关"><a href="#使用Spring-MVC或Webflux构建简单网关" class="headerlink" title="使用Spring MVC或Webflux构建简单网关"></a>使用Spring MVC或Webflux构建简单网关</h2><p>Spring Cloud Gateway提供了一个实用程序对象<code>ProxyExchange</code>，可以在常规Spring Web处理程序中将其用作方法参数。它通过镜像HTTP谓词的方法支持基本的下游HTTP交换。使用MVC，它还支持通过该<code>forward()</code>方法转发到本地处理程序。要<code>ProxyExchange</code>在类路径中使用恰好包含正确的模块（<code>spring-cloud-gateway-mvc</code>或者<code>spring-cloud-gateway-webflux</code>）。</p>
<p>MVC示例（代理向远程服务器下游“/test”的请求）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewaySampleApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;remote.home&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> URI home;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;?&gt; proxy(ProxyExchange&lt;<span class="keyword">byte</span>[]&gt; proxy) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> proxy.uri(home.toString() + <span class="string">"/image/png"</span>).get();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Webflux也是如此：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewaySampleApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;remote.home&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> URI home;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">	<span class="keyword">public</span> Mono&lt;ResponseEntity&lt;?&gt;&gt; proxy(ProxyExchange&lt;<span class="keyword">byte</span>[]&gt; proxy) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> proxy.uri(home.toString() + <span class="string">"/image/png"</span>).get();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有一些方便的方法<code>ProxyExchange</code>可以使处理程序方法发现和增强传入请求的URI路径。例如，您可能希望提取路径的尾随元素以将其传递到下游：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/proxy/path/**"</span>)</span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;?&gt; proxyPath(ProxyExchange&lt;<span class="keyword">byte</span>[]&gt; proxy) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  String path = proxy.path(<span class="string">"/proxy/path/"</span>);</span><br><span class="line">  <span class="keyword">return</span> proxy.uri(home.toString() + <span class="string">"/foos/"</span> + path).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring MVC或Webflux的所有功能都可用于Gateway处理程序方法。例如，您可以注入请求标头和查询参数，并且您可以使用映射注释中的声明来约束传入的请求。有关<code>@RequestMapping</code>这些功能的更多详细信息，请参阅Spring MVC中的文档。</p>
<p>可以使用<code>header()</code>方法将标头添加到下游响应中<code>ProxyExchange</code>。</p>
<p>您还可以通过向<code>get()</code>etc方法添加映射器来操作响应标头（以及响应中您喜欢的任何其他内容）。映射器是一个<code>Function</code>接收传入<code>ResponseEntity</code>并将其转换为传出映射器的映射器。</p>
<p>为“敏感”标题（默认情况下为“cookie”和“授权”）提供了第一类支持，这些标题未传递到下游，而“代理”标题（<code>x-forwarded-*</code>）也是如此。</p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">YoungDream</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="http://qq994300880.github.io/2019/03/26/基于2.2.x的SpringCloudGateway/">http://qq994300880.github.io/2019/03/26/基于2.2.x的SpringCloudGateway/</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://qq994300880.github.io">YD Blog</a>！</span></div></div></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2019/03/26/认识JWT/"><i class="fas fa-angle-left">&nbsp;</i><span>认识JWT</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2019/03/25/SpringBoot整合Security/"><span>SpringBoot整合Security</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script><div id="gitalk-container"></div><script src="/js/gitalk.js"></script></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2019 By YoungDream</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/clicklove.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>