<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="正忙着优秀~~~"><meta name="keywords" content><meta name="author" content="YoungDream,undefined"><meta name="copyright" content="YoungDream"><title>小小搬砖工【YD Blog】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="icon" href="/favicon-16x16-user.png"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!--link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!--link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!--script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"0BGAOITLJQ","apiKey":"2c864a8b4720c83c2ddfc7e53d4c1711","indexName":"article_NAME","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
}</script></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="author-info"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/user.jpg"></div><div class="author-info-name">YoungDream</div><div class="author-info-description">正忙着优秀~~~</div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/qq994300880" target="_blank">GitHub<i class="icon-dot bg-color2"></i></a><a class="links-button button-hover" href="http://wpa.qq.com/msgrd?v=3&amp;uin=994300880&amp;site=qq&amp;menu=yes" target="_blank">QQ<i class="icon-dot bg-color8"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">54</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">66</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">10</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">YD Blog</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><div id="recent-posts"><!-- each post in page.posts.sort('date', -1).limit(10).toArray()--><!-- config中配置按照什么排序--><div class="recent-post-item"><a class="post-title" href="/2019/03/28/SpringBoot-MyBatis-MySQL读写分离/">SpringBoot+MyBatis+MySQL读写分离</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2019-03-29</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/mysql/">mysql</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/spring/">spring</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/master/">master</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/mybatis/">mybatis</a></div></div><div class="post-content"><div class="main-content content"><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>​    读写分离要做的事情就是对于一条SQL该选择哪个数据库去执行，至于谁来做选择数据库这件事儿，无非两个，要么中间件帮我们做，要么程序自己做。因此，一般来讲，读写分离有两种实现方式。第一种是依靠中间件（比如：MyCat），也就是说应用程序连接到中间件，中间件帮我们做SQL分离；第二种是应用程序自己去做分离。这里我们选择程序自己来做，主要是利用Spring提供的路由数据源，以及AOP</p>
<p>​    然而，应用程序层面去做读写分离最大的弱点（不足之处）在于无法动态增加数据库节点，因为数据源配置都是写在配置中的，新增数据库意味着新加一个数据源，必然改配置，并重启应用。当然，好处就是相对简单。</p>
<p><img src="/images/SpringBoot+MyBatis+MySQL读写分离-图1.png" alt="图1"></p>
<h2 id="AbstractRoutingDataSource"><a href="#AbstractRoutingDataSource" class="headerlink" title="AbstractRoutingDataSource"></a>AbstractRoutingDataSource</h2><p>基于特定的查找key路由到特定的数据源。它内部维护了一组目标数据源，并且做了路由key与目标数据源之间的映射，提供基于key查找数据源的方法。</p>
<p><img src="/images/SpringBoot+MyBatis+MySQL读写分离-图2.png" alt="图1"></p>
<p>类对应的注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Abstract &#123;@link javax.sql.DataSource&#125; implementation that routes &#123;@link #getConnection()&#125;</span><br><span class="line">calls to one of various target DataSources based on a lookup key. The latter is usually</span><br><span class="line">(but not necessarily) determined through some thread-bound transaction context.</span><br></pre></td></tr></table></figure>
<p>大概意思就是<code>getConnection()</code>根据查找<code>lookup key</code>键对不同目标数据源的调用，通常是通过(但不一定)某些线程绑定的事物上下文来实现。通过这我们知道可以实现： </p>
<ul>
<li>多数据源的动态切换，在程序运行时，把数据源数据源动态织入到程序中，灵活的进行数据源切换。 </li>
<li>基于多数据源的动态切换，我们可以实现读写分离，这么做缺点也很明显，无法动态的增加数据源。</li>
</ul>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>关于MySQL的主从复制配置，可以参考<a href="https://qq994300880.github.io/2019/03/27/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE/">&lt;&lt;MySQL主从复制配置&gt;&gt;</a></p>
<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.learn.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>read_write<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>read_write<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-undertow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-lang3 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="数据源配置"><a href="#数据源配置" class="headerlink" title="数据源配置"></a>数据源配置</h3><h4 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    master:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      password:</span> <span class="number">1230</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">jdbc:mysql://192.168.43.8:15001/test?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;charactorEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">      driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">    slave01:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">readonly</span> <span class="comment">#只读</span></span><br><span class="line"><span class="attr">      password:</span> <span class="number">110</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">jdbc:mysql://192.168.43.8:15002/test?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;charactorEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">      driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">    slave02:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">readonly</span> <span class="comment">#只读</span></span><br><span class="line"><span class="attr">      password:</span> <span class="number">110</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">jdbc:mysql://192.168.43.8:15003/test?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;charactorEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">      driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">com.learn.mysql.read_write.component:</span> <span class="string">info</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>写到这里突然断电了，IDEA瘫了，删除默认配置文件，重启IDEA，重新创建新项目#_#…</p>
</blockquote>
<h4 id="多数据源配置"><a href="#多数据源配置" class="headerlink" title="多数据源配置"></a>多数据源配置</h4><p>首先分别将三个数据库配置加载到容器中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write.component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/29 4:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.master"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;? extends DataSource&gt; type;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从库的类似，配置好就行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.learn.mysql.read_write.component.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/28 20:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MasterProperties masterProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Slave01Properties slave01Properties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Slave02Properties slave02Properties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataSourceConfig</span><span class="params">(MasterProperties masterProperties, Slave01Properties slave01Properties, Slave02Properties slave02Properties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.masterProperties = masterProperties;</span><br><span class="line">        <span class="keyword">this</span>.slave01Properties = slave01Properties;</span><br><span class="line">        <span class="keyword">this</span>.slave02Properties = slave02Properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"master"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">masterDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create()</span><br><span class="line">                .type(masterProperties.getType())</span><br><span class="line">                .username(masterProperties.getUsername())</span><br><span class="line">                .password(masterProperties.getPassword())</span><br><span class="line">                .url(masterProperties.getUrl())</span><br><span class="line">                .driverClassName(masterProperties.getDriverClassName())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"slave01"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">slave02DataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create()</span><br><span class="line">                .type(slave01Properties.getType())</span><br><span class="line">                .username(slave01Properties.getUsername())</span><br><span class="line">                .password(slave01Properties.getPassword())</span><br><span class="line">                .url(slave01Properties.getUrl())</span><br><span class="line">                .driverClassName(slave01Properties.getDriverClassName())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"slave02"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">slave01DataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create()</span><br><span class="line">                .type(slave02Properties.getType())</span><br><span class="line">                .username(slave02Properties.getUsername())</span><br><span class="line">                .password(slave02Properties.getPassword())</span><br><span class="line">                .url(slave02Properties.getUrl())</span><br><span class="line">                .driverClassName(slave02Properties.getDriverClassName())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"myRoutingDataSource"</span>)</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">(DataSource master, DataSource slave01, DataSource slave02)</span> </span>&#123;</span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(DBTypeEnum.MYSQL_MASTER, master);</span><br><span class="line">        map.put(DBTypeEnum.MYSQL_SLAVE01, slave01);</span><br><span class="line">        map.put(DBTypeEnum.MYSQL_SLAVE02, slave02);</span><br><span class="line">        MyRoutingDataSource dataSource = <span class="keyword">new</span> MyRoutingDataSource();</span><br><span class="line">        dataSource.setDefaultTargetDataSource(master);</span><br><span class="line">        dataSource.setTargetDataSources(map);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，我们配置了4个数据源，1个master，2两个slave，1个路由数据源。前3个数据源都是为了生成第4个数据源，而且后续我们只用这最后一个路由数据源。</p>
<h4 id="MyBatis配置"><a href="#MyBatis配置" class="headerlink" title="MyBatis配置"></a>MyBatis配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/28 21:57</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource myRoutingDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MybatisConfig</span><span class="params">(DataSource myRoutingDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.myRoutingDataSource = myRoutingDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sqlSessionFactory</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(myRoutingDataSource);</span><br><span class="line">        bean.setMapperLocations(<span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(<span class="string">"classpath:mybatis/mapper/*.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> bean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">platformTransactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(myRoutingDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于Spring容器中现在有4个数据源，所以我们需要为事务管理器和MyBatis手动指定一个明确的数据源。</p>
<h3 id="设置路由key-查找数据源"><a href="#设置路由key-查找数据源" class="headerlink" title="设置路由key / 查找数据源"></a>设置路由key / 查找数据源</h3><p>目标数据源就是那前3个这个我们是知道的，但是使用的时候是如果查找数据源的呢？</p>
<p>首先，我们定义一个枚举来代表这三个数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write.component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/28 20:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> DBTypeEnum &#123;</span><br><span class="line">    MYSQL_MASTER, MYSQL_SLAVE01, MYSQL_SLAVE02;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，通过ThreadLocal将数据源设置到每个线程上下文中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write.component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/28 22:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DBContextHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;DBTypeEnum&gt; DB_TYPE_ENUM_THREAD_LOCAL = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger ATOMIC_INTEGER = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ArrayList&lt;DBTypeEnum&gt; SLAVES = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> slave_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (DBTypeEnum dbTypeEnum : DBTypeEnum.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dbTypeEnum != DBTypeEnum.MYSQL_MASTER) &#123;</span><br><span class="line">                SLAVES.add(dbTypeEnum);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        slave_size = SLAVES.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(DBTypeEnum dbTypeEnum)</span> </span>&#123;</span><br><span class="line">        DB_TYPE_ENUM_THREAD_LOCAL.set(dbTypeEnum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DBTypeEnum <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DB_TYPE_ENUM_THREAD_LOCAL.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">master</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        set(DBTypeEnum.MYSQL_MASTER);</span><br><span class="line">        log.info(<span class="string">"切换到：&#123;&#125;"</span>, DBTypeEnum.MYSQL_MASTER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">slave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ATOMIC_INTEGER.getAndIncrement() &gt;= slave_size) &#123;</span><br><span class="line">            ATOMIC_INTEGER.set(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        DBTypeEnum target = SLAVES.get(ATOMIC_INTEGER.get());</span><br><span class="line">        set(target);</span><br><span class="line">        log.info(<span class="string">"切换到：&#123;&#125;"</span>, target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取路由key</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write.component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/29 1:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRoutingDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DBContextHolder.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置路由key</p>
<p>默认情况下，所有的查询都走从库，插入/修改/删除走主库。我们通过方法名来区分操作类型（CRUD）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.learn.mysql.read_write.component.DBContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/29 1:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceAop</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"!@annotation(com.learn.mysql.read_write.annotation.Master) "</span> +</span><br><span class="line">            <span class="string">"&amp;&amp; (execution(* com.learn.mysql.read_write.service..*.query*(..)) "</span> +</span><br><span class="line">            <span class="string">"|| execution(* com.learn.mysql.read_write.service..*.list()))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readPointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.learn.mysql.read_write.annotation.Master)"</span> +</span><br><span class="line">            <span class="string">"||(execution(* com.learn.mysql.read_write.service..*.add(..)))"</span> +</span><br><span class="line">            <span class="string">"||(execution(* com.learn.mysql.read_write.service..*.delete(..)))"</span> +</span><br><span class="line">            <span class="string">"||(execution(* com.learn.mysql.read_write.service..*.update(..)))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writePointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"readPointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DBContextHolder.slave();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"writePointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DBContextHolder.master();</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//第二种方法，简单但不够灵活</span></span><br><span class="line"><span class="comment">//    @Before("execution(* com.learn.mysql.read_write.service..*.*(..))")</span></span><br><span class="line"><span class="comment">//    public void before(JoinPoint joinPoint) &#123;</span></span><br><span class="line"><span class="comment">//        String name = joinPoint.getSignature().getName();</span></span><br><span class="line"><span class="comment">//        if (StringUtils.startsWithAny(name, "query", "list")) &#123;</span></span><br><span class="line"><span class="comment">//            DBContextHolder.slave();</span></span><br><span class="line"><span class="comment">//        &#125; else &#123;</span></span><br><span class="line"><span class="comment">//            DBContextHolder.master();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有一般情况就有特殊情况，特殊情况是某些情况下我们需要强制读主库，针对这种情况，我们定义一个主键，用该注解标注的就读主库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write.annotation;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/29 2:06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Master &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有一张表t_user，对应的实体类只有3个属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write.entities;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/29 0:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime time;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Mapper：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.learn.mysql.read_write.entities.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/29 0:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">add</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">update</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">query</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">list</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Service：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.learn.mysql.read_write.annotation.Master;</span><br><span class="line"><span class="keyword">import</span> com.learn.mysql.read_write.entities.User;</span><br><span class="line"><span class="keyword">import</span> com.learn.mysql.read_write.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.learn.mysql.read_write.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/29 2:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span>(timeout = <span class="number">30</span>)</span><br><span class="line"><span class="meta">@Service</span>(<span class="string">"userService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.add(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Master</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.delete(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.update(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.NOT_SUPPORTED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">query</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.query(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.NOT_SUPPORTED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Master</span></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.NOT_SUPPORTED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"这是appId方法"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.mysql.read_write;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.learn.mysql.read_write.component.MasterProperties;</span><br><span class="line"><span class="keyword">import</span> com.learn.mysql.read_write.entities.User;</span><br><span class="line"><span class="keyword">import</span> com.learn.mysql.read_write.service.UserService;</span><br><span class="line"><span class="keyword">import</span> com.learn.mysql.read_write.service.impl.UserServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadWriteApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MasterProperties masterProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAuto</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(masterProperties.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAdd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(userService.add(<span class="keyword">new</span> User()</span><br><span class="line">                                           .setName(<span class="string">"aaa"</span>)</span><br><span class="line">                                           .setTime(LocalDateTime.now())));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = <span class="number">1</span>;</span><br><span class="line">        System.out.println(userService.delete(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = <span class="number">2</span>;</span><br><span class="line">        User query = userService.query(id);</span><br><span class="line">        String name = <span class="string">"newName"</span>;</span><br><span class="line">        query.setName(name);</span><br><span class="line">        query.setTime(LocalDateTime.now());</span><br><span class="line">        System.out.println(userService.update(query));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = <span class="number">2</span>;</span><br><span class="line">        System.out.println(userService.query(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(userService.list());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (userService <span class="keyword">instanceof</span> UserServiceImpl) &#123;</span><br><span class="line">            System.out.println(((UserServiceImpl) userService).getAppId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台</p>
<p><code>testAdd()</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2019-03-29 11:59:01.003  INFO 7584 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...</span><br><span class="line">2019-03-29 11:59:01.237  INFO 7584 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.</span><br><span class="line">执行DataSourceAop...write...</span><br><span class="line">切换到MYSQL_MASTER</span><br><span class="line">true</span><br></pre></td></tr></table></figure>
<p><code>testList()</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">执行DataSourceAop...read...</span><br><span class="line">切换到MYSQL_SLAVE02</span><br><span class="line">执行DataSourceAop...read...</span><br><span class="line">切换到MYSQL_SLAVE01</span><br><span class="line">执行DataSourceAop...read...</span><br><span class="line">切换到MYSQL_SLAVE02</span><br><span class="line">执行DataSourceAop...read...</span><br><span class="line">切换到MYSQL_SLAVE01</span><br><span class="line">执行DataSourceAop...read...</span><br><span class="line">切换到MYSQL_SLAVE02</span><br></pre></td></tr></table></figure>
<p><code>testDelete()</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">执行DataSourceAop...write...</span><br><span class="line">切换到MYSQL_MASTER</span><br><span class="line">false</span><br></pre></td></tr></table></figure>
<p><code>testUpdate()</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">执行DataSourceAop...read...</span><br><span class="line">切换到MYSQL_SLAVE01</span><br><span class="line">执行DataSourceAop...write...</span><br><span class="line">切换到MYSQL_MASTER</span><br><span class="line">true</span><br></pre></td></tr></table></figure>
</div></div><a class="button-hover more" href="/2019/03/28/SpringBoot-MyBatis-MySQL读写分离/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2019/03/28/解决Docker容器存放目录空间不足的问题/">解决Docker容器存放目录空间不足的问题</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2019-03-28</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/docker/">docker</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/disk/">disk</a></div></div><div class="post-content"><div class="main-content content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>​    docker所在服务器，运行了一段时间后，发现服务器磁盘目录快不够用了。通过<code>du -h --max-depth=1 /</code> 逐级目录排查，发现<code>/var/lib/docker</code>目录文件过大。通过以下方法，解决该问题。</p>
<h2 id="转移数据修改docker默认存储位置"><a href="#转移数据修改docker默认存储位置" class="headerlink" title="转移数据修改docker默认存储位置"></a>转移数据修改docker默认存储位置</h2><blockquote>
<p>有多种方式修改docker默认存储位置。<br>最好是在docker安装完后，第一时间修改docker默认存储位置为其他大目录或者磁盘中。规避迁移数据过程中造成的风险。</p>
</blockquote>
<h3 id="停止docker服务"><a href="#停止docker服务" class="headerlink" title="停止docker服务"></a>停止docker服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker</span><br></pre></td></tr></table></figure>
<h3 id="创建新的docker目录"><a href="#创建新的docker目录" class="headerlink" title="创建新的docker目录"></a>创建新的docker目录</h3><p>执行命令df -h,找一个大的磁盘</p>
<p>找到后<code>(我这里找到的是/home)</code>在 <code>/home</code>目录下面建了<code>/home/modules/docker/lib</code>目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/modules/docker/lib</span><br></pre></td></tr></table></figure>
<h3 id="迁移"><a href="#迁移" class="headerlink" title="迁移"></a>迁移</h3><p>将<code>/var/lib/docker</code>目录下面的文件到<code>/home/modules/docker/lib</code></p>
<p>迁移后的完成docker路径：<code>/home/modules/docker/lib/docker</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz /var/lib/docker/ /home/modules/docker/lib/</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>修改<code>/etc/systemd/system/docker.service.d/devicemapper.conf</code></p>
<p>查看<code>/etc/systemd/system/docker.service.d</code>目录及<code>devicemapper.conf</code>是否存在。如果不存在，就新建</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/systemd/system/docker.service.d/</span><br><span class="line"></span><br><span class="line">vi /etc/systemd/system/docker.service.d/devicemapper.conf</span><br></pre></td></tr></table></figure>
<p><code>devicemapper.conf</code>添加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/dockerd  --graph=/home/modules/docker/lib/docker</span><br></pre></td></tr></table></figure>
<h3 id="重启docker"><a href="#重启docker" class="headerlink" title="重启docker"></a>重启docker</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>
<h3 id="确认Docker-Root-Dir修改是否已经生效"><a href="#确认Docker-Root-Dir修改是否已经生效" class="headerlink" title="确认Docker Root Dir修改是否已经生效"></a>确认Docker Root Dir修改是否已经生效</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[root@user]#</span> docker info</span><br><span class="line">...</span><br><span class="line">Docker Root Dir: /home/modules/docker/lib/docker</span><br><span class="line">Debug Mode (client): false</span><br><span class="line">Debug Mode (server): false</span><br><span class="line">Registry: https://index.docker.io/v1/</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="启动成功后，再确认之前的镜像是否还在"><a href="#启动成功后，再确认之前的镜像是否还在" class="headerlink" title="启动成功后，再确认之前的镜像是否还在"></a>启动成功后，再确认之前的镜像是否还在</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[root@user]#</span> docker images</span><br></pre></td></tr></table></figure>
<h3 id="确定容器没问题后删除-var-lib-docker-目录中的文件"><a href="#确定容器没问题后删除-var-lib-docker-目录中的文件" class="headerlink" title="确定容器没问题后删除/var/lib/docker/目录中的文件"></a>确定容器没问题后删除/var/lib/docker/目录中的文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /var/lib/docker</span><br></pre></td></tr></table></figure>
</div></div><a class="button-hover more" href="/2019/03/28/解决Docker容器存放目录空间不足的问题/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2019/03/27/MySQL主从复制配置/">MySQL主从复制配置</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2019-03-28</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/mysql/">mysql</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/master/">master</a></div></div><div class="post-content"><div class="main-content content"><h1 id="MySQL主从复制配置"><a href="#MySQL主从复制配置" class="headerlink" title="MySQL主从复制配置"></a>MySQL主从复制配置</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p><strong>操作系统：</strong>CentOS-7</p>
<p><strong>MySQL：</strong>mysql-8.0.x</p>
<p><strong>一台主镜像和从镜像</strong></p>
<p><code>端口：15001　　master</code></p>
<p><code>端口：15002　　slave</code></p>
<p><code>端口：15003　　slave</code></p>
<p>使用<code>Dokcer</code>创建<code>master</code>和<code>slave</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon tmp]# docker run -d -p 15001:3306 --name mysql-master -e MYSQL_ROOT_PASSWORD=1230 mysql:latest</span><br><span class="line">253999e7938217a864d07c1ec974129872a91b8b4f1149132bbc71333390f4fd</span><br><span class="line">[root@bogon tmp]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                NAMES</span><br><span class="line">253999e79382        mysql:latest        "docker-entrypoint.s…"   37 seconds ago      Up 37 seconds       33060/tcp, 0.0.0.0:15001-&gt;3306/tcp   mysql-master</span><br><span class="line">d9fc4f74791a        mysql:latest        "docker-entrypoint.s…"   41 minutes ago      Up 20 minutes       0.0.0.0:3306-&gt;3306/tcp, 33060/tcp    mysql-base</span><br></pre></td></tr></table></figure>
<p>先别急着创建镜像，因为后面我们还需要加上一些配置</p>
<blockquote>
<p>说明：</p>
<p><code>-d</code> ： 后台启动</p>
<p><code>-p 15001:3306</code> ： 宿主机端口：容器端口(端口映射)</p>
<p><code>--name yours_name</code> ： 指定容器名</p>
<p><code>-e MYSQL_ROOT_PASSWORD=1230 mysql:latest</code> ：初始化参数</p>
<p>如果客户端连接时报错，需要修改密码：</p>
<p>使用<code>docker exec -it 容器名 bash</code>进入容器执行<code>bash</code>命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER USER &apos;root&apos;@&apos;%&apos; IDENTIFIED WITH mysql_native_password BY &apos;1230&apos;;</span><br></pre></td></tr></table></figure>
<p>将<code>root</code>密码修改为<code>1230</code>，之后再重新连接，就可以了</p>
<p><strong>没有<code>cnf</code>文件的配置</strong></p>
<p>许多配置选项可以作为标志传递给<code>mysqld</code>。这将使您可以灵活地自定义容器而无需<code>cnf</code>文件。例如，如果要更改所有表的默认编码和排序规则以使用<code>UTF-8（utf8mb4）</code>，只需运行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name some-mysql -e MYSQL_ROOT_PASSWORD=my-secret-pw -d mysql:tag --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci</span><br></pre></td></tr></table></figure>
<p>如果您想查看可用选项的完整列表，请运行：</p>
<p><code>docker run -it --rm mysql:tag --verbose --help</code></p>
<h2 id="主数据库配置"><a href="#主数据库配置" class="headerlink" title="主数据库配置"></a>主数据库配置</h2><h3 id="编辑-etc-my-cnf文件"><a href="#编辑-etc-my-cnf文件" class="headerlink" title="编辑/etc/my.cnf文件"></a>编辑<code>/etc/my.cnf</code>文件</h3><p>在[mysqld]下增加如下两行设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log-bin=mysql-bin # 非必需</span><br><span class="line">server-id=1　　　　# 必需</span><br></pre></td></tr></table></figure>
<p>但是在这里我们使用没有<code>cnf</code>文件的配置，通过<code>docker run -it --rm mysql:tag --verbose --help</code>我们查询到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Variables (--variable-name=value)</span><br><span class="line">and boolean options &#123;FALSE|TRUE&#125;                             Value (after reading options)</span><br><span class="line">------------------------------------------------------------ -------------</span><br><span class="line">...</span><br><span class="line">log-bin                                                      binlog</span><br><span class="line">...</span><br><span class="line">server-id                                                    1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>到这里你可以开始创建<code>master</code>了，命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 15001:3306 --name mysql-master -e MYSQL_ROOT_PASSWORD=1230 mysql:latest --server-id=1 --log-bin=master-bin --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci</span><br></pre></td></tr></table></figure>
<h3 id="创建用于数据同步的账户"><a href="#创建用于数据同步的账户" class="headerlink" title="创建用于数据同步的账户"></a>创建用于数据同步的账户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &apos;slave&apos;@&apos;172.17.0.%&apos; IDENTIFIED WITH mysql_native_password BY &apos;123456&apos;;</span><br><span class="line"></span><br><span class="line">GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO &apos;slave&apos;@&apos;172.17.0.%&apos;;</span><br><span class="line"></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<h3 id="查看master状态"><a href="#查看master状态" class="headerlink" title="查看master状态"></a>查看<code>master</code>状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;log_bin%&apos;;</span><br><span class="line">+---------------------------------+---------------------------------+</span><br><span class="line">| Variable_name                   | Value                           |</span><br><span class="line">+---------------------------------+---------------------------------+</span><br><span class="line">| log_bin                         | ON                              |</span><br><span class="line">| log_bin_basename                | /var/lib/mysql/master-bin       |</span><br><span class="line">| log_bin_index                   | /var/lib/mysql/master-bin.index |</span><br><span class="line">| log_bin_trust_function_creators | OFF                             |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF                             |</span><br><span class="line">+---------------------------------+---------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| master-bin.000004 |      913 |              |                  |                   |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="从数据库配置"><a href="#从数据库配置" class="headerlink" title="从数据库配置"></a>从数据库配置</h2><h3 id="编辑-etc-my-cnf文件-1"><a href="#编辑-etc-my-cnf文件-1" class="headerlink" title="编辑/etc/my.cnf文件"></a>编辑<code>/etc/my.cnf</code>文件</h3><p>设置<code>server-id</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br></pre></td></tr></table></figure>
<p>创建从镜像的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 15002:3306 --name mysql-slave01 -e MYSQL_ROOT_PASSWORD=1230 mysql:latest --server-id=2 --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci</span><br></pre></td></tr></table></figure>
<h3 id="执行同步语句"><a href="#执行同步语句" class="headerlink" title="执行同步语句"></a>执行同步语句</h3><p>同步语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=&apos;172.17.0.2&apos;, master_port=3306, master_user=&apos;slave&apos;, master_password=&apos;123456&apos;, master_log_file=&apos;master-bin.000004&apos;, master_log_pos=913,master_connect_retry=30;</span><br></pre></td></tr></table></figure>
<p><strong>参数说明：</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>master_host</code></td>
<td style="text-align:center"><code>Master</code>的地址，指的是容器的独立ip,可以通过总结提供的语句来查询</td>
</tr>
<tr>
<td style="text-align:center"><code>master_port</code></td>
<td style="text-align:center"><code>Master</code>的端口号，指的是容器的端口号</td>
</tr>
<tr>
<td style="text-align:center"><code>master_user</code></td>
<td style="text-align:center">用于数据同步的用户名</td>
</tr>
<tr>
<td style="text-align:center"><code>master_password</code></td>
<td style="text-align:center">用于同步的用户的密码</td>
</tr>
<tr>
<td style="text-align:center"><code>master_log_file</code></td>
<td style="text-align:center">指定 <code>Slave</code> 从哪个日志文件开始复制数据，即上文中提到的 <code>File</code> 字段的值</td>
</tr>
<tr>
<td style="text-align:center"><code>master_log_pos</code></td>
<td style="text-align:center">从哪个 <code>Position</code> 开始读，即上文中提到的 <code>Position</code> 字段的值</td>
</tr>
<tr>
<td style="text-align:center"><code>master_connect_retry</code></td>
<td style="text-align:center">如果连接失败，重试的时间间隔，单位是秒，默认是60秒</td>
</tr>
</tbody>
</table>
<p>查询容器的独立IP：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# docker inspect --format='&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;' mysql-master</span><br><span class="line">172.17.0.2</span><br><span class="line">[root@bogon ~]# docker inspect --format='&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;' mysql-slave01</span><br><span class="line">172.17.0.3</span><br></pre></td></tr></table></figure>
<h3 id="查看slave状态"><a href="#查看slave状态" class="headerlink" title="查看slave状态"></a>查看<code>slave</code>状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: </span><br><span class="line">                  Master_Host: 172.17.0.2</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 30</span><br><span class="line">              Master_Log_File: master-bin.000004</span><br><span class="line">          Read_Master_Log_Pos: 913</span><br><span class="line">               Relay_Log_File: c755400ecfa5-relay-bin.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: master-bin.000004</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 913</span><br><span class="line">              Relay_Log_Space: 155</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 2061</span><br><span class="line">                Last_IO_Error: error connecting to master &apos;slave@172.17.0.2:3306&apos; - retry-time: 30  r</span><br><span class="line">etries: 2</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 0</span><br><span class="line">                  Master_UUID: </span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: </span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: 190327 20:52:08</span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">       Master_public_key_path: </span><br><span class="line">        Get_master_public_key: 0</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>其中：</strong></p>
<p><code>Slave_IO_Running</code>: <code>No</code></p>
<p><code>Slave_SQL_Running</code>: <code>No</code></p>
</blockquote>
<p>这是因为我们还没有启动slave：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.17.0.2</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 30</span><br><span class="line">              Master_Log_File: master-bin.000004</span><br><span class="line">          Read_Master_Log_Pos: 913</span><br><span class="line">               Relay_Log_File: c755400ecfa5-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 323</span><br><span class="line">        Relay_Master_Log_File: master-bin.000004</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 913</span><br><span class="line">              Relay_Log_Space: 538</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: ebaef5cc-50cd-11e9-a01e-0242ac110002</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">       Master_public_key_path: </span><br><span class="line">        Get_master_public_key: 0</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果：<code>Slave_SQL_Running: No</code></p>
</blockquote>
<p>解决：</p>
<ol>
<li><p>程序可能在slave上进行了写操作，也可能是slave机器重启后，事务的回滚造成的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop slave;</span><br><span class="line">mysql&gt; set global sql_slave_skip_counter=1;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新执行同步语句，但注意这样需要停止master的写操作</p>
</li>
</ol>
<p>另外一个从镜像也是这样设置，只需将端口号更改一下</p>
<h2 id="验证是否同步成功"><a href="#验证是否同步成功" class="headerlink" title="验证是否同步成功"></a>验证是否同步成功</h2><p>在主数据库上操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database test;</span><br><span class="line">Query OK, 1 row affected (0.11 sec)</span><br></pre></td></tr></table></figure>
<p>从库中查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>成功~~~</p>
<h2 id="从库设置只读账户"><a href="#从库设置只读账户" class="headerlink" title="从库设置只读账户"></a>从库设置只读账户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user &apos;readonly&apos;@&apos;%&apos; identified with mysql_native_password by &apos;110&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant select on test.* to &apos;readonly&apos;@&apos;%&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​    在执行同步语句时，一定要注意<code>master_host</code>要指定容器的独立ip，独立IP可通过以下命令来查询：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect --format='&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;' 容器名称/容器id</span><br></pre></td></tr></table></figure></div></div><a class="button-hover more" href="/2019/03/27/MySQL主从复制配置/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2019/03/26/认识JWT/">认识JWT</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2019-03-26</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/security/">security</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/jwt/">jwt</a></div></div><div class="post-content"><div class="main-content content"><h1 id="JWT-JSON-Web-Token"><a href="#JWT-JSON-Web-Token" class="headerlink" title="JWT(JSON Web Token)"></a>JWT(JSON Web Token)</h1><p>​    JSON Web Token (JWT)是一个开放标准(RFC 7519)，它定义了一种紧凑的、自包含的方式，用于作为JSON对象在各方之间安全地传输信息。该信息可以被验证和信任，因为它是数字签名的。</p>
<h2 id="什么时候你应该用JSON-Web-Tokens"><a href="#什么时候你应该用JSON-Web-Tokens" class="headerlink" title="什么时候你应该用JSON Web Tokens"></a>什么时候你应该用JSON Web Tokens</h2><p>下列场景中使用JSON Web Token是很有用的：</p>
<ul>
<li><strong>Authorization</strong> (授权) : 这是使用JWT的最常见场景。一旦用户登录，后续每个请求都将包含JWT，允许用户访问该令牌允许的路由、服务和资源。单点登录是现在广泛使用的JWT的一个特性，因为它的开销很小，并且可以轻松地跨域使用。</li>
<li><strong>Information Exchange</strong> (信息交换) : 对于安全的在各方之间传输信息而言，JSON Web Tokens无疑是一种很好的方式。因为JWTs可以被签名，例如，用公钥/私钥对，你可以确定发送人就是它们所说的那个人。另外，由于签名是使用头和有效负载计算的，您还可以验证内容没有被篡改。</li>
</ul>
<h2 id="JSON-Web-Token的结构是什么样的"><a href="#JSON-Web-Token的结构是什么样的" class="headerlink" title="JSON Web Token的结构是什么样的"></a>JSON Web Token的结构是什么样的</h2><p>JSON Web Token由三部分组成，它们之间用圆点(.)连接。这三部分分别是：</p>
<ul>
<li>Header</li>
<li>Payload</li>
<li>Signature</li>
</ul>
<p>因此，一个典型的JWT看起来是这个样子的：</p>
<p>xxxxx.yyyyy.zzzzz</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p><code>header</code>典型的由两部分组成：<code>token</code>的类型（“JWT”）和算法名称（比如：<code>HMAC</code> <code>SHA256</code>或者<code>RSA</code>等等）。</p>
<p>例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"alg"</span>:<span class="string">"HS256"</span>,</span><br><span class="line">    <span class="attr">"typ"</span>:<span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p>JWT的第二部分是<code>payload</code>，它包含声明（要求）。声明是关于实体(通常是用户)和其他数据的声明。声明有三种类型: <code>registered</code>, <code>public</code> 和 <code>private</code>。</p>
<ul>
<li><code>Registered claims</code> : 这里有一组预定义的声明，它们不是强制的，但是推荐。比如：<code>iss (issuer)</code>, <code>exp (expiration time)</code>, <code>sub (subject)</code>, <code>aud (audience)</code>等。</li>
<li>Public claims : 可以随意定义。</li>
<li>Private claims : 用于在同意使用它们的各方之间共享信息，并且不是注册的或公开的声明。</li>
</ul>
<p>下面是一个例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"sub"</span>:<span class="string">"1234567890"</span>,</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"Tom"</span>,</span><br><span class="line">    <span class="attr">"admin"</span>:<span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对<code>payload</code>进行<code>Base64</code>编码就得到JWT的第二部分</p>
<blockquote>
<p>注意：不要在JWT的payload或者header中放置敏感信息，除非它们是加密的</p>
</blockquote>
<h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><p>为了得到签名部分，你必须有编码过的header、编码过的payload、一个秘钥，签名算法是header中指定的那个，然对它们签名即可。</p>
<p>例如：</p>
<p><code>HMACSHA256(base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload), secret)</code></p>
<p>签名是用于验证消息在传递过程中有没有被更改，并且，对于使用私钥签名的token，它还可以验证JWT的发送方是否为它所称的发送方。</p>
<p>看一张官网的图就明白了：</p>
<p><img src="/images/认识JWT-图1.png" alt="图1"></p>
<h2 id="JSON-Web-Tokens是如何工作的"><a href="#JSON-Web-Tokens是如何工作的" class="headerlink" title="JSON Web Tokens是如何工作的"></a>JSON Web Tokens是如何工作的</h2><p>在认证的时候，当用户用他们的凭证成功登录以后，一个JSON Web Token将会被返回。此后，token就是用户凭证了，你必须非常小心以防止出现安全问题。一般而言，你保存令牌的时候不应该超过你所需要它的时间。</p>
<p>无论何时用户想要访问受保护的路由或者资源的时候，用户代理（通常是浏览器）都应该带上JWT，典型的，通常放在Authorization header中，用Bearer schema。</p>
<p>header应该看起来是这样的：</p>
<p><code>Authorization: Bearer &lt;token&gt;</code></p>
<p>服务器上的受保护的路由将会检查Authorization header中的JWT是否有效，如果有效，则用户可以访问受保护的资源。如果JWT包含足够多的必需的数据，那么就可以减少对某些操作的数据库查询的需要，尽管可能并不总是如此。</p>
<p>如果token是在授权头（Authorization header）中发送的，那么跨源资源共享(CORS)将不会成为问题，因为它不使用cookie。</p>
<p>下面这张图显示了如何获取JWT以及使用它来访问APIs或者资源：</p>
<p><img src="/images/认识JWT-图2.png" alt="图2"></p>
<ol>
<li>应用（或者客户端）想授权服务器请求授权。例如，如果用授权码流程的话，就是/oauth/authorize</li>
<li>当授权被许可以后，授权服务器返回一个access token给应用</li>
<li>应用使用access token访问受保护的资源（比如：API）</li>
</ol>
<h2 id="基于Token的身份认证-与-基于服务器的身份认证"><a href="#基于Token的身份认证-与-基于服务器的身份认证" class="headerlink" title="基于Token的身份认证 与 基于服务器的身份认证"></a>基于Token的身份认证 与 基于服务器的身份认证</h2><h3 id="基于服务器的身份认证"><a href="#基于服务器的身份认证" class="headerlink" title="基于服务器的身份认证"></a>基于服务器的身份认证</h3><p>在讨论基于Token的身份认证是如何工作的以及它的好处之前，我们先来看一下以前我们是怎么做的：</p>
<blockquote>
<p>HTTP协议是无状态的，也就是说，如果我们已经认证了一个用户，那么他下一次请求的时候，服务器不知道我是谁，我们必须再次认证</p>
</blockquote>
<p>传统的做法是将已经认证过的用户信息存储在服务器上，比如Session。用户下次请求的时候带着Session ID，然后服务器以此检查用户是否认证过。</p>
<p>这种基于服务器的身份认证方式存在一些问题：</p>
<ul>
<li>Sessions : 每次用户认证通过以后，服务器需要创建一条记录保存用户信息，通常是在内存中，随着认证通过的用户越来越多，服务器的在这里的开销就会越来越大。</li>
<li>Scalability : 由于Session是在内存中的，这就带来一些扩展性的问题。</li>
<li>CORS : 当我们想要扩展我们的应用，让我们的数据被多个移动设备使用时，我们必须考虑跨资源共享问题。当使用AJAX调用从另一个域名下获取资源时，我们可能会遇到禁止请求的问题。</li>
<li>CSRF : 用户很容易受到CSRF攻击。</li>
</ul>
<h3 id="JWT与Session的差异"><a href="#JWT与Session的差异" class="headerlink" title="JWT与Session的差异"></a>JWT与Session的差异</h3><p>相同点是，它们都是存储用户信息；然而，Session是在服务器端的，而JWT是在客户端的。</p>
<p>Session方式存储用户信息的最大问题在于要占用大量服务器内存，增加服务器的开销。</p>
<p>而JWT方式将用户状态分散到了客户端中，可以明显减轻服务端的内存压力。</p>
<p>Session的状态是存储在服务器端，客户端只有session id；而Token的状态是存储在客户端。</p>
<p><img src="/images/认识JWT-图3.png" alt="图3"></p>
<h3 id="基于Token的身份认证是如何工作的"><a href="#基于Token的身份认证是如何工作的" class="headerlink" title="基于Token的身份认证是如何工作的"></a>基于Token的身份认证是如何工作的</h3><p>基于Token的身份认证是无状态的，服务器或者Session中不会存储任何用户信息。</p>
<blockquote>
<p>没有会话信息意味着应用程序可以根据需要扩展和添加更多的机器，而不必担心用户登录的位置。</p>
</blockquote>
<p>虽然这一实现可能会有所不同，但其主要流程如下：</p>
<ol>
<li>用户携带用户名和密码请求访问</li>
<li>服务器校验用户凭据</li>
<li>应用提供一个token给客户端</li>
<li>客户端存储token，并且在随后的每一次请求中都带着它</li>
<li>服务器校验token并返回数据</li>
</ol>
<p>注意：</p>
<ol>
<li>每一次请求都需要token</li>
<li>Token应该放在请求<code>header</code>中</li>
<li>我们还需要将服务器设置为接受来自所有域的请求，用<code>Access-Control-Allow-Origin: *</code></li>
</ol>
<h3 id="用Token的好处"><a href="#用Token的好处" class="headerlink" title="用Token的好处"></a>用Token的好处</h3><ul>
<li>无状态和可扩展性：Tokens存储在客户端。完全无状态，可扩展。我们的负载均衡器可以将用户传递到任意服务器，因为在任何地方都没有状态或会话信息。</li>
<li>安全：Token不是Cookie。（The token, not a cookie.）每次请求的时候Token都会被发送。而且，由于没有Cookie被发送，还有助于防止CSRF攻击。即使在你的实现中将token存储到客户端的Cookie中，这个Cookie也只是一种存储机制，而非身份认证机制。没有基于会话的信息可以操作，因为我们没有会话!</li>
</ul>
<p>还有一点，token在一段时间以后会过期，这个时候用户需要重新登录。这有助于我们保持安全。还有一个概念叫token撤销，它允许我们根据相同的授权许可使特定的token甚至一组token无效。</p>
<h3 id="JWT与OAuth的区别"><a href="#JWT与OAuth的区别" class="headerlink" title="JWT与OAuth的区别"></a>JWT与OAuth的区别</h3><ol>
<li>OAuth2是一种授权框架 ，JWT是一种认证协议</li>
<li>无论使用哪种方式切记用HTTPS来保证数据的安全性</li>
<li>OAuth2用在使用第三方账号登录的情况(比如使用weibo, qq, github登录某个app)，而<strong>JWT是用在前后端分离</strong>, 需要简单的对后台API进行保护时使用。</li>
</ol>
</div></div><a class="button-hover more" href="/2019/03/26/认识JWT/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2019/03/26/基于2.2.x的SpringCloudGateway/">基于2.2.x的SpringCloudGateway</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2019-03-26</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/springcloud/">springcloud</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/routing/">routing</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/gateway/">gateway</a></div></div><div class="post-content"><div class="main-content content"><h1 id="Spring-Cloud-Gateway"><a href="#Spring-Cloud-Gateway" class="headerlink" title="Spring Cloud Gateway"></a>Spring Cloud Gateway</h1><p><strong>2.2.0.BUILD-快照</strong></p>
<p>该项目提供了一个建立在Spring Ecosystem之上的API网关，包括：Spring 5，Spring Boot 2和Project Reactor。Spring Cloud Gateway旨在提供一种简单而有效的方式来路由到API，并为他们提供横切关注点，例如：安全性，监控/指标和弹性。</p>
<h2 id="如何包含Spring-Cloud-Gateway"><a href="#如何包含Spring-Cloud-Gateway" class="headerlink" title="如何包含Spring Cloud Gateway"></a>如何包含Spring Cloud Gateway</h2><p>要在项目中包含Spring Cloud Gateway，请使用具有组<code>org.springframework.cloud</code> 和工件ID 的启动器<code>spring-cloud-starter-gateway</code>。有关 使用当前Spring Cloud Release Train设置构建系统的详细信息，请参阅<a href="https://projects.spring.io/spring-cloud/" target="_blank" rel="noopener">Spring Cloud Project页面</a>。</p>
<p>如果包含启动器，但由于某种原因，您不希望启用网关，请进行设置<code>spring.cloud.gateway.enabled=false</code>。</p>
<blockquote>
<p>Spring Cloud Gateway基于<a href="https://spring.io/projects/spring-boot#learn" target="_blank" rel="noopener">Spring Boot 2.0</a>， <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" target="_blank" rel="noopener">Spring WebFlux</a>和<a href="https://projectreactor.io/docs" target="_blank" rel="noopener">Project Reactor </a><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" target="_blank" rel="noopener">构建</a>。因此，许多熟悉的同步库（例如Spring Data和Spring Security）和模式在使用Spring Cloud Gateway时可能不适用。如果您不熟悉这些项目，我们建议您在使用Spring Cloud Gateway之前先阅读他们的文档以熟悉一些新概念。</p>
</blockquote>
<blockquote>
<p>Spring Cloud Gateway需要Spring Boot和Spring Webflux提供的Netty运行时。它不能在传统的Servlet容器中工作或构建为WAR。</p>
</blockquote>
<h2 id="词汇表"><a href="#词汇表" class="headerlink" title="词汇表"></a>词汇表</h2><ul>
<li><strong>Route</strong>: 路由网关的基本构建块。它由ID，目标URI，谓词集合和过滤器集合定义。如果聚合谓词为真，则匹配路由。</li>
<li><strong>Predicate</strong>: 这是一个<a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html" target="_blank" rel="noopener">Java 8函数谓词</a>。输入类型是<a href="https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/server/ServerWebExchange.html" target="_blank" rel="noopener">Spring Framework<code>ServerWebExchange</code></a>。这允许开发人员匹配来自HTTP请求的任何内容，例如标头或参数。</li>
<li><strong>Filter</strong>: 这是使用特定工厂构建的<a href="https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/server/GatewayFilter.html" target="_blank" rel="noopener">Spring Framework<code>GatewayFilter</code></a>实例。这里，可以在发送下游请求之前或之后修改请求和响应。</li>
</ul>
<h2 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h2><p><img src="/images/基于2.2.x的SpringCloudGateway-图1.png" alt="运行原理"></p>
<p>客户端向Spring Cloud Gateway发出请求。如果网关处理程序映射确定请求与路由匹配，则将其发送到网关Web处理程序。此处理程序运行通过特定于请求的过滤器链发送请求。滤波器被虚线划分的原因是滤波器可以在发送代理请求之前或之后执行逻辑。执行所有“预”过滤器逻辑，然后进行代理请求。在发出代理请求之后，执行“post”过滤器逻辑。</p>
<blockquote>
<p>在没有端口的路由中定义的URI将分别为HTTP和HTTPS URI获取默认端口设置为80和443。</p>
</blockquote>
<h2 id="Route-Predicate-Factories"><a href="#Route-Predicate-Factories" class="headerlink" title="Route Predicate Factories"></a>Route Predicate Factories</h2><p>Spring Cloud Gateway将路由作为Spring WebFlux <code>HandlerMapping</code>基础结构的一部分进行匹配。Spring Cloud Gateway包含许多内置的Route Predicate工厂。所有这些谓词都匹配HTTP请求的不同属性。多路线谓词工厂可以组合并通过逻辑组合<code>and</code>。</p>
<h3 id="After"><a href="#After" class="headerlink" title="After"></a>After</h3><p>After Route谓词工厂采用一个参数，一个日期时间。此谓词匹配在当前日期时间之后发生的请求。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">after_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">After=2017-01-20T17:42:47.789-07:00[America/Denver]</span></span><br></pre></td></tr></table></figure>
<p>此路由在2017年1月20日17:42 Mountain Time（Denver）之后的所有请求相匹配。</p>
<h3 id="Before"><a href="#Before" class="headerlink" title="Before"></a>Before</h3><p>Before Route Predicate Factory采用一个参数，一个日期时间。此谓词匹配在当前日期时间之前发生的请求。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">before_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Before=2017-01-20T17:42:47.789-07:00[America/Denver]</span></span><br></pre></td></tr></table></figure>
<p>此路由在2017年1月20日17:42 Mountain Time（Denver）之前的任何请求相匹配。</p>
<h3 id="Between"><a href="#Between" class="headerlink" title="Between"></a>Between</h3><p>Between Route Predicate Factory有两个参数，datetime1和datetime2。此谓词匹配datetime1之后和datetime2之前发生的请求。datetime2参数必须在datetime1之后。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">between_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Between=2017-01-20T17:42:47.789-07:00[America/Denver],</span> <span class="number">2017</span><span class="bullet">-01</span><span class="bullet">-21</span><span class="attr">T17:42:47.789-07:00[America/Denver]</span></span><br></pre></td></tr></table></figure>
<p>此路路由在2017年1月20日17:42山地时间（丹佛）之后和2017年1月21日17:42山区时间（丹佛）之前的任何请求相匹配。这对维护窗口很有用。</p>
<h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><p>Cookie Route Predicate Factory有两个参数，cookie名称和正则表达式。此谓词匹配具有给定名称且值与正则表达式匹配的cookie。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">cookie_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Cookie=chocolate,</span> <span class="string">ch.p</span></span><br></pre></td></tr></table></figure>
<p>此路由匹配请求具有名为<code>chocolate</code>who的值与<code>ch.p</code>正则表达式匹配的cookie 。</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Header Route谓词工厂采用两个参数，标题名称和正则表达式。此谓词与具有给定名称且值与正则表达式匹配的标头匹配。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">header_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></span><br></pre></td></tr></table></figure>
<p>如果请求具有名称，<code>X-Request-Id</code>其值与<code>\d+</code>正则表达式匹配（具有一个或多个数字的值），则此路由匹配。</p>
<h3 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h3><p>Host Route Predicate Factory采用一个参数：主机名模式列表。该模式是一个Ant样式模式，<code>.</code>作为分隔符。此谓词匹配<code>Host</code>与模式匹配的标头。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">host_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Host=**.somehost.org,**.anotherhost.org</span></span><br></pre></td></tr></table></figure>
<p>如果请求的<code>Host</code>标头具有值<code>www.somehost.org</code>或<code>beta.somehost.org</code>或<code>www.anotherhost.org</code>，则此路由将匹配。</p>
<p>此谓词将URI模板变量（<code>sub</code>如上例中定义的）提取为名称和值的映射，并将其放在<code>ServerWebExchange.getAttributes()</code>带有定义的键的位置<code>ServerWebExchangeUtils.URI_TEMPLATE_VARIABLES_ATTRIBUTE</code>。然后，这些值可供<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#gateway-route-filters" target="_blank" rel="noopener">GatewayFilter Factories使用</a></p>
<h3 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h3><p>Method Route Predicate Factory采用一个参数：要匹配的HTTP方法。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">method_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Method=GET</span></span><br></pre></td></tr></table></figure>
<p>如果请求方法是<code>GET</code>，则此路由将匹配。</p>
<h3 id="Path"><a href="#Path" class="headerlink" title="Path"></a>Path</h3><p>Path Route Predicate Factory有两个参数：Spring <code>PathMatcher</code>模式列表和一个可选标志<code>matchOptionalTrailingSeparator</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">host_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/foo/&#123;segment&#125;,/bar/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果请求路径是例如：<code>/foo/1</code>或<code>/foo/bar</code>或<code>/bar/baz</code>，则此路由将匹配。</p>
<p>此Predicate将URI模板变量（<code>segment</code>如上例中定义的）提取为名称和值的映射，并将其放在<code>ServerWebExchange.getAttributes()</code>带有定义的键的位置<code>ServerWebExchangeUtils.URI_TEMPLATE_VARIABLES_ATTRIBUTE</code>。然后，这些值可供<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#gateway-route-filters" target="_blank" rel="noopener">GatewayFilter Factories使用</a></p>
<p>可以使用实用程序方法来更轻松地访问这些变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; uriVariables = ServerWebExchangeUtils.getPathPredicateVariables(exchange);</span><br><span class="line"></span><br><span class="line">String segment = uriVariables.get(<span class="string">"segment"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h3><p>Query Route Predicate Factory有两个参数：必需<code>param</code>和可选<code>regexp</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">query_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Query=baz</span></span><br></pre></td></tr></table></figure>
<p>如果请求包含<code>baz</code>查询参数，则此路由将匹配。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">query_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Query=foo,</span> <span class="string">ba.</span></span><br></pre></td></tr></table></figure>
<p>如果请求包含<code>foo</code>其值为<code>ba.</code>regexp 匹配的查询参数，则此路由将匹配，因此<code>bar</code>并且<code>baz</code>将匹配。</p>
<h3 id="RemoteAddr"><a href="#RemoteAddr" class="headerlink" title="RemoteAddr"></a>RemoteAddr</h3><p>RemoteAddr Route Predicate Factory采用CIDR符号（IPv4或IPv6）字符串的列表（最小值为1），例如<code>192.168.0.1/16</code>（其中<code>192.168.0.1</code>是IP地址并且<code>16</code>是子网掩码）。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">remoteaddr_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RemoteAddr=192.168.1.1/24</span></span><br></pre></td></tr></table></figure>
<p>例如，如果请求的远程地址是<code>192.168.1.10</code>，则此路由将匹配。</p>
<h4 id="修改远程地址的解析方式"><a href="#修改远程地址的解析方式" class="headerlink" title="修改远程地址的解析方式"></a>修改远程地址的解析方式</h4><p>默认情况下，RemoteAddr Route Predicate Factory使用传入请求中的远程地址。如果Spring Cloud Gateway位于代理层后面，则可能与实际客户端IP地址不匹配。</p>
<p>您可以通过设置自定义来自定义解析远程地址的方式<code>RemoteAddressResolver</code>。春季云网关来与基于关闭的一个非默认的远程地址解析器<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For" target="_blank" rel="noopener">X -转发，对于头</a>，<code>XForwardedRemoteAddressResolver</code>。</p>
<p><code>XForwardedRemoteAddressResolver</code> 有两个静态构造函数方法，采用不同的安全方法：</p>
<p><code>XForwardedRemoteAddressResolver::trustAll</code>返回一个<code>RemoteAddressResolver</code>始终采用<code>X-Forwarded-For</code>标头中找到的第一个IP地址的a 。这种方法容易受到欺骗，因为恶意客户端可以设置<code>X-Forwarded-For</code>解析器可以接受的初始值。</p>
<p><code>XForwardedRemoteAddressResolver::maxTrustedIndex</code>获取与Spring Cloud Gateway前运行的可信基础架构数量相关的索引。例如，如果只能通过HAProxy访问Spring Cloud Gateway，则应使用值1。如果在可访问Spring Cloud Gateway之前需要两跳可信基础架构，则应使用值2。</p>
<p>给出以下标头值：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: 0.0.0.1, 0.0.0.2, 0.0.0.3</span><br></pre></td></tr></table></figure>
<p>以下<code>maxTrustedIndex</code>值将产生以下远程地址。</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>maxTrustedIndex</code></th>
<th style="text-align:center">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">[ <code>Integer.MIN_VALUE</code>，0]</td>
<td style="text-align:center">（<code>IllegalArgumentException</code>初始化期间无效）</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">0.0.0.3</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">0.0.0.2</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">0.0.0.1</td>
</tr>
<tr>
<td style="text-align:center">[4，<code>Integer.MAX_VALUE</code>]</td>
<td style="text-align:center">0.0.0.1</td>
</tr>
</tbody>
</table>
<p>使用Java配置：</p>
<p>GatewayConfig.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RemoteAddressResolver resolver = XForwardedRemoteAddressResolver</span><br><span class="line">    .maxTrustedIndex(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">.route(<span class="string">"direct-route"</span>,</span><br><span class="line">    r -&gt; r.remoteAddr(<span class="string">"10.1.1.1"</span>, <span class="string">"10.10.1.1/24"</span>)</span><br><span class="line">        .uri(<span class="string">"https://downstream1"</span>)</span><br><span class="line">.route(<span class="string">"proxied-route"</span>,</span><br><span class="line">    r -&gt; r.remoteAddr(resolver,  <span class="string">"10.10.1.1"</span>, <span class="string">"10.10.1.1/24"</span>)</span><br><span class="line">        .uri(<span class="string">"https://downstream2"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="Gateway-Filter-Factory"><a href="#Gateway-Filter-Factory" class="headerlink" title="Gateway Filter Factory"></a>Gateway Filter Factory</h2><p>路由过滤器允许以某种方式修改传入的HTTP请求或传出的HTTP响应。路径过滤器的范围限定为特定路径。Spring Cloud Gateway包含许多内置的GatewayFilter工厂。</p>
<p>注意有关如何使用以下任何过滤器的更详细示例，请查看<a href="https://github.com/spring-cloud/spring-cloud-gateway/tree/master/spring-cloud-gateway-core/src/test/java/org/springframework/cloud/gateway/filter/factory" target="_blank" rel="noopener">单元测试</a>。</p>
<h3 id="AddRequestHeader"><a href="#AddRequestHeader" class="headerlink" title="AddRequestHeader"></a>AddRequestHeader</h3><p>AddRequestHeader GatewayFilter Factory采用名称和值参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">add_request_header_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">AddRequestHeader=X-Request-Foo,</span> <span class="string">Bar</span></span><br></pre></td></tr></table></figure>
<p>这将为所有匹配请求的下游请求标头添加<code>X-Request-Foo:Bar</code>标头。</p>
<h3 id="AddRequestParameter"><a href="#AddRequestParameter" class="headerlink" title="AddRequestParameter"></a>AddRequestParameter</h3><p>AddRequestParameter GatewayFilter Factory采用名称和值参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">add_request_parameter_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">AddRequestParameter=foo,</span> <span class="string">bar</span></span><br></pre></td></tr></table></figure>
<p>这将为所有匹配请求添加下游请求的查询字符串<code>foo=bar</code>。</p>
<h3 id="AddResponseHeader"><a href="#AddResponseHeader" class="headerlink" title="AddResponseHeader"></a>AddResponseHeader</h3><p>AddResponseHeader GatewayFilter Factory采用名称和值参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">add_response_header_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">AddResponseHeader=X-Response-Foo,</span> <span class="string">Bar</span></span><br></pre></td></tr></table></figure>
<h3 id="DedupeResponseHeader"><a href="#DedupeResponseHeader" class="headerlink" title="DedupeResponseHeader"></a>DedupeResponseHeader</h3><p>DedupeResponseHeader GatewayFilter Factory接受<code>name</code>参数和可选<code>strategy</code>参数。<code>name</code>可以包含标题名称列表，空格分隔。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">dedupe_response_header_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">DedupeResponseHeader=Access-Control-Allow-Credentials</span> <span class="string">Access-Control-Allow-Origin</span></span><br></pre></td></tr></table></figure>
<p>在网关CORS逻辑和下游添加它们的情况下，这将删除重复的值<code>Access-Control-Allow-Credentials</code>和<code>Access-Control-Allow-Origin</code>响应头。</p>
<p>DedupeResponseHeader过滤器还接受可选<code>strategy</code>参数。接受的值是<code>RETAIN_FIRST</code>（默认）、<code>RETAIN_LAST</code>和<code>RETAIN_UNIQUE</code>。</p>
<h3 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h3><p><a href="https://github.com/Netflix/Hystrix" target="_blank" rel="noopener">Hystrix</a>是Netflix的一个库，它实现了<a href="https://martinfowler.com/bliki/CircuitBreaker.html" target="_blank" rel="noopener">断路器模式</a>。Hystrix GatewayFilter允许您将断路器引入网关路由，保护您的服务免受级联故障的影响，并允许您在下游故障时提供回退响应。</p>
<p>要在项目中启用Hystrix GatewayFilters，请<code>spring-cloud-starter-netflix-hystrix</code>从<a href="https://cloud.spring.io/spring-cloud-netflix/" target="_blank" rel="noopener">Spring Cloud Netflix</a>添加依赖项。</p>
<p>Hystrix GatewayFilter Factory需要一个<code>name</code>参数，即该参数的名称<code>HystrixCommand</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">hystrix_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Hystrix=myCommandName</span></span><br></pre></td></tr></table></figure>
<p>这将<code>HystrixCommand</code>使用命令名称包装剩余的过滤器<code>myCommandName</code>。</p>
<p>Hystrix过滤器也可以接受可选<code>fallbackUri</code>参数。目前，仅<code>forward:</code>支持计划的URI。如果调用了回退，则请求将被转发到与URI匹配的控制器。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">hystrix_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">lb://backing-service:8088</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/consumingserviceendpoint</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">Hystrix</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">fallbackcmd</span></span><br><span class="line"><span class="attr">            fallbackUri:</span> <span class="attr">forward:/incaseoffailureusethis</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RewritePath=/consumingserviceendpoint,</span> <span class="string">/backingserviceendpoint</span></span><br></pre></td></tr></table></figure>
<p>这将<code>/incaseoffailureusethis</code>在调用Hystrix回退时转发到URI。请注意，此示例还通过<code>lb</code>目标URI 上的前缀演示（可选）Spring Cloud Netflix Ribbon负载平衡。</p>
<p>主要方案是使用<code>fallbackUri</code>网关应用程序中的内部控制器或处理程序。但是，也可以将请求重新路由到外部应用程序中的控制器或处理程序，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">ingredients</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">lb://ingredients</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=//ingredients/**</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">Hystrix</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">fetchIngredients</span></span><br><span class="line"><span class="attr">            fallbackUri:</span> <span class="attr">forward:/fallback</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">ingredients-fallback</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:9994</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/fallback</span></span><br></pre></td></tr></table></figure>
<p>在此示例中，<code>fallback</code>网关应用程序中没有端点或处理程序，但是，在另一个应用程序中有一个，在其下注册<code>http://localhost:9994</code>。</p>
<p>如果请求被转发到回退，Hystrix网关过滤器也会提供<code>Throwable</code>导致它的原因。它被添加到<code>ServerWebExchange</code>作为<code>ServerWebExchangeUtils.HYSTRIX_EXECUTION_EXCEPTION_ATTR</code>在网关应用程序中处理回退时可以使用的 属性。</p>
<p>对于外部控制器/处理程序方案，可以添加包含异常详细信息的标头。您可以在<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#fallback-headers" target="_blank" rel="noopener">FallbackHeaders GatewayFilter Factory部分中</a>找到有关它的更多信息。</p>
<p>Hystrix设置（例如超时）可以使用全局默认值配置，也可以使用应用程序属性逐个路径配置，如<a href="https://github.com/Netflix/Hystrix/wiki/Configuration" target="_blank" rel="noopener">Hystrix wiki中所述</a>。</p>
<p>要为上面的示例路由设置5秒超时，将使用以下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">hystrix.command.fallbackcmd.execution.isolation.thread.timeoutInMilliseconds:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>
<h3 id="FallbackHeaders"><a href="#FallbackHeaders" class="headerlink" title="FallbackHeaders"></a>FallbackHeaders</h3><p>该<code>FallbackHeaders</code>工厂可以让你在转发到请求的头部添加猬执行异常的详细信息<code>fallbackUri</code>在以下情况下在外部应用程序，如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">ingredients</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">lb://ingredients</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=//ingredients/**</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">Hystrix</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">fetchIngredients</span></span><br><span class="line"><span class="attr">            fallbackUri:</span> <span class="attr">forward:/fallback</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">ingredients-fallback</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:9994</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/fallback</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">FallbackHeaders</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            executionExceptionTypeHeaderName:</span> <span class="string">Test-Header</span></span><br></pre></td></tr></table></figure>
<p>在此示例中，在运行执行异常后<code>HystrixCommand</code>，请求将被转发到<code>fallback</code>运行的应用程序中的端点或处理程序<code>localhost:9994</code>。具有异常类型，消息和-if available-root的标头将导致异常类型和消息被<code>FallbackHeaders</code>过滤器添加到该请求中。</p>
<p>通过设置下面列出的参数的值及其默认值，可以在配置中覆盖标头的名称：</p>
<ul>
<li><code>executionExceptionTypeHeaderName</code>（<code>&quot;Execution-Exception-Type&quot;</code>）</li>
<li><code>executionExceptionMessageHeaderName</code>（<code>&quot;Execution-Exception-Message&quot;</code>）</li>
<li><code>rootCauseExceptionTypeHeaderName</code>（<code>&quot;Root-Cause-Exception-Type&quot;</code>）</li>
<li><code>rootCauseExceptionMessageHeaderName</code>（<code>&quot;Root-Cause-Exception-Message&quot;</code>）</li>
</ul>
<p>您可以在<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#hystrix" target="_blank" rel="noopener">Hystrix GatewayFilter Factory部分中</a>找到有关Hystrix如何与Gateway配合使用的更多信息。</p>
<h3 id="PrefixPath"><a href="#PrefixPath" class="headerlink" title="PrefixPath"></a>PrefixPath</h3><p>PrefixPath GatewayFilter Factory采用单个<code>prefix</code>参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">prefixpath_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">PrefixPath=/mypath</span></span><br></pre></td></tr></table></figure>
<p>这将为<code>/mypath</code>所有匹配请求的路径添加前缀。所以请求<code>/hello</code>，将发送给<code>/mypath/hello</code>。</p>
<h3 id="PreserveHostHeader"><a href="#PreserveHostHeader" class="headerlink" title="PreserveHostHeader"></a>PreserveHostHeader</h3><p>PreserveHostHeader GatewayFilter Factory没有参数。此过滤器设置路由过滤器将检查的请求属性，以确定是否应发送原始主机头，而不是http客户端确定的主机头。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">preserve_host_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">PreserveHostHeader</span></span><br></pre></td></tr></table></figure>
<h3 id="RequestRateLimiter"><a href="#RequestRateLimiter" class="headerlink" title="RequestRateLimiter"></a>RequestRateLimiter</h3><p>RequestRateLimiter GatewayFilter Factory使用<code>RateLimiter</code>实现来确定是否允许当前请求继续。如果不是，<code>HTTP 429 - Too Many Requests</code>则返回（默认情况下）状态。</p>
<p>此过滤器采用<code>keyResolver</code>特定于速率限制器的可选参数和参数（参见下文）。</p>
<p><code>keyResolver</code>是一个实现<code>KeyResolver</code>接口的bean 。在配置中，使用SpEL按名称引用bean。<code>#{@myKeyResolver}</code>是一个引用具有名称的bean的SpEL表达式<code>myKeyResolver</code>。</p>
<p><strong>KeyResolver.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KeyResolver</span> </span>&#123;</span><br><span class="line">	<span class="function">Mono&lt;String&gt; <span class="title">resolve</span><span class="params">(ServerWebExchange exchange)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该<code>KeyResolver</code>接口允许可插拔策略导出用于限制请求的密钥。在未来的里程碑中，将会有一些<code>KeyResolver</code>实现。</p>
<p>默认实现<code>KeyResolver</code>是从和调用中<code>PrincipalNameKeyResolver</code>检索。<code>Principal`</code>ServerWebExchange<code></code>Principal.getName()`</p>
<p>默认情况下，如果<code>KeyResolver</code>找不到密钥，将拒绝请求。可以使用<code>spring.cloud.gateway.filter.request-rate-limiter.deny-empty-key</code>（true或false）和<code>spring.cloud.gateway.filter.request-rate-limiter.empty-key-status-code</code>属性调整此行为。</p>
<blockquote>
<p>RequestRateLimiter不能通过“快捷方式”表示法进行配置。以下示例<em>无效</em></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#INVALID SHORTCUT CONFIGURATION spring.cloud.gateway.routes [0] .filters [0] = RequestRateLimiter = 2,2，＃&#123;@ userkeyresolver&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="Redis-RateLimiter"><a href="#Redis-RateLimiter" class="headerlink" title="Redis RateLimiter"></a>Redis RateLimiter</h3><p>redis实现基于<a href="https://stripe.com/blog/rate-limiters" target="_blank" rel="noopener">Stripe</a>完成的工作。它需要使用<code>spring-boot-starter-data-redis-reactive</code>Spring Boot启动器。</p>
<p>使用的算法是<a href="https://en.wikipedia.org/wiki/Token_bucket" target="_blank" rel="noopener">令牌桶算法</a>。</p>
<p>这<code>redis-rate-limiter.replenishRate</code>是您希望允许用户每秒执行多少请求，而不会丢弃任何请求。这是令牌桶填充的速率。</p>
<p>这<code>redis-rate-limiter.burstCapacity</code>是用户在一秒钟内允许执行的最大请求数。这是令牌桶可以容纳的令牌数。将此值设置为零将阻止所有请求。</p>
<p>通过在<code>replenishRate</code>和中设置相同的值来实现稳定的速率<code>burstCapacity</code>。设置<code>burstCapacity</code>高于时，可以允许临时突发<code>replenishRate</code>。在这种情况下，需要在突发之间允许速率限制器一段时间（根据<code>replenishRate</code>），因为2次连续突发将导致请求被丢弃（<code>HTTP 429 - Too Many Requests</code>）。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">requestratelimiter_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">RequestRateLimiter</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line">            <span class="string">redis-rate-limiter.replenishRate:</span> <span class="number">10</span></span><br><span class="line">            <span class="string">redis-rate-limiter.burstCapacity:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p><strong>Config.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">KeyResolver <span class="title">userKeyResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> exchange -&gt; Mono.just(exchange.getRequest().getQueryParams().getFirst(<span class="string">"user"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这定义了每个用户10的请求率限制。允许突发20，但下一秒只有10个请求可用。这<code>KeyResolver</code>是一个获取<code>user</code>请求参数的简单方法（注意：这不建议用于生产）。</p>
<p>速率限制器也可以定义为实现<code>RateLimiter</code>接口的bean 。在配置中，使用SpEL按名称引用bean。<code>#{@myRateLimiter}</code>是一个引用具有名称的bean的SpEL表达式<code>myRateLimiter</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">requestratelimiter_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">RequestRateLimiter</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            rate-limiter:</span> <span class="string">"#&#123;@myRateLimiter&#125;"</span></span><br><span class="line"><span class="attr">            key-resolver:</span> <span class="string">"#&#123;@userKeyResolver&#125;"</span></span><br></pre></td></tr></table></figure>
<h3 id="RedirectTo"><a href="#RedirectTo" class="headerlink" title="RedirectTo"></a>RedirectTo</h3><p>RedirectTo GatewayFilter Factory采用a <code>status</code>和<code>url</code>参数。状态应该是300系列重定向http代码，例如301. url应该是有效的URL。这将是<code>Location</code>标题的值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">prefixpath_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RedirectTo=302,</span> <span class="attr">http://acme.org</span></span><br></pre></td></tr></table></figure>
<p>这将发送带有<code>Location:http://acme.org</code>标题的状态302 以执行重定向。</p>
<h3 id="RemoveHopByHopHeadersFilter"><a href="#RemoveHopByHopHeadersFilter" class="headerlink" title="RemoveHopByHopHeadersFilter"></a>RemoveHopByHopHeadersFilter</h3><p>RemoveHopByHopHeadersFilter GatewayFilter Factory从转发的请求中删除标头。删除的标头列表来自<a href="https://tools.ietf.org/html/draft-ietf-httpbis-p1-messaging-14#section-7.1.3" target="_blank" rel="noopener">IETF</a>。</p>
<p>默认删除的标头是：</p>
<ul>
<li>Connection</li>
<li>Keep-Alive</li>
<li>Proxy-Authenticate</li>
<li>Proxy-Authorization</li>
<li>TE</li>
<li>Trailer</li>
<li>Transfer-Encoding</li>
<li>Upgrade</li>
</ul>
<p>要更改此设置，请将该<code>spring.cloud.gateway.filter.remove-non-proxy-headers.headers</code>属性设置为要删除的标题名称列表。</p>
<h3 id="RemoveRequestHeader"><a href="#RemoveRequestHeader" class="headerlink" title="RemoveRequestHeader"></a>RemoveRequestHeader</h3><p>RemoveRequestHeader GatewayFilter Factory接受一个<code>name</code>参数。它是要删除的标头的名称。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">removerequestheader_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RemoveRequestHeader=X-Request-Foo</span></span><br></pre></td></tr></table></figure>
<p>这将在向下游发送之前删除标头<code>X-Request-Foo</code>。</p>
<h3 id="RemoveResponseHeader"><a href="#RemoveResponseHeader" class="headerlink" title="RemoveResponseHeader"></a>RemoveResponseHeader</h3><p>RemoveResponseHeader GatewayFilter Factory接受一个<code>name</code>参数。它是要删除的标头的名称。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">removeresponseheader_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RemoveResponseHeader=X-Response-Foo</span></span><br></pre></td></tr></table></figure>
<p>这将<code>X-Response-Foo</code>在响应返回到网关客户端之前从响应中删除标头。</p>
<p>要删除任何类型的敏感标头，您应该为您可能要执行此操作的任何路由配置此过滤器。此外，您可以使用一次配置此过滤器<code>spring.cloud.gateway.default-filters</code> 并将其应用于所有路径。</p>
<h3 id="RewritePath"><a href="#RewritePath" class="headerlink" title="RewritePath"></a>RewritePath</h3><p>RewritePath GatewayFilter Factory采用路径<code>regexp</code>参数和<code>replacement</code>参数。这使用Java正则表达式来灵活地重写请求路径。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">rewritepath_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/foo/**</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RewritePath=/foo/(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>
<p>对于请求路径<code>/foo/bar</code>，这将设置<code>/bar</code>进行下游请求之前的路径。注意由于YAML规范而将<code>$\</code>替换<code>$</code>。</p>
<h3 id="RewriteResponseHeader"><a href="#RewriteResponseHeader" class="headerlink" title="RewriteResponseHeader"></a>RewriteResponseHeader</h3><p>RewriteResponseHeader GatewayFilter工厂需要<code>name</code>，<code>regexp</code>和<code>replacement</code>参数。它使用Java正则表达式以灵活的方式重写响应头值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">rewriteresponseheader_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">RewriteResponseHeader=X-Response-Foo,</span> <span class="string">,</span> <span class="string">password=[^&amp;]+,</span> <span class="string">password=***</span></span><br></pre></td></tr></table></figure>
<p>对于标头值<code>/42?user=ford&amp;password=omg!what&amp;flag=true</code>，它将在发出下游请求后设置为<code>/42?user=ford&amp;password=***&amp;flag=true</code>。由于YAML规范，请用<code>$\</code>替换<code>$</code>。</p>
<h3 id="SaveSession"><a href="#SaveSession" class="headerlink" title="SaveSession"></a>SaveSession</h3><p>SaveSession GatewayFilter Factory <em>在</em>转发下游呼叫<em>之前</em>强制执行<code>WebSession::save</code>操作。当使用<a href="https://projects.spring.io/spring-session/" target="_blank" rel="noopener">Spring Session</a>与惰性数据存储之类的东西时，这是特别有用的，并且需要确保在转发调用之前已保存会话状态。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">save_session</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/foo/**</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SaveSession</span></span><br></pre></td></tr></table></figure>
<p>如果要将<a href="https://projects.spring.io/spring-security/" target="_blank" rel="noopener">Spring Security</a>与Spring Session 集成，并且希望确保将安全性详细信息转发到远程进程，则这很关键。</p>
<h3 id="SecureHeaders"><a href="#SecureHeaders" class="headerlink" title="SecureHeaders"></a>SecureHeaders</h3><p>SecureHeaders GatewayFilter Factory在<a href="https://blog.appcanary.com/2017/http-security-headers.html" target="_blank" rel="noopener">此博客文章</a>的推荐中为响应添加了许多标题。</p>
<p>添加以下标头（以及默认值）：</p>
<ul>
<li><code>X-Xss-Protection:1; mode=block</code></li>
<li><code>Strict-Transport-Security:max-age=631138519</code></li>
<li><code>X-Frame-Options:DENY</code></li>
<li><code>X-Content-Type-Options:nosniff</code></li>
<li><code>Referrer-Policy:no-referrer</code></li>
<li><code>Content-Security-Policy:default-src &#39;self&#39; https:; font-src &#39;self&#39; https: data:; img-src &#39;self&#39; https: data:; object-src &#39;none&#39;; script-src https:; style-src &#39;self&#39; https: &#39;unsafe-inline&#39;</code></li>
<li><code>X-Download-Options:noopen</code></li>
<li><code>X-Permitted-Cross-Domain-Policies:none</code></li>
</ul>
<p>要更改默认值，请在<code>spring.cloud.gateway.filter.secure-headers</code>命名空间中设置相应的属性：</p>
<p>要改变的属性：</p>
<ul>
<li><code>xss-protection-header</code></li>
<li><code>strict-transport-security</code></li>
<li><code>frame-options</code></li>
<li><code>content-type-options</code></li>
<li><code>referrer-policy</code></li>
<li><code>content-security-policy</code></li>
<li><code>download-options</code></li>
<li><code>permitted-cross-domain-policies</code></li>
</ul>
<h3 id="SetPath"><a href="#SetPath" class="headerlink" title="SetPath"></a>SetPath</h3><p>SetPath GatewayFilter Factory采用路径<code>template</code>参数。它提供了一种通过允许模板化路径段来操作请求路径的简单方法。这使用了Spring Framework中的uri模板。允许多个匹配的段。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setpath_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/foo/&#123;segment&#125;</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SetPath=/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>
<p>对于请求路径<code>/foo/bar</code>，这将设置<code>/bar</code>进行下游请求之前的路径。</p>
<h3 id="SetResponseHeader"><a href="#SetResponseHeader" class="headerlink" title="SetResponseHeader"></a>SetResponseHeader</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setresponseheader_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SetResponseHeader=X-Response-Foo,</span> <span class="string">Bar</span></span><br></pre></td></tr></table></figure>
<p>GatewayFilter用给定名称替换所有标头，而不是添加。因此，如果下游服务器以响应<code>X-Response-Foo:1234</code>，则将替换为<code>X-Response-Foo:Bar</code>，这是网关客户端将接收的内容。</p>
<h3 id="SetStatus"><a href="#SetStatus" class="headerlink" title="SetStatus"></a>SetStatus</h3><p>SetStatus GatewayFilter Factory采用单个<code>status</code>参数。它必须是有效的Spring <code>HttpStatus</code>。它可以是整数值<code>404</code>或枚举的字符串表示形式<code>NOT_FOUND</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setstatusstring_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SetStatus=BAD_REQUEST</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setstatusint_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SetStatus=401</span></span><br></pre></td></tr></table></figure>
<p>在任何一种情况下，响应的HTTP状态都将设置为401。</p>
<h3 id="StripPrefix"><a href="#StripPrefix" class="headerlink" title="StripPrefix"></a>StripPrefix</h3><p>StripPrefix GatewayFilter Factory采用一个参数<code>parts</code>。该<code>parts</code>参数指示在向下游发送之前从请求中剥离的路径中的部分数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">nameRoot</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://nameservice</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/name/**</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">StripPrefix=2</span></span><br></pre></td></tr></table></figure>
<p>当通过网关<code>/name/bar/foo</code>发出请求时，<code>nameservice</code>会发出请求<code>http://nameservice/foo</code>。</p>
<h3 id="Retry"><a href="#Retry" class="headerlink" title="Retry"></a>Retry</h3><p>Retry GatewayFilter 工厂采用<code>retries</code>，<code>statuses</code>，<code>methods</code>，和<code>series</code>作为参数。</p>
<ul>
<li><code>retries</code>：应尝试的重试次数</li>
<li><code>statuses</code>：应使用重试的HTTP状态代码 <code>org.springframework.http.HttpStatus</code></li>
<li><code>methods</code>：应该重试的HTTP方法，使用表示 <code>org.springframework.http.HttpMethod</code></li>
<li><code>series</code>：要重试的一系列状态代码，使用表示 <code>org.springframework.http.HttpStatus.Series</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">retry_test</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:8080/flakey</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Host=*.retry.com</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">Retry</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            retries:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">            statuses:</span> <span class="string">BAD_GATEWAY</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>重试过滤器当前不支持使用正文重试（例如，对于带有正文的POST或PUT请求）。</p>
</blockquote>
<blockquote>
<p>当使用带有<code>forward:</code>前缀URL 的重试过滤器时，应仔细编写目标端点，以便在出现错误时不会执行任何可能导致响应发送到客户端并提交的操作。例如，如果目标端点是带注释的控制器，则目标控制器方法不应返回<code>ResponseEntity</code>错误状态代码。相反，它应该抛出一个<code>Exception</code>或发出错误信号，例如通过<code>Mono.error(ex)</code>返回值，重试过滤器可以配置为通过重试来处理。</p>
</blockquote>
<h3 id="RequestSize"><a href="#RequestSize" class="headerlink" title="RequestSize"></a>RequestSize</h3><p>当请求大小大于允许的限制时，RequestSize GatewayFilter Factory可以限制请求到达下游服务。过滤器<code>RequestSize</code>作为参数，该参数是以字节为单位定义的请求的允许大小限制。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">request_size_route</span></span><br><span class="line"><span class="attr">      uri:</span> <span class="attr">http://localhost:8080/upload</span></span><br><span class="line"><span class="attr">      predicates:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Path=/upload</span></span><br><span class="line"><span class="attr">      filters:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">RequestSize</span></span><br><span class="line"><span class="attr">        args:</span></span><br><span class="line"><span class="attr">          maxSize:</span> <span class="number">5000000</span></span><br></pre></td></tr></table></figure>
<p>当Request因大小而被拒绝时，RequestSize GatewayFilter Factory将响应状态设置为<code>413 Payload Too Large</code>附加标头<code>errorMessage</code>。以下是这样的一个例子<code>errorMessage</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errorMessage ： Request size is larger than permissible limit. Request size is 6.0 MB where permissible limit is 5.0 MB</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果未在路由定义中将过滤参数提供，则默认请求大小将设置为5 MB。</p>
</blockquote>
<h3 id="Modify-Request-Body"><a href="#Modify-Request-Body" class="headerlink" title="Modify Request Body"></a>Modify Request Body</h3><p><strong>此过滤器被视为BETA，API可能在将来发生变化</strong></p>
<p>此过滤器可用于在网关向下游发送请求主体之前对其进行修改。</p>
<blockquote>
<p>此过滤器只能使用Java DSL进行配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">routes</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.routes()</span><br><span class="line">        .route(<span class="string">"rewrite_request_obj"</span>, r -&gt; r.host(<span class="string">"*.rewriterequestobj.org"</span>)</span><br><span class="line">            .filters(f -&gt; f.prefixPath(<span class="string">"/httpbin"</span>)</span><br><span class="line">                .modifyRequestBody(String.class, Hello.class, MediaType.APPLICATION_JSON_VALUE,</span><br><span class="line">                    (exchange, s) -&gt; <span class="keyword">return</span> Mono.just(<span class="keyword">new</span> Hello(s.toUpperCase())))).uri(uri))</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Hello</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Hello</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Modify-Response-Body"><a href="#Modify-Response-Body" class="headerlink" title="Modify Response Body"></a>Modify Response Body</h3><p><strong>此过滤器被视为BETA，API可能在将来发生变化</strong></p>
<p>此过滤器可用于在将响应主体发送回客户端之前对其进行修改。</p>
<blockquote>
<p>此过滤器只能使用Java DSL进行配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">routes</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.routes()</span><br><span class="line">        .route(<span class="string">"rewrite_response_upper"</span>, r -&gt; r.host(<span class="string">"*.rewriteresponseupper.org"</span>)</span><br><span class="line">            .filters(f -&gt; f.prefixPath(<span class="string">"/httpbin"</span>)</span><br><span class="line">        		.modifyResponseBody(String.class, String.class,</span><br><span class="line">        		    (exchange, s) -&gt; Mono.just(s.toUpperCase()))).uri(uri)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Default-Filters"><a href="#Default-Filters" class="headerlink" title="Default Filters"></a>Default Filters</h3><p>如果您想添加过滤器并将其应用于您可以使用的所有路线<code>spring.cloud.gateway.default-filters</code>。此属性采用过滤器列表</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      default-filters:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">AddResponseHeader=X-Response-Default-Foo,</span> <span class="string">Default-Bar</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">PrefixPath=/httpbin</span></span><br></pre></td></tr></table></figure>
<h2 id="Global-Filters"><a href="#Global-Filters" class="headerlink" title="Global Filters"></a>Global Filters</h2><p>该<code>GlobalFilter</code>接口具有相同的签名<code>GatewayFilter</code>。这些是有条件地应用于所有路线的特殊过滤器。（此界面和用法可能会在未来的里程碑中发生变化）。</p>
<h3 id="组合全局过滤器和GatewayFilter排序"><a href="#组合全局过滤器和GatewayFilter排序" class="headerlink" title="组合全局过滤器和GatewayFilter排序"></a>组合全局过滤器和GatewayFilter排序</h3><p>当请求进入（并匹配路由）时，Filtering Web Handler会将所有实例<code>GlobalFilter</code>和所有路由特定实例添加<code>GatewayFilter</code>到过滤器链中。这个组合的过滤器链按<code>org.springframework.core.Ordered</code>接口排序，可以通过实现<code>getOrder()</code>方法或使用<code>@Order</code>注释来设置。</p>
<p>由于Spring Cloud Gateway区分了过滤器逻辑执行的“前”和“后”阶段（请参阅：工作原理），具有最高优先级的过滤器将是“pre”阶段中的第一个和“post”中的最后一个“-相。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Order</span>(-<span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">        log.info(<span class="string">"first pre filter"</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"third post filter"</span>);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Order</span>(<span class="number">0</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">        log.info(<span class="string">"second pre filter"</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"second post filter"</span>);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Order</span>(<span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">c</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">        log.info(<span class="string">"third pre filter"</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"first post filter"</span>);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Forward-Routing-Filter"><a href="#Forward-Routing-Filter" class="headerlink" title="Forward Routing Filter"></a>Forward Routing Filter</h3><p>将<code>ForwardRoutingFilter</code>在交换属性查找一个URI <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code>。如果url有一个<code>forward</code>方案（即<code>forward:///localendpoint</code>），它将使用Spring <code>DispatcherHandler</code>来处理请求。请求URL的路径部分将被转发URL中的路径覆盖。未修改的原始URL将附加到<code>ServerWebExchangeUtils.GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code>属性中的列表中。</p>
<h3 id="LoadBalancerClient过滤器"><a href="#LoadBalancerClient过滤器" class="headerlink" title="LoadBalancerClient过滤器"></a>LoadBalancerClient过滤器</h3><p>将<code>LoadBalancerClientFilter</code>在交换属性查找一个URI <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code>。如果url有一个<code>lb</code>方案（即<code>lb://myservice</code>），它将使用Spring Cloud <code>LoadBalancerClient</code>将名称（<code>myservice</code>在前面的示例中）解析为实际的主机和端口，并替换相同属性中的URI。未修改的原始URL将附加到<code>ServerWebExchangeUtils.GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code>属性中的列表中。过滤器还将查看<code>ServerWebExchangeUtils.GATEWAY_SCHEME_PREFIX_ATTR</code>属性以查看它是否等于<code>lb</code>，然后应用相同的规则。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">myRoute</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">lb://service</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/service/**</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>默认情况下，当某个服务实例不能在找到<code>LoadBalancer</code>一个<code>503</code>将被退回。您可以将网关配置为<code>404</code>按设置返回<code>spring.cloud.gateway.loadbalancer.use404=true</code>。</p>
</blockquote>
<blockquote>
<p>从中返回 的<code>isSecure</code>值将覆盖在对网关发出的请求中指定的方案。例如，如果请求进入网关， 但表示它不安全，则下游请求将被终止 。相反的情况也适用。但是，如果为网关配置中的路由指定，则将剥离前缀，并且路由URL中的结果方案将覆盖配置。 <code>ServiceInstance</code> <code>LoadBalancer</code> <code>HTTPS</code> <code>ServiceInstance</code> <code>HTTP</code> <code>GATEWAY_SCHEME_PREFIX_ATTR</code> <code>ServiceInstance</code></p>
</blockquote>
<h3 id="Netty-Routing-Filter"><a href="#Netty-Routing-Filter" class="headerlink" title="Netty Routing Filter"></a>Netty Routing Filter</h3><p>如果位于<code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code>exchange属性中的url 具有<code>http</code>或<code>https</code>scheme ，则运行Netty Routing Filter 。它使用Netty <code>HttpClient</code>发出下游代理请求。响应将放在<code>ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR</code>exchange属性中，以便在以后的过滤器中使用。（有一个实验<code>WebClientHttpRoutingFilter</code>执行相同的功能，但不需要netty）</p>
<h3 id="Netty-Write-Response-Filter"><a href="#Netty-Write-Response-Filter" class="headerlink" title="Netty Write Response Filter"></a>Netty Write Response Filter</h3><p>在<code>NettyWriteResponseFilter</code>运行，如果有一个的Netty <code>HttpClientResponse</code>在<code>ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR</code>交换属性。它在所有其他过滤器完成后运行，并将代理响应写回网关客户端响应。（有一个实验<code>WebClientWriteResponseFilter</code>执行相同的功能，但不需要netty）</p>
<h3 id="RouteToRequestUrl过滤器"><a href="#RouteToRequestUrl过滤器" class="headerlink" title="RouteToRequestUrl过滤器"></a>RouteToRequestUrl过滤器</h3><p>在<code>RouteToRequestUrlFilter</code>运行，如果有一个<code>Route</code>在对象<code>ServerWebExchangeUtils.GATEWAY_ROUTE_ATTR</code>交换属性。它根据请求URI创建一个新URI，但使用该<code>Route</code>对象的URI属性进行更新。新URI放在<code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code>exchange属性`中。</p>
<p>如果URI具有方案前缀，例如<code>lb:ws://serviceid</code>，该<code>lb</code>方案将从URI中剥离并放置在<code>ServerWebExchangeUtils.GATEWAY_SCHEME_PREFIX_ATTR</code>稍后用于过滤器链中。</p>
<h3 id="Websocket路由过滤器"><a href="#Websocket路由过滤器" class="headerlink" title="Websocket路由过滤器"></a>Websocket路由过滤器</h3><p>如果位于<code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code>exchange属性中的url 具有<code>ws</code>或<code>wss</code>scheme ，则运行Websocket路由过滤器。它使用Spring Web Socket基础结构将Websocket请求转发到下游。</p>
<p>可以通过为URI添加前缀来对Websockets进行负载平衡<code>lb</code>，例如<code>lb:ws://serviceid</code>。</p>
<blockquote>
<p>如果您使用<a href="https://github.com/sockjs" target="_blank" rel="noopener">SockJS</a>作为普通http的后备，则应配置正常的HTTP路由以及Websocket路由。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line">      <span class="comment"># SockJS route</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">websocket_sockjs_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://localhost:3001</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/websocket/info/**</span></span><br><span class="line">      <span class="comment"># Normwal Websocket route</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">websocket_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">ws://localhost:3001</span></span><br><span class="line"><span class="attr">        predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/websocket/**</span></span><br></pre></td></tr></table></figure>
<h3 id="Gateway-Metrics-Filter"><a href="#Gateway-Metrics-Filter" class="headerlink" title="Gateway Metrics Filter"></a>Gateway Metrics Filter</h3><p>要启用Gateway Metrics，请将spring-boot-starter-actuator添加为项目依赖项。然后，默认情况下，只要<code>spring.cloud.gateway.metrics.enabled</code>未将属性设置为，网关指标筛选器就会运行<code>false</code>。此过滤器添加名为“gateway.requests”的计时器度量标准，其中包含以下标记：</p>
<ul>
<li><code>routeId</code>：路由ID</li>
<li><code>routeUri</code>：API将路由到的URI</li>
<li><code>outcome</code>：由<a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/http/HttpStatus.Series.html" target="_blank" rel="noopener">HttpStatus.Series</a>分类的结果</li>
<li><code>status</code>：请求的Http状态返回给客户端</li>
</ul>
<p>然后可以从这些指标中<a href="https://cloud.spring.io/spring-cloud-gateway/images/gateway-grafana-dashboard.jpeg" target="_blank" rel="noopener">删除</a>这些指标，<code>/actuator/metrics/gateway.requests</code>并且可以轻松地与Prometheus <a href="https://cloud.spring.io/spring-cloud-gateway/images/gateway-grafana-dashboard.jpeg" target="_blank" rel="noopener">集成</a> 以创建<a href="https://cloud.spring.io/spring-cloud-gateway/images/gateway-grafana-dashboard.jpeg" target="_blank" rel="noopener">Grafana </a><a href="https://cloud.spring.io/spring-cloud-gateway/gateway-grafana-dashboard.json" target="_blank" rel="noopener">仪表板</a>。</p>
<blockquote>
<p>要启用pometheus端点，请将micrometer-registry-prometheus添加为项目依赖项。</p>
</blockquote>
<h3 id="Marking-An-Exchange-As-Routed"><a href="#Marking-An-Exchange-As-Routed" class="headerlink" title="Marking An Exchange As Routed"></a>Marking An Exchange As Routed</h3><p>在网关路由后<code>ServerWebExchange</code>，它将通过添加<code>gatewayAlreadyRouted</code> 到交换属性将该交换标记为“路由” 。一旦请求被标记为路由，其他路由过滤器将不会再次路由请求，实质上是跳过过滤器。您可以使用便捷方法将交换标记为路由，或检查交换是否已路由。</p>
<ul>
<li><code>ServerWebExchangeUtils.isAlreadyRouted</code>获取一个<code>ServerWebExchange</code>对象并检查它是否已被“路由”</li>
<li><code>ServerWebExchangeUtils.setAlreadyRouted</code>获取一个<code>ServerWebExchange</code>对象并将其标记为“路由”</li>
</ul>
<h2 id="TLS-SSL"><a href="#TLS-SSL" class="headerlink" title="TLS / SSL"></a>TLS / SSL</h2><p>网关可以通过遵循通常的Spring服务器配置来监听https上的请求。例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  ssl:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    key-alias:</span> <span class="string">scg</span></span><br><span class="line"><span class="attr">    key-store-password:</span> <span class="string">scg1234</span></span><br><span class="line"><span class="attr">    key-store:</span> <span class="attr">classpath:scg-keystore.p12</span></span><br><span class="line"><span class="attr">    key-store-type:</span> <span class="string">PKCS12</span></span><br></pre></td></tr></table></figure>
<p>网关路由可以路由到http和https后端。如果路由到https后端，则可以将网关配置为信任具有以下配置的所有下游证书：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      httpclient:</span></span><br><span class="line"><span class="attr">        ssl:</span></span><br><span class="line"><span class="attr">          useInsecureTrustManager:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>使用不安全的信任管理器不适合生产。对于生产部署，可以使用以下配置为Gateway配置一组可信任的已知证书：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      httpclient:</span></span><br><span class="line"><span class="attr">        ssl:</span></span><br><span class="line"><span class="attr">          trustedX509Certificates:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">cert1.pem</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">cert2.pem</span></span><br></pre></td></tr></table></figure>
<p>如果Spring Cloud Gateway未配置受信任证书，则使用默认信任库（可以使用系统属性javax.net.ssl.trustStore覆盖）。</p>
<h3 id="TLS-Handshake"><a href="#TLS-Handshake" class="headerlink" title="TLS Handshake"></a>TLS Handshake</h3><p>网关维护一个客户端池，用于路由到后端。通过https进行通信时，客户端会启动TLS握手。此握手与许多超时有关。可以配置这些超时（显示默认值）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      httpclient:</span></span><br><span class="line"><span class="attr">        ssl:</span></span><br><span class="line"><span class="attr">          handshake-timeout-millis:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">          close-notify-flush-timeout-millis:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">          close-notify-read-timeout-millis:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p>Spring Cloud Gateway的配置由<code>RouteDefinitionLocator</code>s的集合驱动。</p>
<p><strong>RouteDefinitionLocator.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RouteDefinitionLocator</span> </span>&#123;</span><br><span class="line">	<span class="function">Flux&lt;RouteDefinition&gt; <span class="title">getRouteDefinitions</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下，<code>PropertiesRouteDefinitionLocator</code>使用Spring Boot的<code>@ConfigurationProperties</code>机制加载属性。</p>
<p>上面的配置示例都使用了一个使用位置参数而不是命名参数的快捷符号。以下两个例子是等效的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setstatus_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">SetStatus</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            status:</span> <span class="number">401</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">setstatusshortcut_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">http://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">SetStatus=401</span></span><br></pre></td></tr></table></figure>
<p>对于网关的一些用法，属性是足够的，但是一些生产用例将受益于从外部源（例如数据库）加载配置。未来的里程碑版本将<code>RouteDefinitionLocator</code>基于Spring Data Repositories实现，例如：Redis，MongoDB和Cassandra。</p>
<h3 id="流畅的Java-Routes-API"><a href="#流畅的Java-Routes-API" class="headerlink" title="流畅的Java Routes API"></a>流畅的Java Routes API</h3><p>为了允许在Java中进行简单配置，在<code>RouteLocatorBuilder</code>bean中定义了一个流畅的API 。</p>
<p><strong>GatewaySampleApplication.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static imports from GatewayFilters and RoutePredicates</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder, ThrottleGatewayFilterFactory throttle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.routes()</span><br><span class="line">            .route(r -&gt; r.host(<span class="string">"**.abc.org"</span>).and().path(<span class="string">"/image/png"</span>)</span><br><span class="line">                .filters(f -&gt;</span><br><span class="line">                        f.addResponseHeader(<span class="string">"X-TestHeader"</span>, <span class="string">"foobar"</span>))</span><br><span class="line">                .uri(<span class="string">"http://httpbin.org:80"</span>)</span><br><span class="line">            )</span><br><span class="line">            .route(r -&gt; r.path(<span class="string">"/image/webp"</span>)</span><br><span class="line">                .filters(f -&gt;</span><br><span class="line">                        f.addResponseHeader(<span class="string">"X-AnotherHeader"</span>, <span class="string">"baz"</span>))</span><br><span class="line">                .uri(<span class="string">"http://httpbin.org:80"</span>)</span><br><span class="line">            )</span><br><span class="line">            .route(r -&gt; r.order(-<span class="number">1</span>)</span><br><span class="line">                .host(<span class="string">"**.throttle.org"</span>).and().path(<span class="string">"/get"</span>)</span><br><span class="line">                .filters(f -&gt; f.filter(throttle.apply(<span class="number">1</span>,</span><br><span class="line">                        <span class="number">1</span>,</span><br><span class="line">                        <span class="number">10</span>,</span><br><span class="line">                        TimeUnit.SECONDS)))</span><br><span class="line">                .uri(<span class="string">"http://httpbin.org:80"</span>)</span><br><span class="line">            )</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此样式还允许更多自定义谓词断言。<code>RouteDefinitionLocator</code>bean 定义的谓词使用逻辑组合<code>and</code>。通过使用流利的Java API，你可以使用<code>and()</code>，<code>or()</code>并且<code>negate()</code>对运营<code>Predicate</code>类。</p>
<h3 id="DiscoveryClient路由定义定位器"><a href="#DiscoveryClient路由定义定位器" class="headerlink" title="DiscoveryClient路由定义定位器"></a>DiscoveryClient路由定义定位器</h3><p>可以将网关配置为基于使用<code>DiscoveryClient</code>兼容服务注册表注册的服务来创建路由。</p>
<p>要启用此功能，请设置<code>spring.cloud.gateway.discovery.locator.enabled=true</code>并确保<code>DiscoveryClient</code>实现位于类路径上并启用（例如Netflix Eureka，Consul或Zookeeper）。</p>
<h3 id="配置DiscoveryClient路由的谓词和过滤器"><a href="#配置DiscoveryClient路由的谓词和过滤器" class="headerlink" title="配置DiscoveryClient路由的谓词和过滤器"></a>配置DiscoveryClient路由的谓词和过滤器</h3><p>默认情况下，网关为通过a创建的路由定义单个谓词和过滤器<code>DiscoveryClient</code>。</p>
<p>默认谓词是使用模式定义的路径谓词<code>/serviceId/**</code>，其中<code>serviceId</code>是来自的服务的id <code>DiscoveryClient</code>。</p>
<p>默认过滤器是带有正则表达式<code>/serviceId/(?&lt;remaining&gt;.*)</code>和替换的 重写路径过滤器<code>/${remaining}</code>。这只是在向下游发送请求之前从路径中剥离服务ID。</p>
<p>如果您想自定义<code>DiscoveryClient</code>路由使用的谓词和/或过滤器，可以通过设置<code>spring.cloud.gateway.discovery.locator.predicates[x]</code>和来自定义<code>spring.cloud.gateway.discovery.locator.filters[y]</code>。执行此操作时，如果要保留该功能，则需要确保包含上面的默认谓词和过滤器。下面是一个这样的例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.gateway.discovery.locator.predicates[0].name: Path</span><br><span class="line">spring.cloud.gateway.discovery.locator.predicates[0].args[pattern]: &quot;&apos;/&apos;+serviceId+&apos;/**&apos;&quot;</span><br><span class="line">spring.cloud.gateway.discovery.locator.predicates[1].name: Host</span><br><span class="line">spring.cloud.gateway.discovery.locator.predicates[1].args[pattern]: &quot;&apos;**.foo.com&apos;&quot;</span><br><span class="line">spring.cloud.gateway.discovery.locator.filters[0].name: Hystrix</span><br><span class="line">spring.cloud.gateway.discovery.locator.filters[0].args[name]: serviceId</span><br><span class="line">spring.cloud.gateway.discovery.locator.filters[1].name: RewritePath</span><br><span class="line">spring.cloud.gateway.discovery.locator.filters[1].args[regexp]: &quot;&apos;/&apos; + serviceId + &apos;/(?&lt;remaining&gt;.*)&apos;&quot;</span><br><span class="line">spring.cloud.gateway.discovery.locator.filters[1].args[replacement]: &quot;&apos;/$&#123;remaining&#125;&apos;&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Reactor-Netty访问日志"><a href="#Reactor-Netty访问日志" class="headerlink" title="Reactor Netty访问日志"></a>Reactor Netty访问日志</h2><p>要启用Reactor Netty访问日志，请进行设置<code>-Dreactor.netty.http.server.accessLogEnabled=true</code>。（它必须是Java System属性，而不是Spring Boot属性）。</p>
<p>可以将日志记录系统配置为具有单独的访问日志文件。以下是一个示例logback配置：</p>
<p><strong>logback.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"accessLog"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.FileAppender"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span>access_log.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"async"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.AsyncAppender"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"accessLog"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"reactor.netty.http.server.AccessLog"</span> <span class="attr">level</span>=<span class="string">"INFO"</span> <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"async"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="CORS配置"><a href="#CORS配置" class="headerlink" title="CORS配置"></a>CORS配置</h2><p>网关可以配置为控制CORS行为。“全局”CORS配置是<a href="https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/cors/CorsConfiguration.html" target="_blank" rel="noopener">Spring Framework<code>CorsConfiguration</code></a>的URL模式映射。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      globalcors:</span></span><br><span class="line"><span class="attr">        corsConfigurations:</span></span><br><span class="line">          <span class="string">'[/**]'</span><span class="string">:</span></span><br><span class="line"><span class="attr">            allowedOrigins:</span> <span class="string">"http://docs.spring.io"</span></span><br><span class="line"><span class="attr">            allowedMethods:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">GET</span></span><br></pre></td></tr></table></figure>
<p>在上面的示例中，对于所有GET请求的路径，将允许来自docs.spring.io的请求的CORS请求。</p>
<h2 id="Actuator-API"><a href="#Actuator-API" class="headerlink" title="Actuator API"></a>Actuator API</h2><p>该<code>/gateway</code>驱动器的端点允许监视和使用Spring的云网关应用程序进行交互。要进行远程访问，必须在应用程序属性中<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html#production-ready-endpoints-exposing-endpoints" target="_blank" rel="noopener">通过HTTP或JMX </a><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html#production-ready-endpoints-enabling-endpoints" target="_blank" rel="noopener">启用</a>和<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html#production-ready-endpoints-exposing-endpoints" target="_blank" rel="noopener">公开</a>端点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">management.endpoint.gateway.enabled=true # default value</span><br><span class="line">management.endpoints.web.exposure.include=gateway</span><br></pre></td></tr></table></figure>
<h3 id="检索路由过滤器"><a href="#检索路由过滤器" class="headerlink" title="检索路由过滤器"></a>检索路由过滤器</h3><h4 id="全球过滤器"><a href="#全球过滤器" class="headerlink" title="全球过滤器"></a>全球过滤器</h4><p>要检索应用于所有路由的全局过滤器，请发出GET请求/actuator/gateway/globalfilters。结果响应类似于以下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@77856cc5"</span>: <span class="number">10100</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@4f6fd101"</span>: <span class="number">10000</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@32d22650"</span>: <span class="number">-1</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.ForwardRoutingFilter@106459d9"</span>: <span class="number">2147483647</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.NettyRoutingFilter@1fbd5e0"</span>: <span class="number">2147483647</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.ForwardPathFilter@33a71d23"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@135064ea"</span>: <span class="number">2147483637</span>,</span><br><span class="line">  <span class="attr">"org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@23c05889"</span>: <span class="number">2147483646</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>响应包含有关全局过滤器的详细信息。对于每个全局过滤器，提供过滤器对象的字符串表示（例如<code>org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@77856cc5</code>）和过滤器链中的对应<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#_combined_global_filter_and_gatewayfilter_ordering" target="_blank" rel="noopener">顺序</a>。</p>
<h4 id="Route过滤器"><a href="#Route过滤器" class="headerlink" title="Route过滤器"></a>Route过滤器</h4><p>要检索应用于路由的<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#gatewayfilter-factories" target="_blank" rel="noopener">GatewayFilter工厂</a>，请发出<code>GET</code>请求<code>/actuator/gateway/routefilters</code>。结果响应类似于以下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"[AddRequestHeaderGatewayFilterFactory@570ed9c configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"[SecureHeadersGatewayFilterFactory@fceab5d configClass = Object]"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"[SaveSessionGatewayFilterFactory@4449b273 configClass = Object]"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>响应包含应用于任何特定路由的GatewayFilter工厂的详细信息。为每个工厂提供相应对象的字符串表示（例如<code>[SecureHeadersGatewayFilterFactory@fceab5d configClass = Object]</code>）。请注意，该<code>null</code>值是由于端点控制器的实现不完整，因为它尝试设置过滤器链中对象的顺序，这不适用于GatewayFilter工厂对象。</p>
<h3 id="刷新路由缓存"><a href="#刷新路由缓存" class="headerlink" title="刷新路由缓存"></a>刷新路由缓存</h3><p>要清除路由缓存，请发出<code>POST</code>请求<code>/actuator/gateway/refresh</code>。请求返回200没有响应正文</p>
<h3 id="检索网关中定义的路由"><a href="#检索网关中定义的路由" class="headerlink" title="检索网关中定义的路由"></a>检索网关中定义的路由</h3><p>要检索网关中定义的路由，请发出<code>GET</code>请求<code>/actuator/gateway/routes</code>。结果响应类似于以下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">  <span class="attr">"route_id"</span>: <span class="string">"first_route"</span>,</span><br><span class="line">  <span class="attr">"route_object"</span>: &#123;</span><br><span class="line">    <span class="attr">"predicate"</span>: <span class="string">"org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$432/1736826640@1e9d7e7d"</span>,</span><br><span class="line">    <span class="attr">"filters"</span>: [</span><br><span class="line">      <span class="string">"OrderedGatewayFilter&#123;delegate=org.springframework.cloud.gateway.filter.factory.PreserveHostHeaderGatewayFilterFactory$$Lambda$436/674480275@6631ef72, order=0&#125;"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"route_id"</span>: <span class="string">"second_route"</span>,</span><br><span class="line">  <span class="attr">"route_object"</span>: &#123;</span><br><span class="line">    <span class="attr">"predicate"</span>: <span class="string">"org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$432/1736826640@cd8d298"</span>,</span><br><span class="line">    <span class="attr">"filters"</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>响应包含网关中定义的所有路由的详细信息。下表描述了响应的每个元素（即路由）的结构。</p>
<table>
<thead>
<tr>
<th style="text-align:center">路径</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">route_id</td>
<td style="text-align:center">String</td>
<td style="text-align:center">路由ID</td>
</tr>
<tr>
<td style="text-align:center">route_object.predicate</td>
<td style="text-align:center">Object</td>
<td style="text-align:center">路由断言</td>
</tr>
<tr>
<td style="text-align:center">route_object.filters</td>
<td style="text-align:center">Array</td>
<td style="text-align:center">该<a href="https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#gatewayfilter-factories" target="_blank" rel="noopener">GatewayFilter工厂</a>工厂使用的路由</td>
</tr>
<tr>
<td style="text-align:center">order</td>
<td style="text-align:center">Number</td>
<td style="text-align:center">路由顺序</td>
</tr>
</tbody>
</table>
<h3 id="检索有关特定路线的信息"><a href="#检索有关特定路线的信息" class="headerlink" title="检索有关特定路线的信息"></a>检索有关特定路线的信息</h3><p>要检索有关单个路径的信息，<code>GET</code>请向<code>/actuator/gateway/routes/{id}</code>（例如<code>/actuator/gateway/routes/first_route</code>）发出请求。结果响应类似于以下内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="string">"first_route"</span>,</span><br><span class="line">  <span class="attr">"predicates"</span>: [&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"Path"</span>,</span><br><span class="line">    <span class="attr">"args"</span>: &#123;<span class="attr">"_genkey_0"</span>:<span class="string">"/first"</span>&#125;</span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">"filters"</span>: [],</span><br><span class="line">  <span class="attr">"uri"</span>: <span class="string">"http://www.uri-destination.org"</span>,</span><br><span class="line">  <span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>下表描述了响应的结构：</p>
<table>
<thead>
<tr>
<th style="text-align:center">路径</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>id</code></td>
<td style="text-align:center">String</td>
<td style="text-align:center">路由ID</td>
</tr>
<tr>
<td style="text-align:center"><code>predicates</code></td>
<td style="text-align:center">Array</td>
<td style="text-align:center">路由断言的集合。每个项目定义给定断言的名称和参数</td>
</tr>
<tr>
<td style="text-align:center"><code>filters</code></td>
<td style="text-align:center">Array</td>
<td style="text-align:center">应用于路径的过滤器集合</td>
</tr>
<tr>
<td style="text-align:center"><code>uri</code></td>
<td style="text-align:center">String</td>
<td style="text-align:center">路由的目标URI</td>
</tr>
<tr>
<td style="text-align:center"><code>order</code></td>
<td style="text-align:center">Number</td>
<td style="text-align:center">路由顺序</td>
</tr>
</tbody>
</table>
<h3 id="创建和删除特定路线"><a href="#创建和删除特定路线" class="headerlink" title="创建和删除特定路线"></a>创建和删除特定路线</h3><p>要创建路由，<code>POST</code>请<code>/gateway/routes/{id_route_to_create}</code>使用指定路径字段的JSON主体发出请求（请参阅上一小节）。</p>
<p>要删除路线，请发出<code>DELETE</code>请求<code>/gateway/routes/{id_route_to_delete}</code>。</p>
<h3 id="回顾：所有端点的列表"><a href="#回顾：所有端点的列表" class="headerlink" title="回顾：所有端点的列表"></a>回顾：所有端点的列表</h3><p>下表总结了Spring Cloud Gateway执行器端点。请注意，每个端点都具有<code>/actuator/gateway</code>基本路径。</p>
<table>
<thead>
<tr>
<th style="text-align:center">ID</th>
<th style="text-align:center">HTTP方法</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>globalfilters</code></td>
<td style="text-align:center">GET</td>
<td style="text-align:center">显示应用于路径的全局过滤器列表</td>
</tr>
<tr>
<td style="text-align:center"><code>routefilters</code></td>
<td style="text-align:center">GET</td>
<td style="text-align:center">显示应用于特定路由的GatewayFilter工厂列表</td>
</tr>
<tr>
<td style="text-align:center"><code>refresh</code></td>
<td style="text-align:center">POST</td>
<td style="text-align:center">清除路由缓存</td>
</tr>
<tr>
<td style="text-align:center"><code>routes</code></td>
<td style="text-align:center">GET</td>
<td style="text-align:center">显示网关中定义的路由列表</td>
</tr>
<tr>
<td style="text-align:center"><code>routes/{id}</code></td>
<td style="text-align:center">GET</td>
<td style="text-align:center">显示有关特定路径的信息</td>
</tr>
<tr>
<td style="text-align:center"><code>routes/{id}</code></td>
<td style="text-align:center">POST</td>
<td style="text-align:center">添加到网关的新路由</td>
</tr>
<tr>
<td style="text-align:center"><code>routes/{id}</code></td>
<td style="text-align:center">DELETE</td>
<td style="text-align:center">从网关中删除现有路由</td>
</tr>
</tbody>
</table>
<h2 id="开发者指南"><a href="#开发者指南" class="headerlink" title="开发者指南"></a>开发者指南</h2><p>TODO：编写自定义集成的概述</p>
<h3 id="编写自定义路由断言工厂"><a href="#编写自定义路由断言工厂" class="headerlink" title="编写自定义路由断言工厂"></a>编写自定义路由断言工厂</h3><p>TODO：撰写Custom Route Predicate Factories的文档</p>
<h3 id="编写自定义GatewayFilter工厂"><a href="#编写自定义GatewayFilter工厂" class="headerlink" title="编写自定义GatewayFilter工厂"></a>编写自定义GatewayFilter工厂</h3><p>要编写GatewayFilter，您需要实现<code>GatewayFilterFactory</code>。有一个<code>AbstractGatewayFilterFactory</code>可以扩展的抽象类：</p>
<p><strong>PreGatewayFilterFactory.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">PreGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PreGatewayFilterFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(Config.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// grab configuration from Config object</span></span><br><span class="line">		<span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">            <span class="comment">//If you want to build a "pre" filter you need to manipulate the</span></span><br><span class="line">            <span class="comment">//request before calling chain.filter</span></span><br><span class="line">            ServerHttpRequest.Builder builder = exchange.getRequest().mutate();</span><br><span class="line">            <span class="comment">//use builder to manipulate the request</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Put the configuration properties for your filter here</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>PostGatewayFilterFactory.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PostGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">PostGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PostGatewayFilterFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(Config.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// grab configuration from Config object</span></span><br><span class="line">		<span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">			<span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">				ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">				<span class="comment">//Manipulate the response in some way</span></span><br><span class="line">			&#125;));</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Put the configuration properties for your filter here</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编写定制全局过滤器"><a href="#编写定制全局过滤器" class="headerlink" title="编写定制全局过滤器"></a>编写定制全局过滤器</h3><p>要编写自定义全局过滤器，您需要实现<code>GlobalFilter</code>接口。这将过滤器应用于所有请求。</p>
<p>分别如何设置全局前置和后置过滤器的示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">customGlobalFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; exchange.getPrincipal()</span><br><span class="line">        .map(Principal::getName)</span><br><span class="line">        .defaultIfEmpty(<span class="string">"Default User"</span>)</span><br><span class="line">        .map(userName -&gt; &#123;</span><br><span class="line">          <span class="comment">//adds header to proxied request</span></span><br><span class="line">          exchange.getRequest().mutate().header(<span class="string">"CUSTOM-REQUEST-HEADER"</span>, userName).build();</span><br><span class="line">          <span class="keyword">return</span> exchange;</span><br><span class="line">        &#125;)</span><br><span class="line">        .flatMap(chain::filter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">customGlobalPostFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (exchange, chain) -&gt; chain.filter(exchange)</span><br><span class="line">        .then(Mono.just(exchange))</span><br><span class="line">        .map(serverWebExchange -&gt; &#123;</span><br><span class="line">          <span class="comment">//adds header to response</span></span><br><span class="line">          serverWebExchange.getResponse().getHeaders().set(<span class="string">"CUSTOM-RESPONSE-HEADER"</span>,</span><br><span class="line">              HttpStatus.OK.equals(serverWebExchange.getResponse().getStatusCode()) ? <span class="string">"It worked"</span>: <span class="string">"It did not work"</span>);</span><br><span class="line">          <span class="keyword">return</span> serverWebExchange;</span><br><span class="line">        &#125;)</span><br><span class="line">        .then();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编写自定义路由定位器和写入器"><a href="#编写自定义路由定位器和写入器" class="headerlink" title="编写自定义路由定位器和写入器"></a>编写自定义路由定位器和写入器</h3><p>TODO：编写自定义路由定位器和写入器的文档</p>
<h2 id="使用Spring-MVC或Webflux构建简单网关"><a href="#使用Spring-MVC或Webflux构建简单网关" class="headerlink" title="使用Spring MVC或Webflux构建简单网关"></a>使用Spring MVC或Webflux构建简单网关</h2><p>Spring Cloud Gateway提供了一个实用程序对象<code>ProxyExchange</code>，可以在常规Spring Web处理程序中将其用作方法参数。它通过镜像HTTP谓词的方法支持基本的下游HTTP交换。使用MVC，它还支持通过该<code>forward()</code>方法转发到本地处理程序。要<code>ProxyExchange</code>在类路径中使用恰好包含正确的模块（<code>spring-cloud-gateway-mvc</code>或者<code>spring-cloud-gateway-webflux</code>）。</p>
<p>MVC示例（代理向远程服务器下游“/test”的请求）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewaySampleApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;remote.home&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> URI home;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;?&gt; proxy(ProxyExchange&lt;<span class="keyword">byte</span>[]&gt; proxy) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> proxy.uri(home.toString() + <span class="string">"/image/png"</span>).get();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Webflux也是如此：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewaySampleApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value</span>(<span class="string">"$&#123;remote.home&#125;"</span>)</span><br><span class="line">	<span class="keyword">private</span> URI home;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">	<span class="keyword">public</span> Mono&lt;ResponseEntity&lt;?&gt;&gt; proxy(ProxyExchange&lt;<span class="keyword">byte</span>[]&gt; proxy) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> proxy.uri(home.toString() + <span class="string">"/image/png"</span>).get();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有一些方便的方法<code>ProxyExchange</code>可以使处理程序方法发现和增强传入请求的URI路径。例如，您可能希望提取路径的尾随元素以将其传递到下游：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/proxy/path/**"</span>)</span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;?&gt; proxyPath(ProxyExchange&lt;<span class="keyword">byte</span>[]&gt; proxy) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  String path = proxy.path(<span class="string">"/proxy/path/"</span>);</span><br><span class="line">  <span class="keyword">return</span> proxy.uri(home.toString() + <span class="string">"/foos/"</span> + path).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring MVC或Webflux的所有功能都可用于Gateway处理程序方法。例如，您可以注入请求标头和查询参数，并且您可以使用映射注释中的声明来约束传入的请求。有关<code>@RequestMapping</code>这些功能的更多详细信息，请参阅Spring MVC中的文档。</p>
<p>可以使用<code>header()</code>方法将标头添加到下游响应中<code>ProxyExchange</code>。</p>
<p>您还可以通过向<code>get()</code>etc方法添加映射器来操作响应标头（以及响应中您喜欢的任何其他内容）。映射器是一个<code>Function</code>接收传入<code>ResponseEntity</code>并将其转换为传出映射器的映射器。</p>
<p>为“敏感”标题（默认情况下为“cookie”和“授权”）提供了第一类支持，这些标题未传递到下游，而“代理”标题（<code>x-forwarded-*</code>）也是如此。</p>
</div></div><a class="button-hover more" href="/2019/03/26/基于2.2.x的SpringCloudGateway/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2019/03/25/SpringBoot整合Security/">SpringBoot整合Security</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2019-03-25</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/springboot/">springboot</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/security/">security</a></div></div><div class="post-content"><div class="main-content content"><p>入门</p>
<p>本指南将引导您完成使用受Spring Security保护的资源创建简单Web应用程序的过程。</p>
<h2 id="创建不安全的Web应用程序"><a href="#创建不安全的Web应用程序" class="headerlink" title="创建不安全的Web应用程序"></a>创建不安全的Web应用程序</h2><p>在将安全性应用于Web应用程序之前，您需要一个Web应用程序来保护安全。本节中的步骤将指导您创建一个非常简单的Web应用程序。然后在下一节中使用Spring Security保护它。</p>
<p>Web应用程序包括两个简单视图：主页和“Hello World”页面。主页在以下Thymeleaf模板中定义：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:sec</span>=<span class="string">"http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spring Security Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Click <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/hello&#125;"</span>&gt;</span>here<span class="tag">&lt;/<span class="name">a</span>&gt;</span> to see a greeting.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如您所见，这个简单的视图包含指向页面“/ hello”的链接。这在以下Thymeleaf模板中定义：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:sec</span>=<span class="string">"http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello world!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Web应用程序基于Spring MVC。因此，您需要配置Spring MVC并设置视图控制器以公开这些模板。这是在应用程序中配置Spring MVC的配置类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ViewControllerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/25 21:46</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurationSupport</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addViewController(<span class="string">"/"</span>).setViewName(<span class="string">"home"</span>);</span><br><span class="line">        registry.addViewController(<span class="string">"/home"</span>).setViewName(<span class="string">"home"</span>);</span><br><span class="line">        registry.addViewController(<span class="string">"/hello"</span>).setViewName(<span class="string">"hello"</span>);</span><br><span class="line">        registry.addViewController(<span class="string">"/login"</span>).setViewName(<span class="string">"login"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该<code>addViewControllers()</code>方法（覆盖同名方法<code>WebMvcConfigurer</code>）添加了四个视图控制器。其中两个视图控制器引用名称为“home”（定义于<code>home.html</code>）的视图，另一个引用名为“hello”（定义于<code>hello.html</code>）的视图。第四个视图控制器引用另一个名为“login”的视图。您将在下一部分中创建该视图。</p>
<p>此时，您可以跳转到<em>使应用程序可执行</em>并运行应用程序而无需登录任何内容。</p>
<p>通过创建基本简单Web应用程序，您可以为其添加安全性。</p>
<h2 id="设置Spring-Security"><a href="#设置Spring-Security" class="headerlink" title="设置Spring Security"></a>设置Spring Security</h2><p>使用Maven，这将是一个额外的条目添加到<code>&lt;dependencies&gt;</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这是一个安全配置，可确保只有经过身份验证的用户才能看到秘密问候语：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.factory.PasswordEncoderFactories;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> YoungDream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019/3/25 21:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/"</span>, <span class="string">"/home"</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin().loginPage(<span class="string">"/login"</span>).permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .permitAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PasswordEncoder passwordEncoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();</span><br><span class="line">        String password = passwordEncoder.encode(<span class="string">"password"</span>);</span><br><span class="line">        <span class="comment">//记住打印出来的密码并在下一步中使用</span></span><br><span class="line">        System.out.println(password);</span><br><span class="line">        <span class="comment">//这里需要注意User.withDefaultPasswordEncoder()被弃用</span></span><br><span class="line">        UserDetails userDetails = User.withUsername(<span class="string">"user"</span>).password(password).roles(<span class="string">"USER"</span>).build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InMemoryUserDetailsManager(userDetails);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本<code>WebSecurityConfig</code>类与注释<code>@EnableWebSecurity</code>，使Spring Security的网络安全支持，并提供了Spring MVC的整合。它还扩展<code>WebSecurityConfigurerAdapter</code>并覆盖了其几种方法，以设置Web安全配置的一些细节。</p>
<p>该<code>configure(HttpSecurity)</code>方法定义了哪些URL路径应该被保护，哪些不应该被保护。具体而言，“/”和“/ home”路径配置为不需要任何身份验证。必须对所有其他路径进行身份验证。</p>
<p>当用户成功登录时，它们将被重定向到先前请求的身份验证页面。有一个自定义的“/ login”页面<code>loginPage()</code>，每个人都可以查看它。</p>
<p>至于该<code>userDetailsService()</code>方法，它使用单个用户设置内存中用户存储。该用户被赋予用户名“user”，密码为“password”，角色为“USER”。</p>
<p>现在我们需要创建登录页面。“登录”视图已有一个视图控制器，因此您只需创建登录视图本身：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spring Security Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">"$&#123;param.error&#125;"</span>&gt;</span></span><br><span class="line">        Invalid username and password.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">"$&#123;param.logout&#125;"</span>&gt;</span></span><br><span class="line">        You have been logged out.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@&#123;/login&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span> User Name : <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>/&gt;</span> <span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span> Password: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>/&gt;</span> <span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Sign In"</span>/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如您所见，此Thymeleaf模板只显示一个表单，该表单捕获用户名和密码并将其发布到“/ login”。根据配置，Spring Security提供了一个拦截该请求并对用户进行身份验证的过滤器。如果用户无法进行身份验证，页面将重定向到“/ login？error”，我们的页面将显示相应的错误消息。成功注销后，我们的应用程序将发送到“/ login？logout”，我们的页面会显示相应的成功消息。</p>
<p>最后，我们需要为用户提供显示当前用户名和注销的方法。更新为<code>hello.html</code>当前用户打招呼并包含“注销”表单，如下所示</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:sec</span>=<span class="string">"http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:inline</span>=<span class="string">"text"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;'Hello '+#httpServletRequest.remoteUser+' !'&#125;"</span>&gt;</span>Hello [[$&#123;#httpServletRequest.remoteUser&#125;]]!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@&#123;/logout&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Sign Out"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们使用Spring Security的集成显示用户名<code>HttpServletRequest#getRemoteUser()</code>。“注销”表单将“POST”发送到“/logout”。成功注销后，它会将用户重定向到“/ login？logout”。</p>
<p>最后为了方便，我们将端口号设置为 <code>80</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>启动程序发现Security的HelloWorld完成了…</p>
</div></div><a class="button-hover more" href="/2019/03/25/SpringBoot整合Security/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2019/03/25/Mappr中的n-n关系/">Mybatis中的n-n关系</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2019-03-25</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/mybatis/">mybatis</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/association/">association</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/collection/">collection</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/discrimination/">discrimination</a></div></div><div class="post-content"><div class="main-content content"><h1 id="Mybatis中的级联关系"><a href="#Mybatis中的级联关系" class="headerlink" title="Mybatis中的级联关系"></a>Mybatis中的级联关系</h1><ul>
<li>association 一对一</li>
<li>collection 一对多</li>
<li>discrimination 多对多</li>
</ul>
<h2 id="asscociation"><a href="#asscociation" class="headerlink" title="asscociation"></a>asscociation</h2><p>我们模拟一个场景</p>
<p>一个学生有姓名，年龄，住址等等</p>
<p>Student类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> Student&#123;</span><br><span class="line">    <span class="keyword">private</span> Long studentNo;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而这里的住址又包括省、市、区</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> Address&#123;</span><br><span class="line">    <span class="keyword">private</span> Long addressNo;</span><br><span class="line">    <span class="keyword">private</span> String province;</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="keyword">private</span> String area;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>多表级联查询不使用<code>association</code>标签</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"Student"</span> <span class="attr">id</span>=<span class="string">"studentResult"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"studentNo"</span> <span class="attr">column</span>=<span class="string">"student_no"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"age"</span> <span class="attr">column</span>=<span class="string">"age"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 直接赋值 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"address.addressNo"</span> <span class="attr">column</span>=<span class="string">"a_no"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"address.province"</span> <span class="attr">column</span>=<span class="string">"province"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"address.city"</span> <span class="attr">column</span>=<span class="string">"city"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"address.area"</span> <span class="attr">column</span>=<span class="string">"area"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>查询语句</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findStudentWithAddress"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">resultMap</span>=<span class="string">"studentResult"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">parameterType</span>=<span class="string">"Integer"</span>&gt;</span></span><br><span class="line">	select * from t_student t1,t_address t2 where t1.a_no=t2.address_no and t1.student_no=#&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这种方式采用的是对象方式的级联操作不太好，因为每一次查询都要把所有的属性列在那里，并且修改的时候要全部修改，所以很不方便，尽量模块化</p>
</li>
<li><p>多表级联查询使用<code>association</code>标签</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"Student"</span> <span class="attr">id</span>=<span class="string">"StudentResult"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"studentNo"</span> <span class="attr">column</span>=<span class="string">"student_no"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"age"</span> <span class="attr">column</span>=<span class="string">"age"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"address"</span> <span class="attr">javaType</span>=<span class="string">"Address"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"addressNo"</span> <span class="attr">column</span>=<span class="string">"address_no"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"province"</span> <span class="attr">column</span>=<span class="string">"province"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"city"</span> <span class="attr">column</span>=<span class="string">"city"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"area"</span> <span class="attr">column</span>=<span class="string">"area"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>单表查询(N+1的问题)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"Student"</span> <span class="attr">id</span>=<span class="string">"StudentResult"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"studentNo"</span> <span class="attr">column</span>=<span class="string">"student_no"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"age"</span> <span class="attr">column</span>=<span class="string">"age"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"address"</span> <span class="attr">javaType</span>=<span class="string">"Student"</span> <span class="attr">column</span>=<span class="string">"a_no"</span> </span></span><br><span class="line"><span class="tag">                 <span class="attr">selete</span>=<span class="string">"getAddress"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 不一定在同一XML文件中 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getAddress"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultType</span>=<span class="string">"Student"</span>&gt;</span></span><br><span class="line">    select * from t_address where address_no=#&#123;_parameter&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里的<code>selete</code>=<code>getAddress</code>也可以是<code>packageName.xxxMapper.selectID</code></p>
<p>不用sql联合查询，通过<code>association</code>的延迟加载来实现:</p>
<p>​    什么是延迟加载？如果先查询订单信息即可满足业务要求就不会去查询用户，只有当用到用户信息时再查询用户信息。 对用户信息按需去查询就是延迟加载。<br>比如上面，只有当调用<code>Student</code>Bean中的<code>getAddress</code>方法获取关联的<code>address</code>数据时，才会触发数据库查询<code>t_address</code>表。</p>
<p><code>mybatis</code>默认没有开启延迟加载，需要在<code>SqlMapConfig.xml</code>中<code>setting</code>配置。<br><code>lazyLoadingEnabled</code>：全局性设置懒加载。如果设为<code>false</code>，则所有相关联的都会被初始化加载。</p>
<p>​                       允许值有：<code>true</code> | <code>false</code>。默认值：<code>false</code><br><code>aggressiveLazyLoading</code>：当设置为<code>true</code>的时候，懒加载的对象可能被任何懒属性全部加载。</p>
<p>​                       否则，每个属性都按需加载。允许值有：<code>true</code> | <code>false</code>。默认值：<code>true</code></p>
<p>事实上，大多数业务场景显示的表格，都会用到多个表字段。<br>如果采用延迟加载，会存在N+1问题。<br>什么是N+1问题呢？<br>每一个获取Order内部的User对象，都会进行一次select查询<br>那么当运行过程中执行Order的getList方法时，SQL首先进行1次查询，查询结果如果有N条订单记录，那么实际在每条订单中显示过程中还要运行一次select用户的查询，共n次。<br>SQL总共执行了n+1次。相比第二种方法的只进行一次联合查询，这种方式无疑是低效的。<br>如果业务场景的表格显示字段，并没有跨表，那么可以采用延迟加载方式</p>
</li>
</ol>
<h2 id="collection"><a href="#collection" class="headerlink" title="collection"></a>collection</h2><p>情景：一个班级有多个学生</p>
<p>班级表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`class`</span> (</span><br><span class="line">  <span class="string">`CLASS_ID`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`CLASS_NAME`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`CLASS_YEAR`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`TEACHER_ID`</span> <span class="built_in">int</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`CLASS_ID`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>
<p>学生表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`student`</span> (</span><br><span class="line">  <span class="string">`student_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`sex`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`age`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`class_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`student_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`class_id`</span> (<span class="string">`class_id`</span>),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> <span class="string">`class_id`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`class_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`class`</span> (<span class="string">`CLASS_ID`</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">3</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>
<p>班级类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassEntity</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> classid;</span><br><span class="line">	<span class="keyword">private</span> String className;</span><br><span class="line">	<span class="keyword">private</span> String classYear;</span><br><span class="line">	<span class="keyword">private</span> Teacher teacher;</span><br><span class="line">	<span class="keyword">private</span> List&lt;Student&gt; students;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>学生类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> studentId;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String sex;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>班级Mapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"包名.ClassMapper"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"classEntity"</span> <span class="attr">id</span>=<span class="string">"classResultMap"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"classid"</span> <span class="attr">column</span>=<span class="string">"CLASS_ID"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"className"</span> <span class="attr">column</span>=<span class="string">"CLASS_NAME"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"classYear"</span> <span class="attr">column</span>=<span class="string">"CLASS_YEAR"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"teacher"</span> <span class="attr">column</span>=<span class="string">"TEACHER_ID"</span> </span></span><br><span class="line"><span class="tag">                     <span class="attr">select</span>=<span class="string">"包名.TeacherMapper.getTeacher"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"students"</span> <span class="attr">column</span>=<span class="string">"class_id"</span> </span></span><br><span class="line"><span class="tag">                    <span class="attr">javaType</span>=<span class="string">"ArrayList"</span> <span class="attr">ofType</span>=<span class="string">"student"</span> </span></span><br><span class="line"><span class="tag">                    <span class="attr">select</span>=<span class="string">"包名.StudentMapper.getStudentByClassId"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getClass"</span> <span class="attr">parameterType</span>=<span class="string">"integer"</span> <span class="attr">resultMap</span>=<span class="string">"classResultMap"</span>&gt;</span></span><br><span class="line">		SELECT * FROM CLASS CT</span><br><span class="line">		WHERE CT.CLASS_ID = #&#123;id&#125;;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>学生Mapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"包名.StudentMapper"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"student"</span> <span class="attr">id</span>=<span class="string">"ResultMap"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"studentId"</span> <span class="attr">column</span>=<span class="string">"STUDENT_ID"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"NAME"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">column</span>=<span class="string">"sex"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"age"</span> <span class="attr">column</span>=<span class="string">"age"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getStudentByClassId"</span> <span class="attr">parameterType</span>=<span class="string">"integer"</span> <span class="attr">resultMap</span>=<span class="string">"ResultMap"</span>&gt;</span></span><br><span class="line">		SELECT * FROM Student CT</span><br><span class="line">		WHERE CT.CLASS_ID = #&#123;id&#125;;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="使用方法和效率的比较："><a href="#使用方法和效率的比较：" class="headerlink" title="使用方法和效率的比较："></a>使用方法和效率的比较：</h3><ol>
<li><p>全使用单表查询</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"Student"</span> <span class="attr">id</span>=<span class="string">"StudentMap"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"name"</span> <span class="attr">property</span>=<span class="string">"name"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"job"</span> <span class="attr">property</span>=<span class="string">"job"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"scores"</span> </span></span><br><span class="line"><span class="tag">                <span class="attr">ofType</span>=<span class="string">"Score"</span> </span></span><br><span class="line"><span class="tag">                <span class="attr">column</span>=<span class="string">"id"</span> </span></span><br><span class="line"><span class="tag">                <span class="attr">select</span>=<span class="string">"queryScoresBySID"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"Score"</span> <span class="attr">id</span>=<span class="string">"ScoreMap"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"num"</span> <span class="attr">property</span>=<span class="string">"num"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"subject"</span> </span></span><br><span class="line"><span class="tag">                 <span class="attr">javaType</span>=<span class="string">"Subject"</span> </span></span><br><span class="line"><span class="tag">                 <span class="attr">column</span>=<span class="string">"subject"</span> </span></span><br><span class="line"><span class="tag">                 <span class="attr">select</span>=<span class="string">"querySubjectBySubId"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryStudents"</span> <span class="attr">resultMap</span>=<span class="string">"StudentMap"</span> &gt;</span></span><br><span class="line">    SELECT id,name,job FROM t_student</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryScoresBySID"</span> <span class="attr">resultMap</span>=<span class="string">"ScoreMap"</span>&gt;</span></span><br><span class="line">    SELECT id,num,subject FROM t_score WHERE sid = #&#123;sid&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"querySubjectBySubId"</span> <span class="attr">resultType</span>=<span class="string">"Subject"</span> &gt;</span></span><br><span class="line">    SELECT id,name FROM t_subject where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用左连接进行多表查询</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"Student"</span> <span class="attr">id</span>=<span class="string">"StudentMap2"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"name"</span> <span class="attr">property</span>=<span class="string">"name"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"job"</span> <span class="attr">property</span>=<span class="string">"job"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"scores"</span> <span class="attr">javaType</span>=<span class="string">"java.util.ArrayList"</span> <span class="attr">ofType</span>=<span class="string">"Score"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"num"</span> <span class="attr">property</span>=<span class="string">"num"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"subject"</span> <span class="attr">javaType</span>=<span class="string">"Subject"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"name"</span> <span class="attr">property</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryStudents2"</span> <span class="attr">resultMap</span>=<span class="string">"StudentMap2"</span> &gt;</span></span><br><span class="line">    SELECT stu.id,stu.name name,stu.job,sco.id id,sco.num num,sub.id id,sub.name name</span><br><span class="line">    FROM t_student stu LEFT JOIN t_score sco ON stu.id = sco.sid LEFT JOIN t_subject sub ON sco.subject = sub.id</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>总结:</p>
<p>方案一：需要执行至少三次sql语句，开启三次事务才能完成本次请求。<br>方案二：只需要执行一次sql语句，开启一次事务就能完成本次请求</p>
<p>方案二比方案一的效率要高，但是在使用的时候，方案一的代码可重用性要高</p>
<p>如果追求代码重用性可以选择方案一<br>如果追求运行的性能可以选择方案二</p>
<h2 id="descrimination"><a href="#descrimination" class="headerlink" title="descrimination"></a>descrimination</h2><p>待续…</p>
</div></div><a class="button-hover more" href="/2019/03/25/Mappr中的n-n关系/#more">阅读全文</a></div><div class="recent-post-item"><a class="post-title" href="/2019/03/23/Java11尝鲜/">Java11尝鲜</a><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 更新于 2019-03-23</time><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/java/">java</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/java11/">java11</a></div></div><div class="post-content"><div class="main-content content"><h2 id="Java11新工具"><a href="#Java11新工具" class="headerlink" title="Java11新工具"></a>Java11新工具</h2><h3 id="JShell"><a href="#JShell" class="headerlink" title="JShell"></a>JShell</h3><p>​    用过Python的童鞋都知道读取-求值-打印循环(Read-Evaluation-Print Loop)很方便。他的目的在于以即时结果和反馈的形式。java9引入了JShell这个交互性工具，让Java也可以像脚本语言一样来运行，可以从控制台启动JShell，在JShell中直接输入表达式并查看其执行结果。当需要测试一个方法的运行效果或者是快速的对表达式进行求值时，JShell都十分方便。除了表达式之外，还可以创建 Java 类和方法。jshell 也有基本的代码完成功能。我们在教人们如何编写 Java 的过程中，不再需要解释 “public static void main（String [] args）” 这句废话。</p>
<h3 id="Dynamic-Class-File-Constants类文件新添的一种结构"><a href="#Dynamic-Class-File-Constants类文件新添的一种结构" class="headerlink" title="Dynamic Class-File Constants类文件新添的一种结构"></a>Dynamic Class-File Constants类文件新添的一种结构</h3><p>Java的类型文件格式将被拓展，支持一种新的常量池格式：CONSTANT_Dynamic，加载CONSTANT_Dynamic会将创建委托给bootstrap方法。</p>
<p>目的<br>其目的是降低开发新形式的可实现类文件约束带来的成本和干扰。</p>
<h3 id="局部变量类型推断（var-”关键字”）"><a href="#局部变量类型推断（var-”关键字”）" class="headerlink" title="局部变量类型推断（var ”关键字”）"></a>局部变量类型推断（var ”关键字”）</h3><p>什么是局部变量类型推断？</p>
<p>var javastack = “javastack”;<br>System.out.println(javastack);<br>大家看出来了，局部变量类型推断就是左边的类型直接使用 var 定义，而不用写具体的类型，编译器能根据右边的表达式自动推断类型，如上面的 String 。</p>
<p>var javastack = “javastack”;<br>就等于：<br>String javastack = “javastack”;</p>
<p>在声明隐式类型的lambda表达式的形参时允许使用var<br>使用var的好处是在使用lambda表达式时给参数加上注解<br>(@Deprecated var x, @Nullable var y) -&gt; x.process(y);</p>
<blockquote>
<p><strong>注意</strong>：</p>
<ol>
<li>var a; 这样不可以, 因为无法推断</li>
<li>类的属性的数据类型不可以使用var</li>
</ol>
<p><strong>有参数的lambda表达式使用</strong><br>函数式接口 :<br>    Consumer<t> : 消费型函数式接口.<br>        public void accept(T t);</t></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Consumer&lt;String&gt; consumer = t -&gt; System.out.println(t.toUpperCase());</span><br><span class="line">Consumer&lt;String&gt; consumer = (<span class="keyword">var</span> t) -&gt; System.out.println(t.toUpperCase());</span><br><span class="line"></span><br><span class="line"><span class="comment">//错误的形式: 必须要有类型, 可以加上var</span></span><br><span class="line">Consumer&lt;String&gt; consumer = (<span class="meta">@Deprecated</span> t) -&gt; System.out.println(t.toUpperCase());</span><br><span class="line"><span class="comment">//正确的形式:</span></span><br><span class="line">Consumer&lt;String&gt; consumer = (<span class="meta">@Deprecated</span> <span class="keyword">var</span> t) -&gt; System.out.println(t.toUpperCase());</span><br></pre></td></tr></table></figure>
<h2 id="Java11新API-实用"><a href="#Java11新API-实用" class="headerlink" title="Java11新API(实用)"></a>Java11新API(实用)</h2><h3 id="新的本机不可修改集合API"><a href="#新的本机不可修改集合API" class="headerlink" title="新的本机不可修改集合API"></a>新的本机不可修改集合API</h3><p>自 Java 9 开始，Jdk 里面为集合（List/ Set/ Map）都添加了 of 和 copyOf 方法，它们两个都用来创建不可变的集合，来看下它们的使用和区别。</p>
<p>示例1：</p>
<p>var list = List.of(“Java”, “Python”, “C”);<br>var copy = List.copyOf(list);<br>System.out.println(list == copy); // true<br>示例2：</p>
<p>var list = new ArrayList<string>();<br>var copy = List.copyOf(list);<br>System.out.println(list == copy); // false<br>示例1和2代码差不多，为什么一个为true,一个为false?</string></p>
<p>来看下它们的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">of</span><span class="params">(E... elements)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (elements.length) &#123; <span class="comment">// implicit null check of elements</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> ImmutableCollections.emptyList();</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ImmutableCollections.List12&lt;&gt;(elements[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ImmutableCollections.List12&lt;&gt;(elements[<span class="number">0</span>], elements[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ImmutableCollections.ListN&lt;&gt;(elements);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">copyOf</span><span class="params">(Collection&lt;? extends E&gt; coll)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ImmutableCollections.listCopy(coll);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">listCopy</span><span class="params">(Collection&lt;? extends E&gt; coll)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (coll <span class="keyword">instanceof</span> AbstractImmutableList &amp;&amp; coll.getClass() != SubList.class) &#123;</span><br><span class="line">        <span class="keyword">return</span> (List&lt;E&gt;)coll;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (List&lt;E&gt;)List.of(coll.toArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出 copyOf 方法会先判断来源集合是不是 AbstractImmutableList 类型的，如果是，就直接返回，如果不是，则调用 of 创建一个新的集合。</p>
<p>示例2因为用的 new 创建的集合，不属于不可变 AbstractImmutableList 类的子类，所以 copyOf 方法又创建了一个新的实例，所以为false.</p>
<p>注意：使用of和copyOf创建的集合为不可变集合，不能进行添加、删除、替换、排序等操作，不然会报 java.lang.UnsupportedOperationException 异常。</p>
<p>上面演示了 List 的 of 和 copyOf 方法，Set 和 Map 接口都有。</p>
<p>除了更短和更好阅读之外，这些方法也可以避免您选择特定的集合实现。在创建后，继续添加元素到这些集合会导致 “UnsupportedOperationException” 。</p>
<h3 id="Stream-加强"><a href="#Stream-加强" class="headerlink" title="Stream 加强"></a>Stream 加强</h3><p>Stream 是 Java 8 中的新特性，Java 9 开始对 Stream 增加了以下 4 个新方法。</p>
<ol>
<li><p>增加单个参数构造方法，可为null</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream.ofNullable(<span class="keyword">null</span>).count(); <span class="comment">// 0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>增加 takeWhile 和 dropWhile 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从开始计算，当 n &lt; 3 时就截止。终止后，不管之后的元素满不满足条件，都不再进行判断</span></span><br><span class="line">ream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>).takeWhile(n -&gt; n &lt; <span class="number">3</span>)</span><br><span class="line">    .collect(Collectors.toList()); <span class="comment">// [1, 2]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个和上面的相反，一旦 n &lt; 3 不成立就开始计算。</span></span><br><span class="line">Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>).dropWhile(n -&gt; n &lt; <span class="number">3</span>)</span><br><span class="line">    .collect(Collectors.toList()); <span class="comment">// [3, 2, 1]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>iterate重载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//老版本的使用方法</span></span><br><span class="line">Stream&lt;Integer&gt; iterate = Stream.iterate(<span class="number">1</span>, t -&gt; (<span class="number">2</span> * t) + <span class="number">1</span>);</span><br><span class="line">iterate.forEach(System.out::println);<span class="comment">//无限流，原因：溢出了</span></span><br><span class="line">iterate.limit(<span class="number">200</span>).forEach(System.out::println);<span class="comment">//限制条数</span></span><br><span class="line"><span class="comment">//这个 iterate 方法的新重载方法，可以让你提供一个 Predicate (判断条件)来指定什么时候结束迭代。</span></span><br><span class="line">Stream&lt;Integer&gt; newIterate = Stream.iterate(<span class="number">1</span>, t -&gt; t &gt; <span class="number">200</span>, t -&gt; (<span class="number">2</span> * t) + <span class="number">1</span>);</span><br><span class="line">newIterate.forEach(System.out::println);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="增加了一系列的字符串处理方法"><a href="#增加了一系列的字符串处理方法" class="headerlink" title="增加了一系列的字符串处理方法"></a>增加了一系列的字符串处理方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断字符串是否为空白</span></span><br><span class="line"><span class="string">" "</span>.isBlank(); <span class="comment">// true</span></span><br><span class="line"><span class="comment">// 去除首尾空白</span></span><br><span class="line"><span class="string">" Javastack "</span>.strip(); <span class="comment">// "Javastack"</span></span><br><span class="line"><span class="comment">// 去除尾部空格</span></span><br><span class="line"><span class="string">" Javastack "</span>.stripTrailing(); <span class="comment">// " Javastack"</span></span><br><span class="line"><span class="comment">// 去除首部空格</span></span><br><span class="line"><span class="string">" Javastack "</span>.stripLeading(); <span class="comment">// "Javastack "</span></span><br><span class="line"><span class="comment">// 复制字符串</span></span><br><span class="line"><span class="string">"Java"</span>.repeat(<span class="number">3</span>);<span class="comment">// "JavaJavaJava"</span></span><br><span class="line"><span class="comment">// 行数统计</span></span><br><span class="line"><span class="string">"A\nB\nC"</span>.lines().count(); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<h3 id="Optional-加强"><a href="#Optional-加强" class="headerlink" title="Optional 加强"></a>Optional 加强</h3><p>Opthonal 也增加了几个非常酷的方法，现在可以很方便的将一个 Optional 转换成一个 Stream, 或者当一个空 Optional 时给它一个替代的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Optional.of(<span class="string">"javastack"</span>).orElseThrow(); <span class="comment">// javastack</span></span><br><span class="line">Optional.of(<span class="string">"javastack"</span>).stream().count(); <span class="comment">// 1</span></span><br><span class="line">Optional.ofNullable(<span class="keyword">null</span>).or(() -&gt; Optional.of(<span class="string">"javastack"</span>)).get(); <span class="comment">// javastack</span></span><br></pre></td></tr></table></figure>
<h3 id="改进的文件API"><a href="#改进的文件API" class="headerlink" title="改进的文件API"></a>改进的文件API</h3><p>InputStream 加强</p>
<p>InputStream 终于有了一个非常有用的方法：transferTo，可以用来将数据直接传输到 OutputStream，这是在处理原始数据流时非常常见的一种用法，如下示例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> classLoader = ClassLoader.getSystemClassLoader();</span><br><span class="line"><span class="keyword">var</span> inputStream = classLoader.getResourceAsStream(<span class="string">"javastack.txt"</span>);</span><br><span class="line"><span class="keyword">var</span> javastack = File.createTempFile(<span class="string">"javastack2"</span>, <span class="string">"txt"</span>);</span><br><span class="line"><span class="keyword">try</span> (<span class="keyword">var</span> outputStream = <span class="keyword">new</span> FileOutputStream(javastack)) &#123;</span><br><span class="line">    inputStream.transferTo(outputStream);<span class="comment">//把输入流中的所有数据直接自动地复制到输出流中</span></span><br><span class="line">&#125;</span><br><span class="line">inputStream.close();</span><br></pre></td></tr></table></figure>
<h3 id="移除的一些其他内容"><a href="#移除的一些其他内容" class="headerlink" title="移除的一些其他内容"></a>移除的一些其他内容</h3><p><strong>移除项</strong>：</p>
<ol>
<li><p>移除了com.sun.awt.AWTUtilities</p>
</li>
<li><p>移除了sun.misc.Unsafe.defineClass，</p>
<p>使用java.lang.invoke.MethodHandles.Lookup.defineClass来替代</p>
</li>
<li><p>移除了Thread.destroy()以及 Thread.stop(Throwable)方法</p>
</li>
<li><p>移除了sun.nio.ch.disableSystemWideOverlappingFileLockCheck</p>
<p>sun.locale.formatasdefault属性</p>
</li>
<li><p>移除了jdk.snmp模块</p>
</li>
<li><p>移除了javafx，openjdk估计是从java10版本就移除了，oracle jdk10还尚未移除javafx，而java11版本则oracle的jdk版本也移除了javafx</p>
</li>
<li><p>移除了Java Mission Control，从JDK中移除之后，需要自己单独下载</p>
</li>
<li><p>移除了这些Root Certificates ：Baltimore Cybertrust Code Signing CA，SECOM ，AOL and Swisscom</p>
</li>
</ol>
<p><strong>废弃项</strong>：</p>
<ol>
<li>-XX+AggressiveOpts选项</li>
<li>-XX:+UnlockCommercialFeatures</li>
<li>-XX:+LogCommercialFeatures选项也不再需要</li>
</ol>
<h3 id="标准Java异步HTTP客户端"><a href="#标准Java异步HTTP客户端" class="headerlink" title="标准Java异步HTTP客户端"></a>标准Java异步HTTP客户端</h3><p>这是 Java 9 开始引入的一个处理 HTTP 请求的的 HTTP Client API，该 API 支持同步和异步，而在 Java 11 中已经为正式可用状态，你可以在 java.net 包中找到这个 API。</p>
<p>来看一下 HTTP Client 的用法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> request = HttpRequest.newBuilder()</span><br><span class="line">    .uri(URI.create(<span class="string">"https://javastack.cn"</span>))</span><br><span class="line">    .GET()</span><br><span class="line">    .build();</span><br><span class="line"><span class="keyword">var</span> client = HttpClient.newHttpClient();</span><br><span class="line"><span class="comment">// 同步</span></span><br><span class="line">HttpResponse&lt;String&gt; response = client.send(request, </span><br><span class="line">                                            HttpResponse.BodyHandlers.ofString());</span><br><span class="line">System.out.println(response.body());</span><br><span class="line"><span class="comment">// 异步</span></span><br><span class="line">client.sendAsync(request, HttpResponse.BodyHandlers.ofString())</span><br><span class="line">    .thenApply(HttpResponse::body)</span><br><span class="line">    .thenAccept(System.out::println);</span><br></pre></td></tr></table></figure>
<p>上面的 .GET() 可以省略，默认请求方式为 Get！</p>
<p>更多使用示例可以看这个 API，后续再做演示。</p>
<p>现在 Java 自带了这个 HTTP Client API，我们以后还有必要用 Apache 的 HttpClient 工具包吗？</p>
<h3 id="更简化的编译运行程序"><a href="#更简化的编译运行程序" class="headerlink" title="更简化的编译运行程序"></a>更简化的编译运行程序</h3><p>JEP 330 : 增强java启动器支持运行单个java源代码文件的程序.</p>
<blockquote>
<p><strong>注意点</strong> :</p>
<ol>
<li>执行源文件中的第一个类, 第一个类必须包含主方法</li>
<li>并且不可以使用别源文件中的自定义类, 本文件中的自定义类是可以使用的.</li>
</ol>
</blockquote>
<p>一个命令编译运行源代码</p>
<p>看下面的代码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 编译</span><br><span class="line">javac Javastack.java</span><br><span class="line">// 运行</span><br><span class="line">java Javastack</span><br></pre></td></tr></table></figure>
<p>在我们的认知里面，要运行一个 Java 源代码必须先编译，再运行，两步执行动作。而在未来的 Java 11 版本中，通过一个 java 命令就直接搞定了，如以下所示。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java Javastack.java</span><br></pre></td></tr></table></figure>
<h3 id="Unicode-10"><a href="#Unicode-10" class="headerlink" title="Unicode 10"></a>Unicode 10</h3><p>Unicode 10 增加了8518个字符, 总计达到了136690个字符. 并且增加了4个脚本.同时还有56个新的emoji表情符号.</p>
<h3 id="Remove-the-JavaEE-and-CORBA-Moudles"><a href="#Remove-the-JavaEE-and-CORBA-Moudles" class="headerlink" title="Remove the JavaEE and CORBA Moudles"></a>Remove the JavaEE and CORBA Moudles</h3><p>在java11中移除了不太使用的JavaEE模块和CORBA技术<br>CORBA来自于二十世纪九十年代，Oracle说，现在用CORBA开发现代Java应用程序已经没有意义了，维护CORBA的成本已经超过了保留它带来的好处。</p>
<p>但是删除CORBA将使得那些依赖于JDK提供部分CORBA API的CORBA实现无法运行。目前还没有第三方CORBA版本，也不确定是否会有第三方愿意接手CORBA API的维护工作。</p>
<p>在java11中将java9标记废弃的Java EE及CORBA模块移除掉，具体如下：</p>
<ol>
<li>xml相关的，<br>java.xml.ws,<br>java.xml.bind，<br>java.xml.ws，<br>java.xml.ws.annotation，<br>jdk.xml.bind，<br>jdk.xml.ws被移除，<br>只剩下java.xml，java.xml.crypto,jdk.xml.dom这几个模块；</li>
<li>java.corba，<br>java.se.ee，<br>java.activation，<br>java.transaction被移除，<br>但是java11新增一个java.transaction.xa模块</li>
</ol>
<h3 id="JEP-335-Deprecate-the-Nashorn-JavaScript-Engine"><a href="#JEP-335-Deprecate-the-Nashorn-JavaScript-Engine" class="headerlink" title="JEP : 335 : Deprecate the Nashorn JavaScript Engine"></a>JEP : 335 : Deprecate the Nashorn JavaScript Engine</h3><p>废除Nashorn javascript引擎，在后续版本准备移除掉，有需要的可以考虑使用GraalVM</p>
<h3 id="JEP-336-Deprecate-the-Pack200-Tools-and-API"><a href="#JEP-336-Deprecate-the-Pack200-Tools-and-API" class="headerlink" title="JEP : 336 : Deprecate the Pack200 Tools and API"></a>JEP : 336 : Deprecate the Pack200 Tools and API</h3><p>Java5中带了一个压缩工具:Pack200，这个工具能对普通的jar文件进行高效压缩。其实现原理是根据Java类特有的结构，合并常数池，去掉无用信息等来实现对java类的高效压缩。由于是专门对Java类进行压缩的，所以对普通文件的压缩和普通压缩软件没有什么两样，但是对于Jar  文件却能轻易达到10-40%的压缩率。这在Java应用部署中很有用，尤其对于移动Java计算，能够大大减小代码下载量。<br>Java5中还提供了这一技术的API接口，你可以将其嵌入到你的程序中使用。使用的方法很简单，下面的短短几行代码即可以实现jar的压缩和解压：</p>
<ol>
<li>压缩<br>Packer packer=Pack200.newPacker();<br>OutputStream output=new BufferedOutputStream(new  FileOutputStream(outfile));<br>packer.pack(new JarFile(jarFile), output);<br>output.close(); </li>
<li>解压<br>Unpacker unpacker=Pack200.newUnpacker();<br>output=new JarOutputStream(new FileOutputStream(jarFile));<br>unpacker.unpack(pack200File, output);<br>output.close(); </li>
</ol>
<p>Pack200的压缩和解压缩速度是比较快的，而且压缩率也是很惊人的，在我是使用  的包4.46MB压缩后成了1.44MB（0.322%），而且随着包的越大压缩率会更加明显，据说如果jar包都是class类可以压缩到1/9的大  小。其实JavaWebStart还有很多功能，例如可以按不同的jar包进行lazy下载和 单独更新，设置可以根据jar中的类变动进行class粒度的下载。</p>
<p>但是在java11中废除了pack200以及unpack200工具以及java.util.jar中的Pack200 API。因为Pack200主要是用来压缩jar包的工具，由于网络下载速度的提升以及java9引入模块化系统之后不再依赖Pack200，因此这个版本将其移除掉。</p>
<h3 id="新的Epsilon垃圾收集器"><a href="#新的Epsilon垃圾收集器" class="headerlink" title="新的Epsilon垃圾收集器"></a>新的Epsilon垃圾收集器</h3><p>A NoOp Garbage Collector<br>JDK上对这个特性的描述是: 开发一个处理内存分配但不实现任何实际内存回收机制的GC, 一旦可用堆内存用完, JVM就会退出.<br>如果有System.gc()调用, 实际上什么也不会发生(这种场景下和-XX:+DisableExplicitGC效果一样), 因为没有内存回收, 这个实现可能会警告用户尝试强制GC是徒劳.</p>
<p>用法 : <code>-XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Garbage</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> n = (<span class="keyword">int</span>)(Math.random() * <span class="number">100</span>);</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="keyword">this</span> + <span class="string">" : "</span> + n + <span class="string">" is dying"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EpsilonTest</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br><span class="line">		List&lt;Garbage&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">long</span> count = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (flag) &#123;</span><br><span class="line">			list.add(<span class="keyword">new</span> Garbage());</span><br><span class="line">			<span class="keyword">if</span> (list.size() == <span class="number">1000000</span> &amp;&amp; count == <span class="number">0</span>) &#123;</span><br><span class="line">				list.clear();</span><br><span class="line">				count++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"程序结束"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果使用选项-XX:+UseEpsilonGC, 程序很快就因为堆空间不足而退出</p>
<p>使用这个选项的原因 :<br>提供完全被动的GC实现, 具有有限的分配限制和尽可能低的延迟开销,但代价是内存占用和内存吞吐量.<br>众所周知, java实现可广泛选择高度可配置的GC实现. 各种可用的收集器最终满足不同的需求, 即使它们的可配置性使它们的功能相交. 有时更容易维护单独的实现, 而不是在现有GC实现上堆积另一个配置选项.</p>
<p>主要用途如下 :</p>
<pre><code>1. 性能测试(它可以帮助过滤掉GC引起的性能假象)
2. 内存压力测试(例如,知道测试用例 应该分配不超过1GB的内存, 我们可以使用-Xmx1g –XX:+UseEpsilonGC, 如果程序有问题, 则程序会崩溃)
3. 非常短的JOB任务(对象这种任务, 接受GC清理堆那都是浪费空间)
4. VM接口测试
5. Last-drop 延迟&amp;吞吐改进
</code></pre><h3 id="ZGC"><a href="#ZGC" class="headerlink" title="ZGC"></a>ZGC</h3><p>这应该是JDK11最为瞩目的特性, 没有之一. 但是后面带了Experimental, 说明这还不建议用到生产环境</p>
<ol>
<li>GC暂停时间不会超过10ms</li>
<li>既能处理几百兆的小堆, 也能处理几个T的大堆(OMG)</li>
<li>和G1相比, 应用吞吐能力不会下降超过15%</li>
<li>为未来的GC功能和利用colord指针以及Load barriers优化奠定基础</li>
<li>初始只支持64位系统</li>
</ol>
<p>ZGC的设计目标是：支持TB级内存容量，暂停时间低（&lt;10ms），对整个程序吞吐量的影响小于15%。 将来还可以扩展实现机制，以支持不少令人兴奋的功能，例如多层堆（即热对象置于DRAM和冷对象置于NVMe闪存），或压缩堆。</p>
<p>GC是java主要优势之一. 然而, 当GC停顿太长, 就会开始影响应用的响应时间.消除或者减少GC停顿时长, java将对更广泛的应用场景是一个更有吸引力的平台. 此外, 现代系统中可用内存不断增长,用户和程序员希望JVM能够以高效的方式充分利用这些内存, 并且无需长时间的GC暂停时间.</p>
<p>STW – stop the world</p>
<p>ZGC是一个并发, 基于region, 压缩型的垃圾收集器, 只有root扫描阶段会STW, 因此GC停顿时间不会随着堆的增长和存活对象的增长而变长.</p>
<p>ZGC : avg 1.091ms    max:1.681<br>G1   : avg 156.806  max:543.846</p>
<p>用法 : -XX:+UnlockExperimentalVMOptions –XX:+UseZGC, 因为ZGC还处于实验阶段, 所以需要通过JVM参数来解锁这个特性</p>
<h3 id="完全支持Linux容器（包括Docker）"><a href="#完全支持Linux容器（包括Docker）" class="headerlink" title="完全支持Linux容器（包括Docker）"></a>完全支持Linux容器（包括Docker）</h3><p>许多运行在Java虚拟机中的应用程序（包括Apache Spark和Kafka等数据服务以及传统的企业应用程序）都可以在Docker容器中运行。但是在Docker容器中运行Java应用程序一直存在一个问题，那就是在容器中运行JVM程序在设置内存大小和CPU使用率后，会导致应用程序的性能下降。这是因为Java应用程序没有意识到它正在容器中运行。随着Java 10的发布，这个问题总算得以解决，JVM现在可以识别由容器控制组（cgroups）设置的约束。可以在容器中使用内存和CPU约束来直接管理Java应用程序，其中包括：</p>
<p>遵守容器中设置的内存限制<br>在容器中设置可用的CPU<br>在容器中设置CPU约束<br>Java 10的这个改进在Docker for Mac、Docker for Windows以及Docker Enterprise Edition等环境均有效。</p>
<p>容器的内存限制<br>在Java 9之前，JVM无法识别容器使用标志设置的内存限制和CPU限制。而在Java 10中，内存限制会自动被识别并强制执行。</p>
<p>Java将服务器类机定义为具有2个CPU和2GB内存，以及默认堆大小为物理内存的1/4。例如，Docker企业版安装设置为2GB内存和4个CPU的环境，我们可以比较在这个Docker容器上运行Java 8和Java 10的区别。</p>
<p>首先，对于Java 8：</p>
<p>docker container run -it -m512 –entrypoint bash openjdk:latest<br>$ docker-java-home/bin/java -XX:+PrintFlagsFinal -version | grep MaxHeapSize<br>uintx MaxHeapSize                              := 524288000                          {product}<br>openjdk version “1.8.0_162”<br>1<br>2<br>3<br>4<br>最大堆大小为512M或Docker EE安装设置的2GB的1/4，而不是容器上设置的512M限制。</p>
<p>相比之下，在Java 10上运行相同的命令表明，容器中设置的内存限制与预期的128M非常接近：</p>
<p>docker container run -it -m512M –entrypoint bash openjdk:10-jdk<br>$ docker-java-home/bin/java -XX:+PrintFlagsFinal -version | grep MaxHeapSize<br>size_t MaxHeapSize                              = 134217728                          {product} {ergonomic}<br>openjdk version “10” 2018-03-20<br>1<br>2<br>3<br>4<br>设置可用的CPU<br>默认情况下，每个容器对主机CPU周期的访问是无限的。可以设置各种约束来限制给定容器对主机CPU周期的访问。Java 10可以识别这些限制：</p>
<p>docker container run -it –cpus 2 openjdk:10-jdk<br>jshell&gt; Runtime.getRuntime().availableProcessors()<br>$1 ==&gt; 2<br>1<br>2<br>3<br>分配给Docker EE的所有CPU会获得相同比例的CPU周期。这个比例可以通过修改容器的CPU share权重来调整，而CPU share权重与其它所有运行在容器中的权重相关。此比例仅适用于正在运行的CPU密集型的进程。当某个容器中的任务空闲时，其他容器可以使用余下的CPU时间。实际的CPU时间的数量取决于系统上运行的容器的数量。这些可以在Java 10中设置：</p>
<p>docker container run -it –cpu-shares 2048 openjdk:10-jdk<br>jshell&gt; Runtime.getRuntime().availableProcessors()<br>$1 ==&gt; 2<br>1<br>2<br>3<br>cpuset约束设置了哪些CPU允许在Java 10中执行。</p>
<p>docker run -it –cpuset-cpus=”1,2,3” openjdk:10-jdk<br>jshell&gt; Runtime.getRuntime().availableProcessors()<br>$1 ==&gt; 3<br>1<br>2<br>3<br>分配内存和CPU<br>使用Java 10，可以使用容器设置来估算部署应用程序所需的内存和CPU的分配。我们假设已经确定了容器中运行的每个进程的内存堆和CPU需求，并设置了JAVA_OPTS配置。例如，如果有一个跨10个节点分布的应用程序，其中五个节点每个需要512Mb的内存和1024个CPU-shares，另外五个节点每个需要256Mb和512个CPU-shares。</p>
<p>请注意，1个CPU share比例由1024表示。</p>
<p>对于内存，应用程序至少需要分配5Gb。</p>
<p>512Mb × 5 = 2.56Gb<br>256Mb × 5 = 1.28Gb<br>该应用程序需要8个CPU才能高效运行。</p>
<p>1024 x 5 = 5个CPU<br>512 x 5 = 3个CPU<br>最佳实践是建议分析应用程序以确定运行在JVM中的每个进程实际需要多少内存和分配多少CPU。但是，Java 10消除了这种猜测，可以通过调整容器大小以防止Java应用程序出现内存不足的错误以及分配足够的CPU来处理工作负载。</p>
<h3 id="支持G1上的并行完全垃圾收集"><a href="#支持G1上的并行完全垃圾收集" class="headerlink" title="支持G1上的并行完全垃圾收集"></a>支持G1上的并行完全垃圾收集</h3><p>对于 G1 GC，相比于 JDK 8，升级到 JDK 11 即可免费享受到：并行的 Full GC，快速的 CardTable 扫描，自适应的堆占用比例调整（IHOP），在并发标记阶段的类型卸载等等。这些都是针对 G1 的不断增强，其中串行 Full GC 等甚至是曾经被广泛诟病的短板，你会发现 GC 配置和调优在 JDK11 中越来越方便。</p>
<h3 id="JEP-331-Low-Overhead-Heap-Profiling免费的低耗能飞行记录仪和堆分析仪"><a href="#JEP-331-Low-Overhead-Heap-Profiling免费的低耗能飞行记录仪和堆分析仪" class="headerlink" title="JEP 331 : Low-Overhead Heap Profiling免费的低耗能飞行记录仪和堆分析仪"></a>JEP 331 : Low-Overhead Heap Profiling免费的低耗能飞行记录仪和堆分析仪</h3><p>通过JVMTI的SampledObjectAlloc回调提供了一个开销低的heap分析方式</p>
<p>提供一个低开销的, 为了排错java应用问题, 以及JVM问题的数据收集框架, 希望达到的目标如下 :</p>
<ol>
<li>提供用于生产和消费数据作为事件的API</li>
<li>提供缓存机制和二进制数据格式</li>
<li>允许事件配置和事件过滤</li>
<li>提供OS,JVM和JDK库的事件</li>
</ol>
<h3 id="JEP-329-实现RFC7539中指定的ChaCha20和Poly1305两种加密算法-代替RC4"><a href="#JEP-329-实现RFC7539中指定的ChaCha20和Poly1305两种加密算法-代替RC4" class="headerlink" title="JEP 329 : 实现RFC7539中指定的ChaCha20和Poly1305两种加密算法, 代替RC4"></a>JEP 329 : 实现RFC7539中指定的ChaCha20和Poly1305两种加密算法, 代替RC4</h3><p>实现 RFC 7539的ChaCha20 and ChaCha20-Poly1305加密算法</p>
<p>RFC7748定义的秘钥协商方案更高效, 更安全. JDK增加两个新的接口<br>XECPublicKey 和 XECPrivateKey</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">KeyPairGenerator kpg = KeyPairGenerator.getInstance(“XDH”);</span><br><span class="line">NamedParameterSpec paramSpec = <span class="keyword">new</span> NamedParameterSpec(“X25519”);</span><br><span class="line">kpg.initialize(paramSpec);</span><br><span class="line">KeyPair kp = kgp.generateKeyPair();</span><br><span class="line"></span><br><span class="line">KeyFactory kf = KeyFactory.getInstance(“XDH”);</span><br><span class="line">BigInteger u = <span class="keyword">new</span> BigInteger(“xxx”);</span><br><span class="line">XECPublicKeySpec pubSpec = <span class="keyword">new</span> XECPublicKeySpec(paramSpec, u);</span><br><span class="line">PublicKey pubKey = kf.generatePublic(pubSpec);</span><br><span class="line"></span><br><span class="line">KeyAgreement ka = KeyAgreement.getInstance(“XDH”);</span><br><span class="line">ka.init(kp.getPrivate());</span><br><span class="line">ka.doPhase(pubKey, <span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">byte</span>[] secret = ka.generateSecret();</span><br></pre></td></tr></table></figure>
<h3 id="新的默认根权限证书集"><a href="#新的默认根权限证书集" class="headerlink" title="新的默认根权限证书集"></a>新的默认根权限证书集</h3><h3 id="JEP-332最新的HTTPS安全协议TLS-1-3"><a href="#JEP-332最新的HTTPS安全协议TLS-1-3" class="headerlink" title="JEP 332最新的HTTPS安全协议TLS 1.3"></a>JEP 332最新的HTTPS安全协议TLS 1.3</h3><p>实现TLS协议1.3版本, TLS允许客户端和服务器端通过互联网以一种防止窃听, 篡改以及消息伪造的方式进行通信.</p>
<h3 id="Java-Flight-Recorder"><a href="#Java-Flight-Recorder" class="headerlink" title="Java Flight Recorder"></a>Java Flight Recorder</h3><p>Flight Recorder源自飞机的黑盒子</p>
<p>Flight Recorder以前是商业版的特性，在java11当中开源出来，它可以导出事件到文件中，之后可以用Java Mission Control来分析。可以在应用启动时配置java -XX:StartFlightRecording，或者在应用启动之后，使用jcmd来录制，比如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> jcmd &lt;pid&gt; JFR.start</span><br><span class="line"><span class="meta">$</span> jcmd &lt;pid&gt; JFR.dump filename=recording.jfr</span><br><span class="line"><span class="meta">$</span> jcmd &lt;pid&gt; JFR.stop</span><br></pre></td></tr></table></figure>
<p>是 Oracle 刚刚开源的强大特性。我们知道在生产系统进行不同角度的 Profiling，有各种工具、框架，但是能力范围、可靠性、开销等，大都差强人意，要么能力不全面，要么开销太大，甚至不可靠可能导致 Java 应用进程宕机。<br>而 JFR 是一套集成进入 JDK、JVM 内部的事件机制框架，通过良好架构和设计的框架，硬件层面的极致优化，生产环境的广泛验证，它可以做到极致的可靠和低开销。在 SPECjbb2015 等基准测试中，JFR 的性能开销最大不超过 1%，所以，工程师可以基本没有心理负担地在大规模分布式的生产系统使用，这意味着，我们既可以随时主动开启 JFR 进行特定诊断，也可以让系统长期运行 JFR，用以在复杂环境中进行“After-the-fact”分析。还需要苦恼重现随机问题吗？JFR 让问题简化了很多。<br>在保证低开销的基础上，JFR 提供的能力也令人眼前一亮，例如：我们无需 BCI 就可以进行 Object Allocation Profiling，终于不用担心 BTrace 之类把进程搞挂了。对锁竞争、阻塞、延迟，JVM GC、SafePoint 等领域，进行非常细粒度分析。甚至深入 JIT Compiler 内部，全面把握热点方法、内联、逆优化等等。JFR 提供了标准的 Java、C++ 等扩展 API，可以与各种层面的应用进行定制、集成，为复杂的企业应用栈或者复杂的分布式应用，提供 All-in-One 解决方案。而这一切都是内建在 JDK 和 JVM 内部的，并不需要额外的依赖，开箱即用。</p>
</div></div><a class="button-hover more" href="/2019/03/23/Java11尝鲜/#more">阅读全文</a></div></div><div id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-angle-right"></i></a></div></div></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fas fa-user"></i></span><span id="busuanzi_value_site_uv"></span><span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fas fa-eye"></i></span><span id="busuanzi_value_site_pv"></span><span></span></div><div class="copyright">&copy;2019 By YoungDream</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/clicklove.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>