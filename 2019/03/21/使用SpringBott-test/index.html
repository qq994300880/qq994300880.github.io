<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="使用SpringBott-test"><meta name="keywords" content="test"><meta name="author" content="YoungDream,undefined"><meta name="copyright" content="YoungDream"><title>使用SpringBott-test【YD Blog】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!--link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!--link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!--script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"0BGAOITLJQ","apiKey":"2c864a8b4720c83c2ddfc7e53d4c1711","indexName":"article_NAME","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
}</script></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Test"><span class="toc-number">1.</span> <span class="toc-text">Test</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#测试范围依赖性"><span class="toc-number">1.1.</span> <span class="toc-text">测试范围依赖性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试Spring应用程序"><span class="toc-number">1.2.</span> <span class="toc-text">测试Spring应用程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试Spring-Boot应用程序"><span class="toc-number">1.3.</span> <span class="toc-text">测试Spring Boot应用程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#检测Web应用程序类型"><span class="toc-number">1.3.1.</span> <span class="toc-text">检测Web应用程序类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检测测试配置"><span class="toc-number">1.3.2.</span> <span class="toc-text">检测测试配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#排除测试配置"><span class="toc-number">1.3.3.</span> <span class="toc-text">排除测试配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用模拟环境进行测试"><span class="toc-number">1.3.4.</span> <span class="toc-text">使用模拟环境进行测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用正在运行的服务器进行测试"><span class="toc-number">1.3.5.</span> <span class="toc-text">使用正在运行的服务器进行测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用JMX"><span class="toc-number">1.3.6.</span> <span class="toc-text">使用JMX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mocking-and-Spying-Beans"><span class="toc-number">1.3.7.</span> <span class="toc-text">Mocking and Spying Beans</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的测试"><span class="toc-number">1.3.8.</span> <span class="toc-text">自动配置的测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的JSON测试"><span class="toc-number">1.3.9.</span> <span class="toc-text">自动配置的JSON测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的Spring-MVC测试"><span class="toc-number">1.3.10.</span> <span class="toc-text">自动配置的Spring MVC测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的Spring-WebFlux测试"><span class="toc-number">1.3.11.</span> <span class="toc-text">自动配置的Spring WebFlux测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的数据JPA测试"><span class="toc-number">1.3.12.</span> <span class="toc-text">自动配置的数据JPA测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的JDBC测试"><span class="toc-number">1.3.13.</span> <span class="toc-text">自动配置的JDBC测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的数据JDBC测试"><span class="toc-number">1.3.14.</span> <span class="toc-text">自动配置的数据JDBC测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的jOOQ测试"><span class="toc-number">1.3.15.</span> <span class="toc-text">自动配置的jOOQ测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的数据MongoDB测试"><span class="toc-number">1.3.16.</span> <span class="toc-text">自动配置的数据MongoDB测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的数据Neo4j测试"><span class="toc-number">1.3.17.</span> <span class="toc-text">自动配置的数据Neo4j测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的数据Redis测试"><span class="toc-number">1.3.18.</span> <span class="toc-text">自动配置的数据Redis测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的数据LDAP测试"><span class="toc-number">1.3.19.</span> <span class="toc-text">自动配置的数据LDAP测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的REST客户端"><span class="toc-number">1.3.20.</span> <span class="toc-text">自动配置的REST客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置的Spring-REST-Docs测试"><span class="toc-number">1.3.21.</span> <span class="toc-text">自动配置的Spring REST Docs测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用Mock-MVC自动配置Spring-REST-Docs测试"><span class="toc-number">1.3.21.1.</span> <span class="toc-text">使用Mock MVC自动配置Spring REST Docs测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用REST-Assured自动配置Spring-REST-Docs测试"><span class="toc-number">1.3.21.2.</span> <span class="toc-text">使用REST Assured自动配置Spring REST Docs测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#附加自动配置和切片"><span class="toc-number">1.3.22.</span> <span class="toc-text">附加自动配置和切片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用户配置和切片"><span class="toc-number">1.3.23.</span> <span class="toc-text">用户配置和切片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用Spock测试Spring-Boot应用程序"><span class="toc-number">1.3.24.</span> <span class="toc-text">使用Spock测试Spring Boot应用程序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试应用程序"><span class="toc-number">1.4.</span> <span class="toc-text">测试应用程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigFileApplicationContextInitializer"><span class="toc-number">1.4.1.</span> <span class="toc-text">ConfigFileApplicationContextInitializer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TestPropertyValues"><span class="toc-number">1.4.2.</span> <span class="toc-text">TestPropertyValues</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OutputCapture"><span class="toc-number">1.4.3.</span> <span class="toc-text">OutputCapture</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TestRestTemplate"><span class="toc-number">1.4.4.</span> <span class="toc-text">TestRestTemplate</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">YoungDream</div><div class="author-info-description">正忙着优秀~~~</div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/qq994300880" target="_blank">GitHub<i class="icon-dot bg-color9"></i></a><a class="links-button button-hover" href="http://wpa.qq.com/msgrd?v=3&amp;uin=994300880&amp;site=qq&amp;menu=yes" target="_blank">QQ<i class="icon-dot bg-color5"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">116</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">75</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">17</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">YD Blog</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">使用SpringBott-test</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2019-03-21 | 更新于 2019-03-30</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/springboot/">springboot</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/test/">test</a></div></div></div><div class="main-content"><h1 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h1><p>Spring Boot提供了许多实用程序和注释来帮助您测试应用程序。测试支持由两个模块提供：<code>spring-boot-test</code>包含核心项，并<code>spring-boot-test-autoconfigure</code>支持测试的自动配置。</p>
<p>大多数开发人员使用<code>spring-boot-starter-test</code>启动器，它导入Spring Boot测试模块以及JUnit，AssertJ，Hamcrest和许多其他有用的库。</p>
<a id="more"></a>
<h2 id="测试范围依赖性"><a href="#测试范围依赖性" class="headerlink" title="测试范围依赖性"></a>测试范围依赖性</h2><p>在<code>spring-boot-starter-test</code>启动器中（<code>test</code> <code>scope</code>）包含以下提供的库：</p>
<ul>
<li><a href="http://junit.org/" target="_blank" rel="noopener">JUnit</a>：单元测试Java应用程序的事实上的标准。</li>
<li><a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference/testing.html#integration-testing" target="_blank" rel="noopener">Spring Test</a>和Spring Boot测试：Spring Boot应用程序的实用程序和集成测试支持。</li>
<li><a href="https://joel-costigliola.github.io/assertj/" target="_blank" rel="noopener">AssertJ</a>：一个流畅的断言库。</li>
<li><a href="http://hamcrest.org/JavaHamcrest/" target="_blank" rel="noopener">Hamcrest</a>：匹配器对象库（也称为约束或谓词）。</li>
<li><a href="http://mockito.org/" target="_blank" rel="noopener">Mockito</a>：一个Java <a href="http://mockito.org/" target="_blank" rel="noopener">模拟</a>框架。</li>
<li><a href="https://github.com/skyscreamer/JSONassert" target="_blank" rel="noopener">JSONassert</a>：JSON的断言库。</li>
<li><a href="https://github.com/jayway/JsonPath" target="_blank" rel="noopener">JsonPath</a>：JSON的XPath。</li>
</ul>
<p>我们通常发现这些常用库在编写测试时很有用。如果这些库不符合您的需求，您可以添加自己的其他测试依赖项。</p>
<h2 id="测试Spring应用程序"><a href="#测试Spring应用程序" class="headerlink" title="测试Spring应用程序"></a>测试Spring应用程序</h2><p>依赖注入的一个主要优点是它应该使您的代码更容易进行单元测试。您可以使用<code>new</code>运算符实例化对象，甚至不涉及Spring。您还可以使用<em>模拟对象</em>而不是真正的依赖项。</p>
<p>通常，您需要超越单元测试并开始集成测试（使用Spring <code>ApplicationContext</code>）。能够在不需要部署应用程序或需要连接到其他基础架构的情况下执行集成测试非常有用。</p>
<p>Spring Framework包含一个用于此类集成测试的专用测试模块。您可以直接声明依赖关系<code>org.springframework:spring-test</code>或使用<code>spring-boot-starter-test</code>“Starter”来传递它。</p>
<p>如果您之前没有使用过该<code>spring-test</code>模块，那么首先应阅读Spring Framework参考文档的 <a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference/testing.html#testing" target="_blank" rel="noopener">相关部分</a>。</p>
<h2 id="测试Spring-Boot应用程序"><a href="#测试Spring-Boot应用程序" class="headerlink" title="测试Spring Boot应用程序"></a>测试Spring Boot应用程序</h2><p>Spring Boot应用程序是一个Spring <code>ApplicationContext</code>，所以没有什么特别的东西可以用来测试它超出你通常使用的Spring语境。</p>
<blockquote>
<p>只有在您<code>SpringApplication</code>创建Spring Boot的外部属性，日志记录和其他功能时，默认情况下才会在上下文中安装它们。</p>
</blockquote>
<p>Spring Boot提供了一个<code>@SpringBootTest</code>注释，<code>spring-test</code> <code>@ContextConfiguration</code>当您需要Spring Boot功能时，它可以用作标准注释的替代方法。注释的工作原理是通过 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-detecting-config" target="_blank" rel="noopener">创建 <code>ApplicationContext</code>测试中使用的<code>SpringApplication</code></a>。除了 <code>@SpringBootTest</code>提供许多其他注释之外，还提供了用于 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-tests" target="_blank" rel="noopener">测试</a>应用程序的<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-tests" target="_blank" rel="noopener">更具体的切片</a>。</p>
<blockquote>
<p>如果您使用的是JUnit 4，请不要忘记添加<code>@RunWith(SpringRunner.class)</code>到测试中，否则注释将被忽略。如果您使用的是JUnit 5，则无需添加等效项<code>@ExtendWith(SpringExtension)</code>，<code>@SpringBootTest</code>并且其他<code>@…Test</code>注释已经使用它进行注释。</p>
</blockquote>
<p>默认情况下，<code>@SpringBootTest</code>不会启动服务器。您可以使用该<code>webEnvironment</code> 属性<code>@SpringBootTest</code>进一步优化测试的运行方式：</p>
<ul>
<li><code>MOCK</code>（默认）：加载Web <code>ApplicationContext</code>并提供模拟Web环境。使用此批注时，不会启动嵌入式服务器。如果类路径上没有Web环境，则此模式将透明地回退到创建常规非Web <code>ApplicationContext</code>。它可以与Web应用程序一起使用 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-with-mock-environment" target="_blank" rel="noopener"><code>@AutoConfigureMockMvc</code>或<code>@AutoConfigureWebTestClient</code></a>用于基于模拟的Web应用程序测试。</li>
<li><code>RANDOM_PORT</code>：加载a <code>WebServerApplicationContext</code>并提供真实的Web环境。嵌入式服务器启动并在随机端口上侦听。</li>
<li><code>DEFINED_PORT</code>：加载a <code>WebServerApplicationContext</code>并提供真实的Web环境。嵌入式服务器启动并侦听定义的端口（来自您的<code>application.properties</code>）或默认端口<code>8080</code>。</li>
<li><code>NONE</code>：<code>ApplicationContext</code>通过使用<code>SpringApplication</code>但不提供 <em>任何</em> Web环境（模拟或其他）来加载。</li>
</ul>
<blockquote>
<p>如果您的测试是<code>@Transactional</code>，则默认情况下会在每个测试方法结束时回滚事务。但是，当使用这种安排<code>RANDOM_PORT</code>或者 <code>DEFINED_PORT</code>隐式地提供真实的servlet环境时，HTTP客户端和服务器在不同的线程中运行，因此在单独的事务中运行。在这种情况下，在服务器上启动的任何事务都不会回滚。</p>
</blockquote>
<blockquote>
<p><code>@SpringBootTest`</code>webEnvironment = WebEnvironment.RANDOM_PORT`如果您的应用程序使用管理服务器的不同端口，则还将在单独的随机端口上启动管理服务器。</p>
</blockquote>
<h3 id="检测Web应用程序类型"><a href="#检测Web应用程序类型" class="headerlink" title="检测Web应用程序类型"></a>检测Web应用程序类型</h3><p>如果Spring MVC可用，则配置基于MVC的常规应用程序上下文。如果您只有Spring WebFlux，我们会检测到并配置基于WebFlux的应用程序上下文。</p>
<p>如果两者都存在，则Spring MVC优先。如果要在此方案中测试响应式Web应用程序，则必须设置该<code>spring.main.web-application-type</code> 属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(properties = <span class="string">"spring.main.web-application-type=reactive"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebFluxTests</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<h3 id="检测测试配置"><a href="#检测测试配置" class="headerlink" title="检测测试配置"></a>检测测试配置</h3><p>如果您熟悉Spring Test Framework，则可能习惯使用 <code>@ContextConfiguration(classes=…)</code>以指定<code>@Configuration</code>要加载的Spring 。或者，您可能经常<code>@Configuration</code>在测试中使用嵌套类。</p>
<p>在测试Spring Boot应用程序时，通常不需要这样做。<code>@*Test</code> 只要您没有明确定义，Spring Boot的注释就会自动搜索您的主要配置。</p>
<p>搜索算法从包含测试的包开始工作，直到找到用<code>@SpringBootApplication</code>or 注释的类<code>@SpringBootConfiguration</code>。只要您以合理的方式<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#using-boot-structuring-your-code" target="_blank" rel="noopener">构建代码</a>，通常就会找到主要配置。</p>
<blockquote>
<p>如果使用 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-tests" target="_blank" rel="noopener">测试批注来测试应用程序的更具体的片段</a>，则应避免在<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-user-configuration" target="_blank" rel="noopener">main方法的应用程序类中</a>添加特定于特定区域的配置设置 。</p>
<p><code>@SpringBootApplication</code>定义的基础组件扫描配置排除了用于确保切片按预期工作的过滤器。如果您<code>@ComponentScan</code>在已<code>@SpringBootApplication</code>注释的类上使用显式 指令，请注意将禁用这些过滤器。如果您正在使用切片，则应再次定义它们。</p>
</blockquote>
<p>如果要自定义主要配置，可以使用嵌套 <code>@TestConfiguration</code>类。与嵌套<code>@Configuration</code>类不同，嵌套类将用于代替应用程序的主要配置，<code>@TestConfiguration</code>除了应用程序的主要配置之外，还使用嵌套类。</p>
<blockquote>
<p>Spring的测试框架在测试之间缓存应用程序上下文。因此，只要您的测试共享相同的配置（无论如何发现），加载上下文的潜在耗时过程只发生一次。</p>
</blockquote>
<h3 id="排除测试配置"><a href="#排除测试配置" class="headerlink" title="排除测试配置"></a>排除测试配置</h3><p>如果您的应用程序使用组件扫描（例如，如果您使用 <code>@SpringBootApplication</code>或<code>@ComponentScan</code>），您可能会发现仅为特定测试创建的顶级配置类会意外地在任何地方被捕获。</p>
<p>正如我们<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-detecting-config" target="_blank" rel="noopener">之前所见</a>，<code>@TestConfiguration</code>可以在测试的内部类上使用来自定义主要配置。放置在顶级类时，<code>@TestConfiguration</code>表示<code>src/test/java</code>不应通过扫描拾取类。然后，您可以在需要的位置显式导入该类，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Import</span>(MyTestsConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exampleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果您直接使用<code>@ComponentScan</code>（即不通过 <code>@SpringBootApplication</code>），则需要注册<code>TypeExcludeFilter</code>。有关详细信息，请参阅 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/api/org/springframework/boot/context/TypeExcludeFilter.html" target="_blank" rel="noopener">Javadoc</a>。</p>
</blockquote>
<h3 id="使用模拟环境进行测试"><a href="#使用模拟环境进行测试" class="headerlink" title="使用模拟环境进行测试"></a>使用模拟环境进行测试</h3><p>默认情况下，<code>@SpringBootTest</code>不启动服务器。如果您要针对此模拟环境测试Web端点，则可以另外进行配置 <a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference//testing.html#spring-mvc-test-framework" target="_blank" rel="noopener"><code>MockMvc</code></a>，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBoot</span><br><span class="line">Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockMvcExampleTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exampleTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.mvc.perform(get(<span class="string">"/"</span>)).andExpect(status().isOk())</span><br><span class="line">				.andExpect(content().string(<span class="string">"Hello World"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果你想只专注于网络层，而不是开始一个完整的 <code>ApplicationContext</code>，可以考虑 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-mvc-tests" target="_blank" rel="noopener">使用 <code>@WebMvcTest</code>替代</a>。</p>
</blockquote>
<p>或者，您可以配置一个 <a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference/testing.html#webtestclient-tests" target="_blank" rel="noopener"><code>WebTestClient</code></a>，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.reactive.AutoConfigureWebTestClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.reactive.server.WebTestClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureWebTestClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockWebTestClientExampleTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> WebTestClient webClient;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exampleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.webClient.get().uri(<span class="string">"/"</span>).exchange().expectStatus().isOk()</span><br><span class="line">            .expectBody(String.class).isEqualTo(<span class="string">"Hello World"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用正在运行的服务器进行测试"><a href="#使用正在运行的服务器进行测试" class="headerlink" title="使用正在运行的服务器进行测试"></a>使用正在运行的服务器进行测试</h3><p>如果您需要启动一个完整运行的服务器，我们建议您使用随机端口。如果使用<code>@SpringBootTest(webEnvironment=WebEnvironment.RANDOM_PORT)</code>，每次测试运行时都会随机选取一个可用端口。</p>
<p>该<code>@LocalServerPort</code>注释可用于 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#howto-discover-the-http-port-at-runtime" target="_blank" rel="noopener">注射使用的实际端口</a>到您的测试。为了方便起见，测试，需要做出REST调用启动的服务器可另外<code>@Autowire</code>一个<a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference/testing.html#webtestclient-tests" target="_blank" rel="noopener"><code>WebTestClient</code></a>，它解析为正在运行的服务器相对链接，并附带了用于验证响应的专用API，如下面的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest.WebEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.reactive.server.WebTestClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(webEnvironment = WebEnvironment.RANDOM_PORT)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomPortWebTestClientExampleTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> WebTestClient webClient;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exampleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.webClient.get().uri(<span class="string">"/"</span>).exchange().expectStatus().isOk()</span><br><span class="line">				.expectBody(String.class).isEqualTo(<span class="string">"Hello World"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此类设置需要<code>spring-webflux</code>在类路径上。如果您不能或不会添加webflux，Spring Boot还提供了一个<code>TestRestTemplate</code>工具：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest.WebEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.web.client.TestRestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.assertj.core.api.Assertions.assertThat;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(webEnvironment = WebEnvironment.RANDOM_PORT)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomPortTestRestTemplateExampleTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> TestRestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exampleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String body = <span class="keyword">this</span>.restTemplate.getForObject(<span class="string">"/"</span>, String.class);</span><br><span class="line">		assertThat(body).isEqualTo(<span class="string">"Hello World"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用JMX"><a href="#使用JMX" class="headerlink" title="使用JMX"></a>使用JMX</h3><p>当测试上下文框架缓存上下文时，默认情况下禁用JMX以防止相同的组件在同一域上注册。如果此类测试需要访问 <code>MBeanServer</code>，请考虑将其标记为脏：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(properties = <span class="string">"spring.jmx.enabled=true"</span>)</span><br><span class="line"><span class="meta">@DirtiesContext</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleJmxTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MBeanServer mBeanServer;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exampleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Mocking-and-Spying-Beans"><a href="#Mocking-and-Spying-Beans" class="headerlink" title="Mocking and Spying Beans"></a>Mocking and Spying Beans</h3><p>运行测试时，有时需要在应用程序上下文中模拟某些组件。例如，您可能拥有在开发期间不可用的某些远程服务的外观。当您想要模拟在真实环境中难以触发的故障时，模拟也很有用。</p>
<p>Spring Boot包含一个<code>@MockBean</code>注释，可用于为您内部的bean定义Mockito模拟<code>ApplicationContext</code>。您可以使用批注添加新bean或替换单个现有bean定义。注释可以直接用于测试类，测试中的字段，或<code>@Configuration</code>类和字段。在字段上使用时，也会注入创建的模拟的实例。每种测试方法后，模拟豆都会自动重置。</p>
<blockquote>
<p>如果您的测试使用Spring Boot的测试注释之一（例如<code>@SpringBootTest</code>），则会自动启用此功能。要以不同的排列方式使用此功能，必须显式添加侦听器，如以下示例所示：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TestExecutionListeners</span>（MockitoTestExecutionListener.class）</span><br></pre></td></tr></table></figure>
<p>以下示例使用<code>RemoteService</code>模拟实现替换现有bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.*;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.mock.mockito.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.assertj.core.api.Assertions.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.BDDMockito.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@MockBean</span></span><br><span class="line">	<span class="keyword">private</span> RemoteService remoteService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> Reverser reverser;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exampleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// RemoteService has been injected into the reverser bean</span></span><br><span class="line">		given(<span class="keyword">this</span>.remoteService.someCall()).willReturn(<span class="string">"mock"</span>);</span><br><span class="line">		String reverse = reverser.reverseSomeCall();</span><br><span class="line">		assertThat(reverse).isEqualTo(<span class="string">"kcom"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此外，您可以使用<code>@SpyBean</code>Mockito来包装任何现有的bean <code>spy</code>。有关详细信息，请参阅<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/api/org/springframework/boot/test/mock/mockito/SpyBean.html" target="_blank" rel="noopener">Javadoc</a>。</p>
<blockquote>
<p>虽然Spring的测试框架在测试之间缓存应用程序上下文并重用共享相同配置的测试的上下文，但是使用<code>@MockBean</code>或<code>@SpyBean</code> 影响缓存键，这很可能会增加上下文的数量。</p>
</blockquote>
<blockquote>
<p>如果您使用通过名称引用参数的方法<code>@SpyBean</code>来监视bean，则<code>@Cacheable</code>必须使用编译应用程序<code>-parameters</code>。这确保了一旦bean被监视，参数名称可用于缓存基础结构。</p>
</blockquote>
<h3 id="自动配置的测试"><a href="#自动配置的测试" class="headerlink" title="自动配置的测试"></a>自动配置的测试</h3><p>Spring Boot的自动配置系统适用于应用程序，但有时对于测试来说有点太多了。通常有助于仅加载测试应用程序“切片”所需的配置部分。例如，您可能希望测试Spring MVC控制器是否正确映射URL，并且您不希望在这些测试中涉及数据库调用，或者您可能想要测试JPA实体，并且您对Web层不感兴趣测试运行。</p>
<p>该<code>spring-boot-test-autoconfigure</code>模块包括许多可用于自动配置这种“切片”的注释。它们中的每一个都以类似的方式工作，提供一个<code>@…Test</code>注释，用于加载可用于自定义自动配置设置的<code>ApplicationContext</code>一个或多个<code>@AutoConfigure…</code>注释。</p>
<blockquote>
<p>每个切片将组件扫描限制为适当的组件，并加载一组非常有限的自动配置类。如果您需要排除其中一个，大多数<code>@…Test</code>注释都会提供一个<code>excludeAutoConfiguration</code>属性。或者，您可以使用<code>@ImportAutoConfiguration#exclude</code>。</p>
</blockquote>
<blockquote>
<p><code>@Test</code>不支持在一次测试中使用多个注释包括多个“切片” 。如果您需要多个“切片”，请选择其中一个<code>@…Test</code>注释并<code>@AutoConfigure…</code>手动包含其他“切片” 的注释。</p>
</blockquote>
<blockquote>
<p>也可以使用<code>@AutoConfigure…</code>带有标准 <code>@SpringBootTest</code>注释的注释。如果您对“切片”应用程序不感兴趣但想要一些自动配置的测试bean，则可以使用此组合。</p>
</blockquote>
<h3 id="自动配置的JSON测试"><a href="#自动配置的JSON测试" class="headerlink" title="自动配置的JSON测试"></a>自动配置的JSON测试</h3><p>要测试该对象JSON序列化和反序列化是否按预期工作，您可以使用<code>@JsonTest</code>注释。<code>@JsonTest</code>自动配置可用的受支持JSON映射器，它可以是以下库之一：</p>
<ul>
<li>Jackson<code>ObjectMapper</code>，任何<code>@JsonComponent</code>beans和Jackson<code>Module</code>S</li>
<li><code>Gson</code></li>
<li><code>Jsonb</code></li>
</ul>
<blockquote>
<p><code>@JsonTest</code>可以 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置列表。</p>
</blockquote>
<p>如果需要配置自动配置的元素，可以使用 <code>@AutoConfigureJsonTesters</code>注释。</p>
<p>Spring Boot包括基于AssertJ的助手，它们与JSONAssert和JsonPath库一起使用，以检查JSON是否按预期显示。的<code>JacksonTester</code>，<code>GsonTester</code>，<code>JsonbTester</code>，和<code>BasicJsonTester</code>类可以分别用于杰克逊，GSON，Jsonb，和字符串。测试类上的任何辅助字段都可以<code>@Autowired</code>在使用时使用<code>@JsonTest</code>。以下示例显示了Jackson的测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.*;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.json.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.json.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.assertj.core.api.Assertions.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@JsonTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJsonTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JacksonTester&lt;VehicleDetails&gt; json;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSerialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		VehicleDetails details = <span class="keyword">new</span> VehicleDetails(<span class="string">"Honda"</span>, <span class="string">"Civic"</span>);</span><br><span class="line">		<span class="comment">//在与测试断言相同的包中断言.json文件</span></span><br><span class="line">		assertThat(<span class="keyword">this</span>.json.write(details)).isEqualToJson(<span class="string">"expected.json"</span>);</span><br><span class="line">		<span class="comment">//或者使用基于JSON路径的断言</span></span><br><span class="line">		assertThat(<span class="keyword">this</span>.json.write(details)).hasJsonPathStringValue(<span class="string">"@.make"</span>);</span><br><span class="line">		assertThat(<span class="keyword">this</span>.json.write(details)).extractingJsonPathStringValue(<span class="string">"@.make"</span>)</span><br><span class="line">				.isEqualTo(<span class="string">"Honda"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		String content = <span class="string">"&#123;\"make\":\"Ford\",\"model\":\"Focus\"&#125;"</span>;</span><br><span class="line">		assertThat(<span class="keyword">this</span>.json.parse(content))</span><br><span class="line">				.isEqualTo(<span class="keyword">new</span> VehicleDetails(<span class="string">"Ford"</span>, <span class="string">"Focus"</span>));</span><br><span class="line">		assertThat(<span class="keyword">this</span>.json.parseObject(content).getMake()).isEqualTo(<span class="string">"Ford"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>JSON帮助程序类也可以直接在标准单元测试中使用。为此，如果不使用，请在<code>initFields</code>方法中调用帮助程序的<code>@Before</code>方法 <code>@JsonTest</code>。</p>
</blockquote>
<h3 id="自动配置的Spring-MVC测试"><a href="#自动配置的Spring-MVC测试" class="headerlink" title="自动配置的Spring MVC测试"></a>自动配置的Spring MVC测试</h3><p>要测试Spring MVC控制器是否按预期工作，请使用<code>@WebMvcTest</code> 注释。<code>@WebMvcTest</code>自动配置Spring MVC的基础设施和限制扫描豆<code>@Controller</code>，<code>@ControllerAdvice</code>，<code>@JsonComponent</code>，<code>Converter</code>， <code>GenericConverter</code>，<code>Filter</code>，<code>WebMvcConfigurer</code>，和<code>HandlerMethodArgumentResolver</code>。<code>@Component</code>使用此批注时不会扫描常规bean。</p>
<blockquote>
<p><code>@WebMvcTest</code>可以 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置设置列表。</p>
</blockquote>
<blockquote>
<p>如果需要注册额外的组件，例如Jackson <code>Module</code>，则可以<code>@Import</code>在测试中使用其他配置类。</p>
</blockquote>
<p>通常，<code>@WebMvcTest</code>仅限于单个控制器，并与其结合使用 <code>@MockBean</code>，为所需的协作者提供模拟实现。</p>
<p><code>@WebMvcTest</code>还自动配置<code>MockMvc</code>。Mock MVC提供了一种快速测试MVC控制器的强大方法，无需启动完整的HTTP服务器。</p>
<blockquote>
<p>您还可以通过使用注释来<code>MockMvc</code>非自动配置<code>@WebMvcTest</code>（例如 <code>@SpringBootTest</code>）<code>@AutoConfigureMockMvc</code>。以下示例使用<code>MockMvc</code>：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.*;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.servlet.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.mock.mockito.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.assertj.core.api.Assertions.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.BDDMockito.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@WebMvcTest</span>(UserVehicleController.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyControllerTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@MockBean</span></span><br><span class="line">	<span class="keyword">private</span> UserVehicleService userVehicleService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testExample</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		given(<span class="keyword">this</span>.userVehicleService.getVehicleDetails(<span class="string">"sboot"</span>))</span><br><span class="line">				.willReturn(<span class="keyword">new</span> VehicleDetails(<span class="string">"Honda"</span>, <span class="string">"Civic"</span>));</span><br><span class="line">		<span class="keyword">this</span>.mvc.perform(get(<span class="string">"/sboot/vehicle"</span>).accept(MediaType.TEXT_PLAIN))</span><br><span class="line">            .andExpect(status().isOk()).andExpect(content().string(<span class="string">"Honda Civic"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果需要配置自动配置的元素（例如，应该应用servlet过滤器时），则可以使用<code>@AutoConfigureMockMvc</code> 注释中的属性。</p>
</blockquote>
<p>如果您使用HtmlUnit或Selenium，则自动配置还提供HTMLUnit <code>WebClient</code> bean和/或<code>WebDriver</code>bean。以下示例使用HtmlUnit：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.gargoylesoftware.htmlunit.*;</span><br><span class="line"><span class="keyword">import</span> org.junit.*;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.servlet.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.mock.mockito.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.assertj.core.api.Assertions.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.BDDMockito.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@WebMvcTest</span>(UserVehicleController.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHtmlUnitTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> WebClient webClient;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@MockBean</span></span><br><span class="line">	<span class="keyword">private</span> UserVehicleService userVehicleService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testExample</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		given(<span class="keyword">this</span>.userVehicleService.getVehicleDetails(<span class="string">"sboot"</span>))</span><br><span class="line">				.willReturn(<span class="keyword">new</span> VehicleDetails(<span class="string">"Honda"</span>, <span class="string">"Civic"</span>));</span><br><span class="line">		HtmlPage page = <span class="keyword">this</span>.webClient.getPage(<span class="string">"/sboot/vehicle.html"</span>);</span><br><span class="line">		assertThat(page.getBody().getTextContent()).isEqualTo(<span class="string">"Honda Civic"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>默认情况下，Spring Boot将<code>WebDriver</code>bean放在一个特殊的“范围”中，以确保驱动程序在每次测试后退出并注入新实例。如果您不想要此行为，可以添加<code>@Scope(&quot;singleton&quot;)</code>到您的<code>WebDriver</code> <code>@Bean</code> 定义中。</p>
</blockquote>
<blockquote>
<p><code>webDriver</code>Spring Boot创建的范围将替换任何用户定义的同名范围。如果您定义自己的<code>webDriver</code>范围，您可能会发现它在您使用时停止工作<code>@WebMvcTest</code>。</p>
</blockquote>
<p>如果在类路径上有Spring Security，<code>@WebMvcTest</code>则还会扫描<code>WebSecurityConfigurer</code> bean。您可以使用Spring Security的测试支持，而不是完全禁用此类测试的安全性。有关如何使用Spring Security <code>MockMvc</code>支持的更多详细信息，请参见<em>第80章“ 使用Spring Security测试</em>方法”部分。</p>
<blockquote>
<p>有时编写Spring MVC测试是不够的; Spring Boot可以帮助您<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-with-running-server" target="_blank" rel="noopener">使用实际服务器</a>运行 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-with-running-server" target="_blank" rel="noopener">完整的端到端测试</a>。</p>
</blockquote>
<h3 id="自动配置的Spring-WebFlux测试"><a href="#自动配置的Spring-WebFlux测试" class="headerlink" title="自动配置的Spring WebFlux测试"></a>自动配置的Spring WebFlux测试</h3><p>要测试<a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference//web-reactive.html" target="_blank" rel="noopener">Spring WebFlux</a>控制器是否按预期工作，您可以使用<code>@WebFluxTest</code>注释。<code>@WebFluxTest</code> 自动配置春季WebFlux基础设施和限制扫描豆<code>@Controller</code>，<code>@ControllerAdvice</code>，<code>@JsonComponent</code>，<code>Converter</code>，<code>GenericConverter</code>，和 <code>WebFluxConfigurer</code>。 使用注释<code>@Component</code>时不会扫描常规bean <code>@WebFluxTest</code>。</p>
<blockquote>
<p><code>@WebFluxTest</code>可以 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置列表。</p>
</blockquote>
<blockquote>
<p>如果需要注册额外的组件，例如Jackson <code>Module</code>，则可以<code>@Import</code>在测试中导入其他配置类。</p>
</blockquote>
<p>通常，<code>@WebFluxTest</code>仅限于单个控制器并与<code>@MockBean</code>注释结合使用， 以便为所需的协作者提供模拟实现。</p>
<p><code>@WebFluxTest</code>还有自动配置 <a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference/testing.html#webtestclient" target="_blank" rel="noopener"><code>WebTestClient</code></a>，这提供了一种快速测试WebFlux控制器的强大方法，无需启动完整的HTTP服务器。</p>
<blockquote>
<p>您还可以通过使用注释来<code>WebTestClient</code>非自动配置<code>@WebFluxTest</code>（例如 <code>@SpringBootTest</code>）<code>@AutoConfigureWebTestClient</code>。以下示例显示了使用both <code>@WebFluxTest</code>和a的类<code>WebTestClient</code>：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.reactive.WebFluxTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.reactive.server.WebTestClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@WebFluxTest</span>(UserVehicleController.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyControllerTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> WebTestClient webClient;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@MockBean</span></span><br><span class="line">	<span class="keyword">private</span> UserVehicleService userVehicleService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testExample</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		given(<span class="keyword">this</span>.userVehicleService.getVehicleDetails(<span class="string">"sboot"</span>))</span><br><span class="line">				.willReturn(<span class="keyword">new</span> VehicleDetails(<span class="string">"Honda"</span>, <span class="string">"Civic"</span>));</span><br><span class="line">		<span class="keyword">this</span>.webClient.get().uri(<span class="string">"/sboot/vehicle"</span>).accept(MediaType.TEXT_PLAIN)</span><br><span class="line">				.exchange()</span><br><span class="line">				.expectStatus().isOk()</span><br><span class="line">				.expectBody(String.class).isEqualTo(<span class="string">"Honda Civic"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此设置仅由WebFlux应用程序支持，因为<code>WebTestClient</code>在模拟的Web应用程序中使用仅适用于WebFlux。</p>
</blockquote>
<blockquote>
<p><code>@WebFluxTest</code>无法检测通过功能Web框架注册的路由。要<code>RouterFunction</code>在上下文中测试bean，请考虑<code>RouterFunction</code> 通过<code>@Import</code>或使用自己导入<code>@SpringBootTest</code>。</p>
</blockquote>
<blockquote>
<p>有时编写Spring WebFlux测试是不够的; Spring Boot可以帮助您<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-with-running-server" target="_blank" rel="noopener">使用实际服务器</a>运行 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-with-running-server" target="_blank" rel="noopener">完整的端到端测试</a>。</p>
</blockquote>
<h3 id="自动配置的数据JPA测试"><a href="#自动配置的数据JPA测试" class="headerlink" title="自动配置的数据JPA测试"></a>自动配置的数据JPA测试</h3><p>您可以使用<code>@DataJpaTest</code>注释来测试JPA应用程序。默认情况下，它配置内存中的嵌入式数据库，扫描<code>@Entity</code>类并配置Spring Data JPA存储库。常规<code>@Component</code>bean没有加载到 <code>ApplicationContext</code>。</p>
<blockquote>
<p><code>@DataJpaTest</code>可以 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置设置列表。</p>
</blockquote>
<p>默认情况下，数据JPA测试是事务性的，并在每次测试结束时回滚。有关 更多详细信息，请参阅Spring Framework Reference Documentation中的<a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference/testing.html#testcontext-tx-enabling-transactions" target="_blank" rel="noopener">相关部分</a>。如果这不是您想要的，您可以为测试或整个类禁用事务管理，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="meta">@Transactional</span>(propagation = Propagation.NOT_SUPPORTED)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleNonTransactionalTests</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据JPA测试也可以注入一个 <a href="https://github.com/spring-projects/spring-boot/tree/v2.1.3.RELEASE/spring-boot-project/spring-boot-test-autoconfigure/src/main/java/org/springframework/boot/test/autoconfigure/orm/jpa/TestEntityManager.java" target="_blank" rel="noopener"><code>TestEntityManager</code></a> bean，它提供了<code>EntityManager</code>专门为测试设计的标准JPA的替代方法。如果要<code>TestEntityManager</code>在<code>@DataJpaTest</code>实例外部 使用，也可以使用<code>@AutoConfigureTestEntityManager</code> 注释。<code>JdbcTemplate</code>如果您需要，也可以使用A. 以下示例显示<code>@DataJpaTest</code>正在使用的注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.*;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.orm.jpa.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.assertj.core.api.Assertions.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleRepositoryTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> TestEntityManager entityManager;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserRepository repository;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testExample</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.entityManager.persist(<span class="keyword">new</span> User(<span class="string">"sboot"</span>, <span class="string">"1234"</span>));</span><br><span class="line">		User user = <span class="keyword">this</span>.repository.findByUsername(<span class="string">"sboot"</span>);</span><br><span class="line">		assertThat(user.getUsername()).isEqualTo(<span class="string">"sboot"</span>);</span><br><span class="line">		assertThat(user.getVin()).isEqualTo(<span class="string">"1234"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内存中的嵌入式数据库通常可以很好地用于测试，因为它们很快并且不需要任何安装。但是，如果您更喜欢对真实数据库运行测试，则可以使用<code>@AutoConfigureTestDatabase</code>注释，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="meta">@AutoConfigureTestDatabase</span>(replace=Replace.NONE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleRepositoryTests</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自动配置的JDBC测试"><a href="#自动配置的JDBC测试" class="headerlink" title="自动配置的JDBC测试"></a>自动配置的JDBC测试</h3><p><code>@JdbcTest</code>类似于<code>@DataJpaTest</code>但仅适用于仅需要 <code>DataSource</code>并且不使用Spring Data JDBC的测试。默认情况下，它配置内存中的嵌入式数据库和<code>JdbcTemplate</code>。常规<code>@Component</code>bean没有加载到<code>ApplicationContext</code>。</p>
<blockquote>
<p><code>@JdbcTest</code>可以 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置列表。</p>
</blockquote>
<p>默认情况下，JDBC测试是事务性的，并在每次测试结束时回滚。有关更多详细信息，请参阅Spring Framework Reference Documentation中的 <a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference/testing.html#testcontext-tx-enabling-transactions" target="_blank" rel="noopener">相关部分</a>。如果这不是您想要的，您可以禁用测试或整个类的事务管理，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.jdbc.JdbcTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@JdbcTest</span></span><br><span class="line"><span class="meta">@Transactional</span>(propagation = Propagation.NOT_SUPPORTED)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleNonTransactionalTests</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果您希望测试针对真实数据库运行，则可以使用与<code>@AutoConfigureTestDatabase</code>注释相同的方式使用 注释<code>DataJpaTest</code>。（参见“ <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-jpa-test" target="_blank" rel="noopener">第46.3.12节</a> ” ,”<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-jpa-test" target="_blank" rel="noopener">自动配置的数据JPA测试</a> “）</p>
<h3 id="自动配置的数据JDBC测试"><a href="#自动配置的数据JDBC测试" class="headerlink" title="自动配置的数据JDBC测试"></a>自动配置的数据JDBC测试</h3><p><code>@DataJdbcTest</code>类似于<code>@JdbcTest</code>但是适用于使用Spring Data JDBC存储库的测试。默认情况下，它配置内存中的嵌入式数据库，a <code>JdbcTemplate</code>和Spring Data JDBC存储库。常规<code>@Component</code>bean没有加载到<code>ApplicationContext</code>。</p>
<blockquote>
<p><code>@DataJdbcTest</code>可以 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置列表。</p>
</blockquote>
<p>默认情况下，数据JDBC测试是事务性的，并在每次测试结束时回滚。有关 更多详细信息，请参阅Spring Framework Reference Documentation中的<a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference/testing.html#testcontext-tx-enabling-transactions" target="_blank" rel="noopener">相关部分</a>。如果这不是您想要的，您可以禁用测试或整个测试类的事务管理，如 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-jdbc-test" target="_blank" rel="noopener">JDBC示例中所示</a>。</p>
<p>如果您希望测试针对真实数据库运行，则可以使用与<code>@AutoConfigureTestDatabase</code>注释相同的方式使用 注释<code>DataJpaTest</code>。（参见“ <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-jpa-test" target="_blank" rel="noopener">第46.3.12节</a> ” ,”<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-jpa-test" target="_blank" rel="noopener">自动配置的数据JPA测试</a> “）</p>
<h3 id="自动配置的jOOQ测试"><a href="#自动配置的jOOQ测试" class="headerlink" title="自动配置的jOOQ测试"></a>自动配置的jOOQ测试</h3><p>您可以使用<code>@JooqTest</code>与<code>@JdbcTest</code>jOOQ相关的测试类似的方式。由于jOOQ严重依赖于与数据库模式对应的基于Java的模式，因此使用现有模式<code>DataSource</code>。如果要将其替换为内存数据库，可以使用<code>@AutoConfigureTestDatabase</code>覆盖这些设置。（有关在Spring Boot中使用jOOQ的更多信息，请参阅本章前面的“ <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-jooq" target="_blank" rel="noopener">第31.6节</a> ” <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-jooq" target="_blank" rel="noopener">，“使用jOOQ”</a>。）常规 <code>@Component</code>bean不会加载到<code>ApplicationContext</code>。</p>
<blockquote>
<p><code>@JooqTest</code>可以 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置列表。</p>
</blockquote>
<p><code>@JooqTest</code>配置一个<code>DSLContext</code>。常规<code>@Component</code>bean没有加载到 <code>ApplicationContext</code>。以下示例显示<code>@JooqTest</code>正在使用的注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.jooq.DSLContext;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.jooq.JooqTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@JooqTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleJooqTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> DSLContext dslContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JOOQ测试是事务性的，默认情况下在每次测试结束时回滚。如果这不是您想要的，您可以禁用测试或整个测试类的事务管理，如 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-jdbc-test" target="_blank" rel="noopener">JDBC示例中所示</a>。</p>
<h3 id="自动配置的数据MongoDB测试"><a href="#自动配置的数据MongoDB测试" class="headerlink" title="自动配置的数据MongoDB测试"></a>自动配置的数据MongoDB测试</h3><p>您可以使用它<code>@DataMongoTest</code>来测试MongoDB应用程序。默认情况下，它配置内存中嵌入的MongoDB（如果可用），配置<code>MongoTemplate</code>，扫描 <code>@Document</code>类以及配置Spring Data MongoDB存储库。常规 <code>@Component</code>bean没有加载到<code>ApplicationContext</code>。（有关将MongoDB与Spring Boot一起使用的更多信息，请参阅本章前面的“ <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-mongodb" target="_blank" rel="noopener">第32.2节”，“MongoDB”</a>。）</p>
<blockquote>
<p><code>@DataMongoTest</code>可以 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置设置列表。</p>
</blockquote>
<p>以下类显示<code>@DataMongoTest</code>正在使用的注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.data.mongo.DataMongoTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@DataMongoTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleDataMongoTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内存中嵌入式MongoDB通常适用于测试，因为它速度快，不需要任何开发人员安装。但是，如果您更喜欢对真正的MongoDB服务器运行测试，则应排除嵌入式MongoDB自动配置，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"> <span class="keyword">import</span> org.springframework.boot.autoconfigure.mongo.embedded.EmbeddedMongoAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.data.mongo.DataMongoTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@DataMongoTest</span>(excludeAutoConfiguration = EmbeddedMongoAutoConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleDataMongoNonEmbeddedTests</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自动配置的数据Neo4j测试"><a href="#自动配置的数据Neo4j测试" class="headerlink" title="自动配置的数据Neo4j测试"></a>自动配置的数据Neo4j测试</h3><p>您可以使用它<code>@DataNeo4jTest</code>来测试Neo4j应用程序。默认情况下，它使用内存中嵌入式Neo4j（如果嵌入式驱动程序可用），扫描<code>@NodeEntity</code>类并配置Spring Data Neo4j存储库。常规<code>@Component</code>bean没有加载到<code>ApplicationContext</code>。（有关使用带有Spring Boot的Neo4J的更多信息，请参阅本章前面的“ <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-neo4j" target="_blank" rel="noopener">第32.3节”，“Neo4j”</a>。）</p>
<blockquote>
<p><code>@DataNeo4jTest</code>可以 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置设置列表。</p>
</blockquote>
<p>以下示例显示了在Spring Boot中使用Neo4J测试的典型设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.data.neo4j.DataNeo4jTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@DataNeo</span>4jTest</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleDataNeo4jTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> YourRepository repository;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下，Data Neo4j测试是事务性的，并在每次测试结束时回滚。有关更多详细信息，请参阅Spring Framework Reference Documentation中的<a href="https://docs.spring.io/spring/docs/5.1.5.RELEASE/spring-framework-reference/testing.html#testcontext-tx-enabling-transactions" target="_blank" rel="noopener">相关部分</a>。如果这不是您想要的，您可以禁用测试或整个类的事务管理，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.data.neo4j.DataNeo4jTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@DataNeo</span>4jTest</span><br><span class="line"><span class="meta">@Transactional</span>(propagation = Propagation.NOT_SUPPORTED)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleNonTransactionalTests</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自动配置的数据Redis测试"><a href="#自动配置的数据Redis测试" class="headerlink" title="自动配置的数据Redis测试"></a>自动配置的数据Redis测试</h3><p>您可以使用它<code>@DataRedisTest</code>来测试Redis应用程序。默认情况下，它会扫描 <code>@RedisHash</code>类并配置Spring Data Redis存储库。常规<code>@Component</code> bean没有加载到<code>ApplicationContext</code>。（有关使用带有Spring Boot的Redis的更多信息，请参阅本章前面的“ <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-redis" target="_blank" rel="noopener">第32.1节”，“Redis”</a>。）</p>
<blockquote>
<p><code>@DataRedisTest</code>可以 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置设置列表。</p>
</blockquote>
<p>以下示例显示<code>@DataRedisTest</code>正在使用的注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.data.redis.DataRedisTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@DataRedisTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleDataRedisTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> YourRepository repository;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自动配置的数据LDAP测试"><a href="#自动配置的数据LDAP测试" class="headerlink" title="自动配置的数据LDAP测试"></a>自动配置的数据LDAP测试</h3><p>您可以使用它<code>@DataLdapTest</code>来测试LDAP应用程序。默认情况下，它配置内存中嵌入式LDAP（如果可用），配置<code>LdapTemplate</code>，扫描<code>@Entry</code> 类以及配置Spring Data LDAP存储库。常规<code>@Component</code>bean没有加载到<code>ApplicationContext</code>。（有关在Spring Boot中使用LDAP的更多信息，请参阅本章前面的“ <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-ldap" target="_blank" rel="noopener">第32.9节”，“LDAP”</a>。）</p>
<blockquote>
<p><code>@DataLdapTest</code>可以 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置设置列表。</p>
</blockquote>
<p>以下示例显示<code>@DataLdapTest</code>正在使用的注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.data.ldap.DataLdapTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ldap.core.LdapTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@DataLdapTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleDataLdapTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> LdapTemplate ldapTemplate;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内存中嵌入式LDAP通常适用于测试，因为它速度快，不需要任何开发人员安装。但是，如果您更喜欢针对真实LDAP服务器运行测试，则应排除嵌入式LDAP自动配置，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.ldap.embedded.EmbeddedLdapAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.data.ldap.DataLdapTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@DataLdapTest</span>(excludeAutoConfiguration = EmbeddedLdapAutoConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleDataLdapNonEmbeddedTests</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自动配置的REST客户端"><a href="#自动配置的REST客户端" class="headerlink" title="自动配置的REST客户端"></a>自动配置的REST客户端</h3><p>您可以使用<code>@RestClientTest</code>注释来测试REST客户端。默认情况下，它会自动配置Jackson，GSON和Jsonb支持，配置<code>RestTemplateBuilder</code>并添加支持<code>MockRestServiceServer</code>。常规<code>@Component</code>bean没有加载到<code>ApplicationContext</code>。</p>
<blockquote>
<p><code>@RestClientTest</code>可以<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#test-auto-configuration" target="_blank" rel="noopener">在附录中找到</a>启用的自动配置设置列表。</p>
</blockquote>
<p>应使用<code>value</code>or <code>components</code>属性指定要测试的特定bean <code>@RestClientTest</code>，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@RestClientTest</span>(RemoteVehicleDetailsService.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleRestClientTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> RemoteVehicleDetailsService service;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MockRestServiceServer server;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getVehicleDetailsWhenResultIsSuccessShouldReturnDetails</span><span class="params">()</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.server.expect(requestTo(<span class="string">"/greet/details"</span>))</span><br><span class="line">				.andRespond(withSuccess(<span class="string">"hello"</span>, MediaType.TEXT_PLAIN));</span><br><span class="line">		String greeting = <span class="keyword">this</span>.service.callRestService();</span><br><span class="line">		assertThat(greeting).isEqualTo(<span class="string">"hello"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自动配置的Spring-REST-Docs测试"><a href="#自动配置的Spring-REST-Docs测试" class="headerlink" title="自动配置的Spring REST Docs测试"></a>自动配置的Spring REST Docs测试</h3><p>您可以使用<code>@AutoConfigureRestDocs</code>注释在Mock MVC，REST Assured或WebTestClient的测试中使用<a href="https://projects.spring.io/spring-restdocs/" target="_blank" rel="noopener">Spring REST Docs</a>。它消除了对Spring REST Docs中JUnit规则的需求。</p>
<p><code>@AutoConfigureRestDocs</code>可用于覆盖默认输出目录（<code>target/generated-snippets</code>如果您使用的是Maven，或者<code>build/generated-snippets</code>如果您使用的是Gradle）。它还可用于配置出现在任何已记录的URI中的主机，方案和端口。</p>
<h4 id="使用Mock-MVC自动配置Spring-REST-Docs测试"><a href="#使用Mock-MVC自动配置Spring-REST-Docs测试" class="headerlink" title="使用Mock MVC自动配置Spring REST Docs测试"></a>使用Mock MVC自动配置Spring REST Docs测试</h4><p><code>@AutoConfigureRestDocs</code>自定义<code>MockMvc</code>bean以使用Spring REST Docs。您可以<code>@Autowired</code>像在通常使用Mock MVC和Spring REST Docs时那样在测试中使用它来注入它，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.restdocs.mockmvc.MockMvcRestDocumentation.document;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@WebMvcTest</span>(UserController.class)</span><br><span class="line"><span class="meta">@AutoConfigureRestDocs</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDocumentationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listUsers</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.mvc.perform(get(<span class="string">"/users"</span>).accept(MediaType.TEXT_PLAIN))</span><br><span class="line">				.andExpect(status().isOk())</span><br><span class="line">				.andDo(document(<span class="string">"list-users"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果您需要对Spring REST Docs配置的更多控制而不是属性提供，则<code>@AutoConfigureRestDocs</code>可以使用 <code>RestDocsMockMvcConfigurationCustomizer</code>bean，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TestConfiguration</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizationConfiguration</span></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">RestDocsMockMvcConfigurationCustomizer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(MockMvcRestDocumentationConfigurer configurer)</span> </span>&#123;</span><br><span class="line">		configurer.snippets().withTemplateFormat(TemplateFormats.markdown());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果要对参数化输出目录使用Spring REST Docs支持，可以创建<code>RestDocumentationResultHandler</code>bean。自动配置<code>alwaysDo</code>使用此结果处理程序调用 ，从而使每个<code>MockMvc</code>调用自动生成默认代码段。以下示例显示了 <code>RestDocumentationResultHandler</code>正在定义的内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TestConfiguration</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultHandlerConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RestDocumentationResultHandler <span class="title">restDocumentation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> MockMvcRestDocumentation.document(<span class="string">"&#123;method-name&#125;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用REST-Assured自动配置Spring-REST-Docs测试"><a href="#使用REST-Assured自动配置Spring-REST-Docs测试" class="headerlink" title="使用REST Assured自动配置Spring REST Docs测试"></a>使用REST Assured自动配置Spring REST Docs测试</h4><p><code>@AutoConfigureRestDocs</code>制作一个<code>RequestSpecification</code>预先配置为使用Spring REST Docs 的bean，可用于您的测试。您可以<code>@Autowired</code>像在通常使用REST Assured和Spring REST Doc时那样在测试中使用它来注入它，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.restassured.specification.RequestSpecification;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.restdocs.AutoConfigureRestDocs;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest.WebEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.server.LocalServerPort;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> io.restassured.RestAssured.given;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.hamcrest.CoreMatchers.is;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.restdocs.restassured3.RestAssuredRestDocumentation.document;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(webEnvironment = WebEnvironment.RANDOM_PORT)</span><br><span class="line"><span class="meta">@AutoConfigureRestDocs</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDocumentationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@LocalServerPort</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> RequestSpecification documentationSpec;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listUsers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		given(<span class="keyword">this</span>.documentationSpec).filter(document(<span class="string">"list-users"</span>)).when()</span><br><span class="line">				.port(<span class="keyword">this</span>.port).get(<span class="string">"/"</span>).then().assertThat().statusCode(is(<span class="number">200</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果您需要对Spring REST Docs配置的更多控制而不是属性提供<code>@AutoConfigureRestDocs</code>，<code>RestDocsRestAssuredConfigurationCustomizer</code> 则可以使用bean，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TestConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizationConfiguration</span></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">RestDocsRestAssuredConfigurationCustomizer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(RestAssuredRestDocumentationConfigurer configurer)</span> </span>&#123;</span><br><span class="line">		configurer.snippets().withTemplateFormat(TemplateFormats.markdown());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="附加自动配置和切片"><a href="#附加自动配置和切片" class="headerlink" title="附加自动配置和切片"></a>附加自动配置和切片</h3><p>每个切片提供一个或多个<code>@AutoConfigure…</code>注释，即定义应作为切片的一部分包括的自动配置。可以通过创建自定义<code>@AutoConfigure…</code>注释或仅通过添加<code>@ImportAutoConfiguration</code>到测试来添加其他自动配置，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@JdbcTest</span></span><br><span class="line"><span class="meta">@ImportAutoConfiguration</span>(IntegrationAutoConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleJdbcTests</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>确保不使用常规<code>@Import</code>注释来导入自动配置，因为Spring Boot会以特定方式处理它们。</p>
</blockquote>
<h3 id="用户配置和切片"><a href="#用户配置和切片" class="headerlink" title="用户配置和切片"></a>用户配置和切片</h3><p>如果以合理的方式<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#using-boot-structuring-your-code" target="_blank" rel="noopener">构造代码</a>，<code>@SpringBootApplication</code>则<a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-detecting-config" target="_blank" rel="noopener">默认情况下</a>会将您的 类 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-detecting-config" target="_blank" rel="noopener">用作</a>测试的配置。</p>
<p>然后，重要的是不要使用特定于其功能的特定区域的配置设置来丢弃应用程序的主类。</p>
<p>假设您正在使用Spring Batch并依赖于它的自动配置。您可以<code>@SpringBootApplication</code>按如下方式定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableBatchProcessing</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleApplication</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>因为此类是测试的源配置，所以任何切片测试实际上都会尝试启动Spring Batch，这绝对不是您想要做的。建议的方法是将特定于区域的配置移动到与<code>@Configuration</code>应用程序相同级别的单独类中，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableBatchProcessing</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchConfiguration</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>根据应用程序的复杂程度，您可能只有一个 <code>@Configuration</code>类用于自定义，或者每个域区域有一个类。后一种方法允许您在必要时使用<code>@Import</code>注释在其中一个测试中启用它。</p>
</blockquote>
<p>混淆的另一个原因是类路径扫描。假设您以合理的方式构建代码，则需要扫描其他包。您的应用程序可能类似于以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(&#123; <span class="string">"com.example.app"</span>, <span class="string">"org.acme.another"</span> &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleApplication</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>这样做会有效地覆盖默认组件扫描指令，并且无论您选择哪个切片，都会扫描这两个包。例如， <code>@DataJpaTest</code>似乎突然扫描了应用程序的组件和用户配置。同样，将自定义指令移动到单独的类是解决此问题的好方法。</p>
<blockquote>
<p>如果这不是您的选项，您可以<code>@SpringBootConfiguration</code> 在测试的层次结构中创建一个位置，以便使用它。或者，您可以为测试指定源，这会禁用查找默认源的行为。</p>
</blockquote>
<h3 id="使用Spock测试Spring-Boot应用程序"><a href="#使用Spock测试Spring-Boot应用程序" class="headerlink" title="使用Spock测试Spring Boot应用程序"></a>使用Spock测试Spring Boot应用程序</h3><p>如果您希望使用Spock来测试Spring Boot应用程序，您应该将Spock <code>spock-spring</code>模块的依赖项添加到应用程序的构建中。<code>spock-spring</code>将Spring的测试框架集成到Spock中。建议您使用Spock 1.2或更高版本从Spock的Spring Framework和Spring Boot集成的许多改进中受益。有关更多详细信息，请参阅<a href="http://spockframework.org/spock/docs/1.2/modules.html#_spring_module" target="_blank" rel="noopener">Spock Spring模块的文档</a>。</p>
<h2 id="测试应用程序"><a href="#测试应用程序" class="headerlink" title="测试应用程序"></a>测试应用程序</h2><p>在测试应用程序时通常有用的一些测试实用程序类是作为其一部分打包的<code>spring-boot</code>。</p>
<h3 id="ConfigFileApplicationContextInitializer"><a href="#ConfigFileApplicationContextInitializer" class="headerlink" title="ConfigFileApplicationContextInitializer"></a>ConfigFileApplicationContextInitializer</h3><p><code>ConfigFileApplicationContextInitializer</code>是一个<code>ApplicationContextInitializer</code>可以应用于测试以加载Spring Boot <code>application.properties</code>文件的。当您不需要提供的全部功能时，可以使用它<code>@SpringBootTest</code>，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ContextConfiguration</span>(classes = Config.class,</span><br><span class="line">	initializers = ConfigFileApplicationContextInitializer.class)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>ConfigFileApplicationContextInitializer</code>单独使用不提供<code>@Value(&quot;${…}&quot;)</code>注射支持 。它唯一的工作是确保将<code>application.properties</code>文件加载到Spring中<code>Environment</code>。要获得<code>@Value</code>支持，您需要另外配置<code>PropertySourcesPlaceholderConfigurer</code>或使用<code>@SpringBootTest</code>，为您自动配置一个。</p>
</blockquote>
<h3 id="TestPropertyValues"><a href="#TestPropertyValues" class="headerlink" title="TestPropertyValues"></a>TestPropertyValues</h3><p><code>TestPropertyValues</code>让您快速添加属性 <code>ConfigurableEnvironment</code>或<code>ConfigurableApplicationContext</code>。您可以使用<code>key=value</code>字符串调用它 ，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TestPropertyValues.of(<span class="string">"org=Spring"</span>, <span class="string">"name=Boot"</span>).applyTo(env);</span><br></pre></td></tr></table></figure>
<h3 id="OutputCapture"><a href="#OutputCapture" class="headerlink" title="OutputCapture"></a>OutputCapture</h3><p><code>OutputCapture</code>是一个<code>Rule</code>可以用来捕获<code>System.out</code>和 <code>System.err</code>输出的JUnit 。您可以将捕获声明为a <code>@Rule</code>然后<code>toString()</code> 用于断言，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Rule;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.rule.OutputCapture;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.hamcrest.Matchers.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Rule</span></span><br><span class="line">	<span class="keyword">public</span> OutputCapture capture = <span class="keyword">new</span> OutputCapture();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testName</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Hello World!"</span>);</span><br><span class="line">		assertThat(capture.toString(), containsString(<span class="string">"World"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TestRestTemplate"><a href="#TestRestTemplate" class="headerlink" title="TestRestTemplate"></a>TestRestTemplate</h3><blockquote>
<p>Spring Framework 5.0提供了一个<code>WebTestClient</code>适用于 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-webflux-tests" target="_blank" rel="noopener">WebFlux集成测试</a>以及 <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-with-running-server" target="_blank" rel="noopener">WebFlux和MVC端到端测试的新功能</a>。它提供了一个流畅的断言API，不像<code>TestRestTemplate</code>。</p>
</blockquote>
<p><code>TestRestTemplate</code>是Spring的便捷替代品，<code>RestTemplate</code>在集成测试中很有用。您可以获得一个vanilla模板或一个发送基本HTTP身份验证（使用用户名和密码）的模板。在任何一种情况下，模板都以一种测试友好的方式运行，不会在服务器端错误上抛出异常。建议（但不是强制性的）使用Apache HTTP Client（版本4.3.2或更高版本）。如果您在类路径中有这个，则<code>TestRestTemplate</code>通过适当地配置客户端来响应。如果您确实使用Apache的HTTP客户端，则启用一些其他测试友好功能：</p>
<ul>
<li>不遵循重定向（因此您可以断言响应位置）。</li>
<li>Cookie被忽略（因此模板是无状态的）。</li>
</ul>
<p><code>TestRestTemplate</code> 可以直接在集成测试中实例化，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> TestRestTemplate template = <span class="keyword">new</span> TestRestTemplate();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRequest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		HttpHeaders headers = <span class="keyword">this</span>.template</span><br><span class="line">            .getForEntity(<span class="string">"http://myhost.example.com/example"</span>, String.class)</span><br><span class="line">            .getHeaders();</span><br><span class="line">		assertThat(headers.getLocation()).hasHost(<span class="string">"other.example.com"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者，如果您使用或使用<code>@SpringBootTest</code>注释 ，则可以注入完全配置并开始使用它。如有必要，可以通过bean 应用其他自定义。任何未指定主机和端口的URL都会自动连接到嵌入式服务器，<code>WebEnvironment.RANDOM_PORT</code> <code>WebEnvironment.DEFINED_PORT</code> <code>TestRestTemplate</code> <code>RestTemplateBuilder</code>如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(webEnvironment = WebEnvironment.RANDOM_PORT)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleWebClientTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> TestRestTemplate template;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		HttpHeaders headers = <span class="keyword">this</span>.template.getForEntity(<span class="string">"/example"</span>, String.class)</span><br><span class="line">				.getHeaders();</span><br><span class="line">		assertThat(headers.getLocation()).hasHost(<span class="string">"other.example.com"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@TestConfiguration</span></span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> RestTemplateBuilder <span class="title">restTemplateBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> RestTemplateBuilder().setConnectTimeout(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">					.setReadTimeout(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">YoungDream</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="http://qq994300880.github.io/2019/03/21/使用SpringBott-test/">http://qq994300880.github.io/2019/03/21/使用SpringBott-test/</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://qq994300880.github.io">YD Blog</a>！</span></div></div></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2019/03/21/使用SpringBoot-WebSockets/"><i class="fas fa-angle-left">&nbsp;</i><span>使用SpringBoot-WebSockets</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2019/03/21/使用SpringBoot-JMX的监测和管理/"><span>使用SpringBoot-JMX的监测和管理</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script><div id="gitalk-container"></div><script src="/js/gitalk.js"></script></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2019 By YoungDream</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/clicklove.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>